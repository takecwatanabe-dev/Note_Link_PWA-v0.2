<script>
/* Note Link UI runtime
   version: v0.6.9-fix10 / No.13
   - 折り畳み(上方向)の安定化
   - 各ツールごとに設定UIを切替表示
   - 上部バー操作の配線
*/

(() => {
  const $  = (sel,root=document)=>root.querySelector(sel);
  const $$ = (sel,root=document)=>[...root.querySelectorAll(sel)];

  // 基本ノード
  const sidebar = $('#sidebar');
  const toggle  = $('#toggle');
  const tools = {
    pen:    $('#tool-pen'),
    marker: $('#tool-marker'),
    eraser: $('#tool-eraser'),
    text:   $('#tool-text'),
    gear:   $('#tool-gear') // 歯車
  };

  // 共通設定パネル（中身はタブ切替）
  const panel = $('#panel');
  const panelClose = $('#panel .close');
  const panelTabs = {
    pen:    $('#panel-pen'),
    marker: $('#panel-marker'),
    eraser: $('#panel-eraser'),
    text:   $('#panel-text')
  };

  // ========== 折り畳み ==========
  function setCollapsed(state){
    if(state){
      sidebar.setAttribute('data-collapsed','1');  // 上へ隠す
      // トグルは常に見える（sidebarの一番上にあるため）
      toggle.setAttribute('data-dir','down');      // ▽
      toggle.innerHTML = arrowSVG('down');
    }else{
      sidebar.removeAttribute('data-collapsed');
      toggle.setAttribute('data-dir','up');        // △
      toggle.innerHTML = arrowSVG('up');
    }
  }
  function arrowSVG(dir){
    // 中抜き三角（塗りなし、線のみ）
    const d = {
      up:   'M3 12 L11 4 L19 12',
      down: 'M3 8  L11 16 L19 8'
    }[dir];
    return `<svg viewBox="0 0 22 22"><path d="${d}" stroke="currentColor" stroke-width="2.6" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
  }
  toggle.addEventListener('click', ()=>{
    const c = sidebar.getAttribute('data-collapsed') === '1';
    setCollapsed(!c);
  });
  // 初期は開いた状態・上向き△
  setCollapsed(false);

  // ========== ツール選択 & パネル切替 ==========
  let active = 'pen';
  function setActive(next){
    // ボタンの見た目
    Object.entries(tools).forEach(([key,el])=>{
      if(!el) return;
      el.classList.toggle('active', key===next);
    });
    active = next;

    // 設定パネル（ギア以外で開く／ギアはトグル）
    if(next === 'gear'){
      panel.classList.toggle('show');
    }else{
      showPanel(next);
    }
  }
  function showPanel(kind){
    panel.classList.add('show');
    Object.entries(panelTabs).forEach(([k,el])=>{
      if(!el) return;
      el.style.display = (k===kind)? 'block':'none';
    });
  }
  Object.entries(tools).forEach(([key,el])=>{
    if(!el) return;
    el.addEventListener('click', ()=> setActive(key));
  });
  panelClose?.addEventListener('click', ()=> panel.classList.remove('show'));

  // ========== 上部バー（印刷/PNG/共有） ==========
  $('#btn-print')?.addEventListener('click', ()=> window.print());
  $('#btn-png')?.addEventListener('click', ()=>{
    // ここは既存のキャンバス出力関数に合わせて差し替え
    // 例: exportPNG()
    if(typeof exportPNG === 'function'){ exportPNG(); }
    else alert('PNG出力の関数が見つかりません。');
  });
  $('#btn-share')?.addEventListener('click', async ()=>{
    try{
      await navigator.share?.({ title:'Note Link', url: location.href }) ??
        navigator.clipboard.writeText(location.href);
      alert('URLを共有/コピーしました。');
    }catch(e){ console.warn(e); }
  });

  // ========== 初期ツール ==========
  setActive('pen');
})();
</script>
