<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Note Link v0.6.7 / No.11 (single)</title>
<style>
:root{
  --bg:#0e1420; --panel:#101826; --ink:#e7edf5; --muted:#2a3444; --accent:#3bd388;
  --sbw:64px; /* sidebar width (expanded) */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink); background:var(--bg);
  font:14px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;
  overflow:hidden;
}

/* Header */
header{
  height:48px; display:flex; align-items:center; gap:10px;
  padding:0 10px; background:var(--panel); border-bottom:1px solid var(--muted);
}
.brand{font-weight:700}
.pill{border:1px solid var(--muted); border-radius:10px; padding:2px 8px; font-size:12px; opacity:.9}
.actions{margin-left:auto; display:flex; gap:6px; align-items:center}
.actions button{height:30px; padding:0 10px; border-radius:8px; background:#0f1729; color:var(--ink); border:1px solid var(--muted); cursor:pointer}
.actions button:hover{border-color:var(--accent)}

/* Layout */
.wrap{
  height:calc(100% - 48px);
  display:grid;
  grid-template-columns: var(--sbw) 1fr;
}

/* Sidebar */
.sidebar{
  background:var(--panel); border-right:1px solid var(--muted);
  padding:8px 6px; display:flex; flex-direction:column; gap:8px; overflow:auto;
}
.sidebar.collapsed{ --sbw:44px; }
.tool{
  width:40px; height:40px; border-radius:12px; display:grid; place-items:center;
  background:#0f1729; border:1px solid var(--muted); cursor:pointer; position:relative;
}
.tool:hover{border-color:var(--accent)}
.tool.active{ box-shadow:0 0 0 2px #1b2, 0 0 12px #1b2; border-color:#1b2; }
.tool .dot{position:absolute; inset:auto 6px 6px auto; width:6px; height:6px; border-radius:50%; background:var(--accent); display:none}
.tool.active .dot{display:block}
.label{font-size:10px; text-align:center; opacity:.8}

/* Gear (one) */
.gearHint{border:1px dashed var(--muted); border-radius:8px; padding:6px; font-size:12px; opacity:.75}

/* Stage & Canvas */
.stage{position:relative}
canvas{display:block; width:100%; height:100%}

/* Flyout */
.flyout{
  position:absolute; top:72px; left:76px; min-width:280px; max-width:90vw;
  background:rgba(16,24,38,.98); border:1px solid var(--muted);
  border-radius:12px; padding:10px; box-shadow:0 10px 32px rgba(0,0,0,.45);
  backdrop-filter:blur(6px);
}
.flyout.hidden{display:none}
.flyHead{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
.tabbar{display:flex; gap:6px; flex-wrap:wrap; margin-bottom:6px}
.tabbar button{height:28px; padding:0 8px; border-radius:8px; background:#0f1729; color:var(--ink); border:1px solid var(--muted); cursor:pointer}
.tabbar button.active{border-color:var(--accent); background:#102432}
.row{display:flex; align-items:center; gap:8px; margin:8px 0; flex-wrap:wrap}
.row input[type="range"]{width:160px}
.closeX{height:28px; width:28px; border-radius:8px; border:1px solid var(--muted); background:#0f1729; color:var(--ink); cursor:pointer}

/* Collapsed tweak: flyout x position */
.sidebar.collapsed ~ .stage .flyout{ left:56px }

/* Tiny helper buttons */
.badge{font-size:12px; opacity:.85; padding:2px 6px; border:1px solid var(--muted); border-radius:8px}
</style>
</head>
<body>
  <header>
    <div class="brand">Note Link <span class="pill">v0.6.7 / No.11</span></div>
    <div class="actions">
      <span class="badge" id="pageInfo">1/1</span>
      <button id="btnPrint" title="Âç∞Âà∑">Âç∞Âà∑</button>
      <button id="btnPng"   title="PNGÊõ∏„ÅçÂá∫„ÅóÔºàËÉåÊôØËæº„ÅøÔºâ">PNG</button>
      <button id="btnShare" title="ÂÖ±Êúâ">ÂÖ±Êúâ</button>
    </div>
  </header>

  <div class="wrap" id="wrap">
    <aside class="sidebar" id="sidebar">
      <!-- toggle (same size,ÊúÄ‰∏äÊÆµ) -->
      <div class="tool" id="btnToggle" title="„ÉÑ„Éº„É´„Éê„ÉºÈñãÈñâ">‚ñΩ</div>

      <div class="tool" data-tool="pen"        title="„Éö„É≥"        id="t-pen">‚úé <span class="dot"></span></div>
      <div class="tool" data-tool="hl"         title="ËõçÂÖâ„Éö„É≥"    id="t-hl">üñç</div>
      <div class="tool" data-tool="eraser"     title="Ê∂à„Åó„Ç¥„É†"    id="t-eraser">‚å´</div>
      <div class="tool" data-tool="pan"        title="ÁßªÂãï"        id="t-pan">üñê</div>
      <div class="tool" data-tool="text"       title="„ÉÜ„Ç≠„Çπ„Éà"    id="t-text">‚å®</div>

      <div class="gearHint">‰∏ã„ÅÆ‚öô„ÅßË®≠ÂÆö</div>
      <div class="tool" id="btnGear" title="Ë®≠ÂÆö">‚öô</div>
    </aside>

    <main class="stage" id="stage">
      <canvas id="cv"></canvas>

      <!-- Settings flyout -->
      <div class="flyout hidden" id="flyout">
        <div class="flyHead">
          <div style="font-weight:700" id="flyTitle">Ë®≠ÂÆö</div>
          <button class="closeX" id="flyClose">‚úï</button>
        </div>
        <div class="tabbar" id="tabbar"></div>
        <div id="flyBody"></div>
      </div>
    </main>
  </div>

<script>
/* ===== State ===== */
const S = {
  pages:[{strokes:[], texts:[]}], page:0,
  tool:'pen',
  pen:{ color:'#fffae6', size:3, alpha:1 },
  hl :{ color:'#ffff66', size:16, alpha:0.35 },
  eraser:{ mode:'partial', radius:24 }, // mode: 'partial' | 'all'
  view:{ x:0, y:0, scale:1 },
  bg:'#0e1420',
  ui:{ gearOpen:false, sidebarCollapsed:false }
};

/* ===== Elements ===== */
const wrap = document.getElementById('wrap');
const sidebar = document.getElementById('sidebar');
const stage = document.getElementById('stage');
const cv = document.getElementById('cv'); const ctx = cv.getContext('2d');
const pageInfo = document.getElementById('pageInfo');
const btnToggle = document.getElementById('btnToggle');
const btnGear = document.getElementById('btnGear');
const fly = document.getElementById('flyout');
const flyTitle = document.getElementById('flyTitle');
const flyClose = document.getElementById('flyClose');
const tabbar = document.getElementById('tabbar');
const flyBody = document.getElementById('flyBody');
const btnPrint = document.getElementById('btnPrint');
const btnPng = document.getElementById('btnPng');
const btnShare = document.getElementById('btnShare');

const tools = [...sidebar.querySelectorAll('.tool[data-tool]')];

/* ===== Layout & Render ===== */
function resize(){
  const r = stage.getBoundingClientRect();
  const dpr = Math.max(1, window.devicePixelRatio||1);
  cv.width = Math.floor(r.width * dpr);
  cv.height = Math.floor(r.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  render();
}
window.addEventListener('resize', resize);

function render(){
  // bg
  ctx.save();
  ctx.fillStyle = S.bg;
  ctx.fillRect(0,0,cv.width,cv.height);
  ctx.restore();

  // strokes
  const P = S.pages[S.page];
  for(const s of P.strokes){ drawStroke(s); }
}

function drawStroke(s){
  if(!s.points || s.points.length<2) return;
  ctx.save();
  ctx.lineCap = ctx.lineJoin = 'round';
  ctx.globalAlpha = s.alpha;
  ctx.strokeStyle = s.color;
  ctx.lineWidth = s.size;
  ctx.beginPath();
  ctx.moveTo(s.points[0].x, s.points[0].y);
  for(let i=1;i<s.points.length;i++){ const p=s.points[i]; ctx.lineTo(p.x, p.y); }
  ctx.stroke();
  ctx.restore();
}

/* ===== Tool switching ===== */
function setTool(name){
  S.tool = name;
  tools.forEach(el=> el.classList.toggle('active', el.dataset.tool===name));
  // ‰ª•Ââç„ÅÆ„Éë„Éç„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Åü„Çâ‰∏≠Ë∫´„ÇíÂàá„ÇäÊõø„Åà
  if(S.ui.gearOpen) openGear(name);
}
tools.forEach(el=> el.addEventListener('click', ()=> setTool(el.dataset.tool)));
setTool('pen');

/* ===== Sidebar toggle ===== */
btnToggle.addEventListener('click', ()=>{
  sidebar.classList.toggle('collapsed');
  S.ui.sidebarCollapsed = sidebar.classList.contains('collapsed');
  btnToggle.textContent = S.ui.sidebarCollapsed ? '‚ñ≥' : '‚ñΩ';
  resize();
});

/* ===== Pointer drawing ===== */
let drawing=false, currStroke=null;

cv.addEventListener('pointerdown', e=>{
  if(S.tool==='pan' || S.tool==='text') return;
  drawing=true;
  const p = toCanvas(e);
  if(S.tool==='eraser' && S.eraser.mode==='all'){
    S.pages[S.page].strokes = [];
    render(); return;
  }
  if(S.tool==='eraser' && S.eraser.mode==='partial'){
    // ÈÉ®ÂàÜÊ∂àÂéªÔºöÂçäÂæÑ‰ª•ÂÜÖ„ÅÆÁ∑öÂàÜ„ÇíÈô§ÂéªÔºàÁ∞°ÊòìÔºâ
    const r = S.eraser.radius;
    S.pages[S.page].strokes = S.pages[S.page].strokes.filter(st=>{
      return !st.points.some(pt => dist(pt,p) <= r);
    });
    render(); return;
  }
  // pen / hl
  const base = (S.tool==='pen')? S.pen : S.hl;
  currStroke = { tool:S.tool, color:base.color, size:base.size, alpha:base.alpha, points:[p] };
  S.pages[S.page].strokes.push(currStroke);
});
cv.addEventListener('pointermove', e=>{
  if(!drawing || !currStroke) return;
  currStroke.points.push( toCanvas(e) );
  render();
});
cv.addEventListener('pointerup', ()=>{ drawing=false; currStroke=null; });
cv.addEventListener('pointercancel', ()=>{ drawing=false; currStroke=null; });

function toCanvas(e){
  const r = cv.getBoundingClientRect();
  return { x: e.clientX - r.left, y: e.clientY - r.top };
}
function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }

/* ===== Gear (single) ===== */
btnGear.addEventListener('click', ()=>{
  S.ui.gearOpen = !S.ui.gearOpen;
  if(S.ui.gearOpen) openGear(S.tool);
  fly.classList.toggle('hidden', !S.ui.gearOpen);
});
flyClose.addEventListener('click', ()=>{ S.ui.gearOpen=false; fly.classList.add('hidden'); });

function openGear(tab){
  flyTitle.textContent = 'Ë®≠ÂÆö';
  // „Çø„Éñ
  tabbar.innerHTML='';
  const tabs = ['pen','hl','eraser'];
  const names = {pen:'„Éö„É≥', hl:'ËõçÂÖâ„Éö„É≥', eraser:'Ê∂à„Åó„Ç¥„É†'};
  tabs.forEach(t=>{
    const b=document.createElement('button');
    b.textContent=names[t]; if(t===tab) b.classList.add('active');
    b.onclick=()=> { setTool(t); openGear(t); };
    tabbar.appendChild(b);
  });
  // ‰∏≠Ë∫´
  flyBody.innerHTML='';
  if(tab==='pen') flyBody.appendChild(panelPen());
  if(tab==='hl')  flyBody.appendChild(panelHL());
  if(tab==='eraser') flyBody.appendChild(panelEraser());
}
function panelPen(){
  const d=document.createElement('div');
  d.innerHTML = `
    <div class="row"><label>Ëâ≤</label><input type="color" id="penC" value="${S.pen.color}"></div>
    <div class="row"><label>Â§™„Åï</label><input type="range" id="penS" min="1" max="30" value="${S.pen.size}"><span>${S.pen.size}</span></div>
    <div class="row"><label>‰∏çÈÄèÊòéÂ∫¶</label><input type="range" id="penA" min="0.1" step="0.05" max="1" value="${S.pen.alpha}"><span>${S.pen.alpha}</span></div>
  `;
  d.querySelector('#penC').oninput=e=> S.pen.color = e.target.value;
  d.querySelector('#penS').oninput=e=>{ S.pen.size = +e.target.value; e.target.nextElementSibling.textContent=e.target.value; };
  d.querySelector('#penA').oninput=e=>{ S.pen.alpha= +e.target.value; e.target.nextElementSibling.textContent=e.target.value; };
  return d;
}
function panelHL(){
  const d=document.createElement('div');
  d.innerHTML = `
    <div class="row"><label>Ëâ≤</label><input type="color" id="hlC" value="${S.hl.color}"></div>
    <div class="row"><label>Â§™„Åï</label><input type="range" id="hlS" min="4" max="80" value="${S.hl.size}"><span>${S.hl.size}</span></div>
  `;
  d.querySelector('#hlC').oninput=e=> S.hl.color = e.target.value;
  d.querySelector('#hlS').oninput=e=>{ S.hl.size = +e.target.value; e.target.nextElementSibling.textContent=e.target.value; };
  return d;
}
function panelEraser(){
  const d=document.createElement('div');
  d.innerHTML = `
    <div class="row"><label>„É¢„Éº„Éâ</label>
      <select id="em">
        <option value="partial"${S.eraser.mode==='partial'?' selected':''}>ÈÉ®ÂàÜÊ∂àÂéª</option>
        <option value="all"${S.eraser.mode==='all'?' selected':''}>ÂÖ®Èù¢Ê∂àÂéª</option>
      </select>
    </div>
    <div class="row" id="radRow"><label>ÂçäÂæÑ</label><input type="range" id="er" min="8" max="64" value="${S.eraser.radius}"><span>${S.eraser.radius}</span></div>
  `;
  const em = d.querySelector('#em'); const radRow = d.querySelector('#radRow');
  em.onchange = ()=>{ S.eraser.mode = em.value; radRow.style.display = (em.value==='partial')?'flex':'none'; };
  const er = d.querySelector('#er');
  er.oninput = e=>{ S.eraser.radius = +e.target.value; e.target.nextElementSibling.textContent=e.target.value; };
  radRow.style.display = (S.eraser.mode==='partial')?'flex':'none';
  return d;
}

/* ===== Top actions ===== */
btnPrint.onclick = ()=> window.print();

btnPng.onclick = ()=>{
  // ËÉåÊôØËæº„Åø„ÅßPNG
  const r = cv.getBoundingClientRect();
  const cnv = document.createElement('canvas'); cnv.width = r.width; cnv.height = r.height;
  const c = cnv.getContext('2d');
  c.fillStyle = S.bg; c.fillRect(0,0,cnv.width,cnv.height);
  // Á≠âÂÄç„ÅßÊèè„Åè
  c.drawImage(cv, 0, 0, cnv.width, cnv.height);
  const url = cnv.toDataURL('image/png');
  const a = document.createElement('a'); a.href=url; a.download='note.png'; a.click();
};

btnShare.onclick = async ()=>{
  const url = location.href;
  try{
    if(navigator.share){
      await navigator.share({title:'Note Link', text:'„Éé„Éº„Éà„ÇíÂÖ±Êúâ', url});
    }else{
      await navigator.clipboard.writeText(url);
      alert('URL„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
    }
  }catch(e){ console.warn(e); }
};

/* ===== Init ===== */
pageInfo.textContent = `${S.page+1}/${S.pages.length}`;
resize();
</script>
</body>
</html>
