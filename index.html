<!DOCTYPE html>
<html lang="ja" data-headlessui-focus-visible>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Note Link v0.6.9-fix2 / No.13</title>

  <!-- キャッシュ回避のため、毎回 ?v= の値を変えてください -->
  <link rel="stylesheet" href="note-link-ui.css?v=0.6.9-fix2-1726655940" />

  <!-- PWA系（既にある場合はそのまま） -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b1020" />
</head>
<body>
  <!-- ===== Top bar ===== -->
  <header class="topbar" style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;">
    <h1 class="app-title" style="margin:0;font-size:14px">Note Link v0.6.9-fix2 / No.13</h1>
    <div class="actions">
      <button id="btnPrint" title="印刷">印刷</button>
      <button id="btnPng" title="PNG保存（背景込み）">PNG</button>
      <button id="btnShare" title="共有">共有</button>
    </div>
  </header>

  <!-- ===== App wrapper ===== -->
  <div id="wrap" style="position:relative; height:calc(100vh - 46px);">

    <!-- ===== Sidebar ===== -->
    <aside id="sidebar" class="sidebar" aria-label="ツールバー">
      <div class="nl-stack">
        <!-- 折り畳みトグル（JSが矢印を付与） -->
        <button class="nl-tool nl-collapse-toggle" type="button" title="折り畳み" aria-label="折り畳み"></button>

        <!-- ツール：ペン -->
        <button class="nl-tool" id="tool-pen" type="button" title="ペン" aria-label="ペン">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm18.71-11.04a1.003 1.003 0 0 0 0-1.42L19.21 2.29a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.8-1.66z"/>
          </svg>
        </button>

        <!-- ツール：蛍光ペン -->
        <button class="nl-tool" id="tool-marker" type="button" title="蛍光ペン" aria-label="蛍光ペン">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M3 16l6-6 5 5-6 6H3v-5zm9.5-9.5l2-2a2.12 2.12 0 1 1 3 3l-2 2-3-3z"/>
          </svg>
        </button>

        <!-- ツール：消しゴム -->
        <button class="nl-tool" id="tool-eraser" type="button" title="消しゴム" aria-label="消しゴム">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M16.24 3.56a2 2 0 0 1 2.83 0l1.37 1.37a2 2 0 0 1 0 2.83L11.82 16.38a2 2 0 0 1-1.41.59H7.05a2 2 0 0 1-1.41-.59L3.56 14.3a2 2 0 0 1 0-2.83L16.24 3.56zM4 20h16v2H4z"/>
          </svg>
        </button>

        <!-- ツール：テキスト -->
        <button class="nl-tool" id="tool-text" type="button" title="テキスト" aria-label="テキスト">
          <span style="font-weight:700;font-size:16px;line-height:1">T</span>
        </button>

        <!-- 歯車：設定（最下部固定） -->
        <button class="nl-tool settings" id="tool-settings" type="button" title="設定" aria-label="設定">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M19.43 12.98l1.77-1.02-1-1.73-2.04.35a6.96 6.96 0 0 0-1.2-.7l-.31-2.07h-2l-.31 2.07c-.42.17-.83.4-1.2.7l-2.04-.35-1 1.73 1.77 1.02a6.8 6.8 0 0 0 0 1.4L7.9 15.4l1 1.73 2.04-.35c.37.3.78.53 1.2.7l.31 2.07h2l.31-2.07c.42-.17.83-.4 1.2-.7l2.04.35 1-1.73-1.77-1.02c.05-.46.05-.94 0-1.4zM12 15.6a3.6 3.6 0 1 1 0-7.2 3.6 3.6 0 0 1 0 7.2z"/>
          </svg>
        </button>
      </div>
    </aside>

    <!-- ===== Stage / Canvas area ===== -->
    <main id="stage" style="position:relative; height:100%; margin-left:56px;">
      <div id="canvasRoot" style="position:relative; width:100%; height:100%;">
        <canvas id="canvas" style="position:absolute; inset:0;"></canvas>
      </div>

      <!-- === Panels (ツール設定) === -->
      <!-- ペン -->
      <section id="pen-settings" class="tool-config" data-tool="pen" style="display:none">
        <h3>ペン設定</h3>
        <div class="row">
          <label>色 <input type="color" id="penColor" value="#e5e7eb"></label>
        </div>
        <div class="row">
          <label>太さ <input type="range" id="penSize" min="1" max="30" value="3"></label>
        </div>
        <div class="row">
          <label>不透明度 <input type="range" id="penAlpha" min="0" max="1" step="0.05" value="1"></label>
        </div>
        <small>Shiftで直線（15°刻み）</small>
      </section>

      <!-- 蛍光ペン -->
      <section id="highlighter-settings" class="tool-config" data-tool="highlighter" style="display:none">
        <h3>蛍光ペン設定</h3>
        <div class="row">
          <label>色 <input type="color" id="hlColor" value="#56c7a8"></label>
        </div>
        <div class="row">
          <label>太さ <input type="range" id="hlSize" min="4" max="60" value="16"></label>
        </div>
        <div class="row">
          <label>不透明度 <input type="range" id="hlAlpha" min="0" max="1" step="0.05" value="0.35"></label>
        </div>
        <small>Shiftで直線（15°刻み）</small>
      </section>

      <!-- 消しゴム -->
      <section id="eraser-settings" class="tool-config" data-tool="eraser" style="display:none">
        <h3>消しゴム設定</h3>
        <div class="row">
          <label>消し範囲 <input type="range" id="eraserSize" min="8" max="80" value="34"></label>
        </div>
        <div class="row">
          <button id="btnEraseAll">全面消去</button>
        </div>
      </section>

      <!-- テキスト -->
      <section id="text-settings" class="tool-config" data-tool="text" style="display:none">
        <h3>テキスト設定</h3>
        <div class="row">
          <label>文字サイズ <input type="range" id="textSize" min="10" max="72" value="24"></label>
        </div>
        <div class="row">
          <button id="btnAddText">テキストを追加</button>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== Main Script（末尾に配置：既存のJSは全削除してこれだけ置く） ===== -->
  <script>
  /* Note Link UI + Drawing
     version: v0.6.9-fix2 / No.13
  */
  (function(){
    const ver = 'v0.6.9-fix2 / No.13';
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    /* ---------- Sidebar init ---------- */
    const sidebar = $('#sidebar') || $('.sidebar');
    let stack = sidebar.querySelector('.nl-stack');
    if (!stack){
      stack = document.createElement('div'); stack.className='nl-stack';
      Array.from(sidebar.children).forEach(ch=>stack.appendChild(ch));
      sidebar.appendChild(stack);
    }
    // ツールクラス付与
    Array.from(stack.children).forEach(el=>{
      const isBtn = el.matches('button,[role="button"],.tool');
      if (isBtn && !el.classList.contains('nl-collapse-toggle')) el.classList.add('nl-tool');
    });

    // 設定ボタンを最下部へ
    const gear = $('#tool-settings') || $$('.nl-tool', stack).at(-1);
    if (gear) gear.classList.add('settings');
    if (!$('.nl-spacer', sidebar)) {
      const sp=document.createElement('div'); sp.className='nl-spacer';
      sidebar.insertBefore(sp, gear||null);
    }

    // 折り畳みトグル
    let toggle = $('.nl-collapse-toggle', stack);
    if (!toggle){
      toggle = document.createElement('button');
      toggle.className='nl-tool nl-collapse-toggle'; toggle.type='button';
      toggle.title='折り畳み'; toggle.ariaLabel='折り畳み';
      stack.insertBefore(toggle, stack.firstChild);
    }
    const getCollapsed = ()=> localStorage.getItem('nl.sidebarCollapsed')==='1';
    const setCollapsed = v => localStorage.setItem('nl.sidebarCollapsed', v?'1':'0');
    const reflectArrow = ()=> toggle.dataset.arrow = getCollapsed() ? '▽':'△';
    const applyCollapsed = ()=>{
      sidebar.setAttribute('data-collapsed', getCollapsed()?'1':'0');
      reflectArrow();
    };
    toggle.addEventListener('click', ()=>{ setCollapsed(!getCollapsed()); applyCollapsed(); });
    applyCollapsed();

    // アクティブ表示
    function setActive(el){ $$('.nl-tool',stack).forEach(b=>b.classList.toggle('active', b===el)); }

    // 初期アクティブ（ペン）
    setActive($('#tool-pen') || $$('.nl-tool',stack)[1] || $$('.nl-tool',stack)[0]);

    // パネルの出し分け
    const panelMap = {
      pen: $('#pen-settings'),
      highlighter: $('#highlighter-settings'),
      marker: $('#highlighter-settings'),  // alias
      eraser: $('#eraser-settings'),
      text: $('#text-settings')
    };
    function showPanel(key){
      Object.values(panelMap).forEach(p=> p && (p.style.display='none'));
      const p = panelMap[key]; if (p) p.style.display='';
    }
    showPanel('pen');

    // ツール切替
    $$('.nl-tool', stack).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if (btn.classList.contains('nl-collapse-toggle')) return;
        setActive(btn);
        const label = (btn.title||btn.ariaLabel||btn.textContent||'').toLowerCase();
        if (label.includes('ペン') && !label.includes('蛍')) { currentTool='pen'; showPanel('pen'); }
        else if (label.includes('蛍') || label.includes('marker') || label.includes('high')) { currentTool='highlighter'; showPanel('highlighter'); }
        else if (label.includes('消') || label.includes('erase')) { currentTool='eraser'; showPanel('eraser'); }
        else if (label.includes('文') || label.includes('text') || label.includes('テキスト')) { currentTool='text'; showPanel('text'); }
      });
    });

    /* ---------- Canvas drawing ---------- */
    const canvas = $('#canvas');
    const root = $('#canvasRoot');
    const ctx = canvas.getContext('2d');

    function fit(){
      const r = root.getBoundingClientRect();
      // 物理ピクセル対応
      const dpr = window.devicePixelRatio||1;
      canvas.width = Math.max(1, Math.floor(r.width * dpr));
      canvas.height = Math.max(1, Math.floor(r.height * dpr));
      canvas.style.width = r.width+'px';
      canvas.style.height = r.height+'px';
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener('resize', fit, {passive:true});
    fit();

    // 状態
    let currentTool = 'pen';
    const state = {
      pen: { color: $('#penColor').value, size: +$('#penSize').value, alpha: +$('#penAlpha').value },
      hl:  { color: $('#hlColor').value,  size: +$('#hlSize').value,  alpha: +$('#hlAlpha').value  },
      eraser: { size: +$('#eraserSize').value },
      text: { size: +$('#textSize').value }
    };

    // 設定イベント
    $('#penColor').addEventListener('input', e=> state.pen.color=e.target.value);
    $('#penSize').addEventListener('input', e=> state.pen.size=+e.target.value);
    $('#penAlpha').addEventListener('input', e=> state.pen.alpha=+e.target.value);

    $('#hlColor').addEventListener('input', e=> state.hl.color=e.target.value);
    $('#hlSize').addEventListener('input', e=> state.hl.size=+e.target.value);
    $('#hlAlpha').addEventListener('input', e=> state.hl.alpha=+e.target.value);

    $('#eraserSize').addEventListener('input', e=> state.eraser.size=+e.target.value);
    $('#btnEraseAll').addEventListener('click', ()=> { ctx.clearRect(0,0,canvas.width,canvas.height); });

    $('#textSize').addEventListener('input', e=> state.text.size=+e.target.value);
    $('#btnAddText').addEventListener('click', ()=>{
      const t = document.createElement('div');
      t.contentEditable = 'true';
      t.textContent = 'テキスト';
      Object.assign(t.style,{
        position:'absolute', left:'80px', top:'80px', color:'#e5e7eb',
        fontSize: state.text.size+'px', padding:'2px 4px', border:'1px dashed #27324a',
        borderRadius:'6px', background:'rgba(0,0,0,.2)', cursor:'move'
      });
      // ドラッグ
      let dragging=false, sx=0, sy=0, sl=0, st=0;
      t.addEventListener('pointerdown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; sl=parseFloat(t.style.left); st=parseFloat(t.style.top); t.setPointerCapture(e.pointerId); });
      t.addEventListener('pointermove', e=>{ if(!dragging) return; t.style.left = sl + (e.clientX-sx) + 'px'; t.style.top = st + (e.clientY-sy) + 'px'; });
      t.addEventListener('pointerup',   e=>{ dragging=false; t.releasePointerCapture(e.pointerId); });
      root.appendChild(t);
      t.focus();
    });

    // 直線スナップ（15°刻み）
    function snapToAngle(x0,y0,x1,y1){
      const dx = x1-x0, dy=y1-y0;
      const ang = Math.atan2(dy,dx);           // -pi..pi
      const step = Math.PI/12;                 // 15°
      const q = Math.round(ang/step)*step;
      const len = Math.hypot(dx,dy);
      return [x0 + Math.cos(q)*len, y0 + Math.sin(q)*len];
    }

    let drawing=false, lastX=0, lastY=0, startX=0, startY=0, shift=false;

    function begin(x,y){
      drawing=true; lastX=startX=x; lastY=startY=y;
      ctx.lineCap='round'; ctx.lineJoin='round';
      if (currentTool==='pen'){
        ctx.globalCompositeOperation='source-over';
        ctx.strokeStyle=state.pen.color;
        ctx.globalAlpha=state.pen.alpha;
        ctx.lineWidth=state.pen.size;
        ctx.beginPath(); ctx.moveTo(x,y);
      }else if(currentTool==='highlighter'){
        ctx.globalCompositeOperation='source-over';
        ctx.strokeStyle=state.hl.color;
        ctx.globalAlpha=state.hl.alpha;
        ctx.lineWidth=state.hl.size;
        ctx.beginPath(); ctx.moveTo(x,y);
      }else if(currentTool==='eraser'){
        ctx.globalCompositeOperation='destination-out';
        ctx.globalAlpha=1;
        ctx.lineWidth=state.eraser.size;
        ctx.beginPath(); ctx.moveTo(x,y);
      }
    }
    function draw(x,y){
      if(!drawing) return;
      let tx=x, ty=y;
      if (shift){ [tx,ty] = snapToAngle(startX,startY,x,y); }
      ctx.lineTo(tx,ty); ctx.stroke();
      lastX=tx; lastY=ty;
    }
    function end(){ if(!drawing) return; drawing=false; ctx.closePath(); ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over'; }

    function rel(e){
      const rect = canvas.getBoundingClientRect();
      return [e.clientX-rect.left, e.clientY-rect.top];
    }

    canvas.addEventListener('pointerdown', e=>{
      if (currentTool==='text') return; // テキストはボタンで追加
      shift = e.shiftKey;
      canvas.setPointerCapture(e.pointerId);
      const [x,y] = rel(e); begin(x,y);
    });
    canvas.addEventListener('pointermove', e=>{
      if(!drawing) return;
      shift = e.shiftKey;
      const [x,y] = rel(e); draw(x,y);
    });
    canvas.addEventListener('pointerup', e=>{
      canvas.releasePointerCapture(e.pointerId);
      end();
    });

    /* ---------- Export / Print / Share ---------- */
    $('#btnPrint').addEventListener('click', ()=> window.print());

    $('#btnPng').addEventListener('click', ()=>{
      // 背景色込みで書き出す
      const bg = '#0b1020';
      const tmp = document.createElement('canvas');
      tmp.width = canvas.width; tmp.height = canvas.height;
      const tctx = tmp.getContext('2d');
      tctx.fillStyle = bg; tctx.fillRect(0,0,tmp.width,tmp.height);
      tctx.drawImage(canvas,0,0);
      const url = tmp.toDataURL('image/png');
      const a = document.createElement('a'); a.href=url; a.download='note.png'; a.click();
    });

    $('#btnShare').addEventListener('click', async ()=>{
      const url = location.href;
      if (navigator.share){
        try { await navigator.share({title:'Note Link', url}); } catch(e){}
      } else if (navigator.clipboard){
        try { await navigator.clipboard.writeText(url); alert('URLをクリップボードにコピーしました'); } catch(e){}
      } else {
        prompt('このURLをコピーしてください', url);
      }
    });

    /* ---------- SW registration（任意） ---------- */
    if ('serviceWorker' in navigator){
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    }

    console.log('[NoteLink] ready', ver);
  })();
  </script>
</body>
</html>
