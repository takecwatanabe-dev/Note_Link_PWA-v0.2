<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Note Link (single-file safe build)</title>
<style>
:root{
  --bg:#0b1220; --panel:#0b1220; --ink:#e5e7eb; --muted:#475569; --accent:#50C878;
  --sidebarW:56px; --sidebarW-collapsed:44px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;
}

/* --- Top bar --- */
header{
  height:44px; display:flex; align-items:center; justify-content:space-between;
  padding:0 10px; border-bottom:1px solid var(--muted); background:var(--panel);
}
.brand{display:flex; align-items:center; gap:8px; font-weight:700}
.brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent)}
.version{font-size:12px; opacity:.85; border:1px solid var(--muted); padding:2px 8px; border-radius:10px}
.actions{display:flex; gap:6px; align-items:center}
.actions .btn{
  display:inline-flex; align-items:center; justify-content:center;
  height:28px; padding:0 10px; border:1px solid var(--muted); border-radius:10px;
  color:var(--ink); background:#0b1220; cursor:pointer; user-select:none;
}
.actions .btn:hover{border-color:var(--accent)}
.actions .counter{min-width:52px; text-align:center}

/* --- Layout --- */
.wrap{
  height:calc(100% - 44px);
  display:grid; grid-template-columns: var(--sidebarW) 1fr;
  transition:grid-template-columns .2s ease;
}
.wrap.collapsed{ grid-template-columns: var(--sidebarW-collapsed) 1fr; }

/* --- Sidebar --- */
.sidebar{
  background:var(--panel); border-right:1px solid var(--muted);
  padding:8px 6px; display:flex; flex-direction:column; gap:8px;
}
.tool{
  width:40px; height:40px; border-radius:10px; border:1px solid var(--muted);
  display:grid; place-items:center; color:var(--ink); background:#0b1220; cursor:pointer;
}
.tool:hover{border-color:var(--accent)}
.tool svg,.tool img{ width:18px; height:18px; filter:grayscale(1) brightness(1.05); }
.tool.active{
  outline:2px solid var(--accent);
  box-shadow:0 0 0 3px rgba(80,200,120,.25), 0 0 8px rgba(80,200,120,.35) inset;
  color:var(--accent);
}
.sep{height:8px}

/* --- Stage --- */
.stage{position:relative; background:#0b1220}
canvas{display:block; width:100%; height:100%}
#overlay{position:absolute; inset:0; pointer-events:none}

/* --- Settings Panel (tabbed) --- */
#settingsPanel{
  position:absolute; top:64px; left:72px; width:360px; max-width:92vw;
  background:rgba(17,24,39,.98); border:1px solid var(--muted); border-radius:12px;
  box-shadow:0 10px 32px rgba(0,0,0,.45); padding:10px; backdrop-filter: blur(6px);
}
.hidden{display:none !important}
.panelHeader{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
.tabs{display:flex; gap:6px; margin-bottom:8px; flex-wrap:wrap}
.tabs .tab{height:28px; padding:0 10px; border:1px solid var(--muted); border-radius:8px; display:inline-flex; align-items:center; cursor:pointer; background:#0b1220; color:var(--ink)}
.tabs .tab.active{border-color:var(--accent); background:#10212f}
.row{display:flex; align-items:center; gap:8px; margin:8px 0}
.row input[type="range"]{ flex:1 }
.hint{font-size:12px; opacity:.75}

/* Bottom status */
.status{
  position:absolute; bottom:8px; right:8px; font-size:12px; opacity:.75;
  background:#0b1220; border:1px solid var(--muted); border-radius:8px; padding:2px 8px;
}
</style>
</head>
<body>
  <header>
    <div class="brand">
      <span class="dot"></span> <span>Note Link</span>
      <span class="version" id="verLabel">v0.6.8 / No.12</span>
    </div>
    <div class="actions">
      <span class="counter" id="pageCount">1/1</span>
      <button id="btnPrint" class="btn">印刷</button>
      <button id="btnPng" class="btn">PNG</button>
      <button id="btnShare" class="btn">共有</button>
    </div>
  </header>

  <div class="wrap" id="wrap">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <button class="tool" id="btnCollapse" title="開閉">
        <svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>

      <button class="tool active" id="toolPen" title="ペン" data-tool="pen">
        <svg viewBox="0 0 24 24"><path d="M3 21l3.5-.8L21 5.7a1.9 1.9 0 0 0 0-2.7 1.9 1.9 0 0 0-2.7 0L3.8 17.5 3 21z" fill="currentColor"/></svg>
      </button>
      <button class="tool" id="toolHL" title="蛍光ペン" data-tool="hl">
        <svg viewBox="0 0 24 24"><path d="M4 17l6-6 7 7-2 2-7-7-4 4z" fill="currentColor"/></svg>
      </button>
      <button class="tool" id="toolEraser" title="消しゴム" data-tool="eraser">
        <svg viewBox="0 0 24 24"><path d="M16 3l5 5-9 9H7L2 12l9-9h5z" fill="none" stroke="currentColor" stroke-width="2"/><path d="M7 17h5" stroke="currentColor" stroke-width="2"/></svg>
      </button>

      <div class="sep"></div>

      <button class="tool" id="toolSettings" title="設定">
        <svg viewBox="0 0 24 24"><path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm8 4l2-1-2-3-2 1a7 7 0 0 0-2-1l-1-2H9l-1 2a7 7 0 0 0-2 1l-2-1-2 3 2 1a7 7 0 0 0 0 2l-2 1 2 3 2-1a7 7 0 0 0 2 1l1 2h6l1-2a7 7 0 0 0 2-1l2 1 2-3-2-1a7 7 0 0 0 0-2z" fill="currentColor"/></svg>
      </button>
    </aside>

    <!-- Stage -->
    <main class="stage" id="stage">
      <canvas id="canvas"></canvas>
      <canvas id="overlay"></canvas>

      <!-- Settings Panel -->
      <div id="settingsPanel" class="hidden" role="dialog" aria-label="設定">
        <div class="panelHeader">
          <strong>設定</strong>
          <button id="btnClosePanel" class="btn" style="height:26px;padding:0 8px">閉じる</button>
        </div>
        <div class="tabs" id="tabs">
          <button class="tab active" data-tab="pen">ペン</button>
          <button class="tab" data-tab="hl">蛍光ペン</button>
          <button class="tab" data-tab="eraser">消しゴム</button>
        </div>
        <div id="tabBody"></div>
        <div class="hint">ヒント：Shiftを押しながら描くと直線。角度は15°刻みでスナップします。</div>
      </div>

      <div class="status" id="status">準備完了</div>
    </main>
  </div>

<script>
(()=>{
// ====== 状態 ======
const state = {
  tool: 'pen',
  pen: { color:'#fffae6', size:3, alpha:1 },
  hl : { color:'#ffff66', size:16, alpha:0.35 },
  eraser: { radius:16 },
  drawing:false, start:{x:0,y:0}, prev:{x:0,y:0},
  shiftLine:false, // Shift直線中
};
const wrap = document.getElementById('wrap');
const sidebar = document.getElementById('sidebar');
const btnCollapse = document.getElementById('btnCollapse');
const btnSettings = document.getElementById('toolSettings');
const panel = document.getElementById('settingsPanel');
const tabBody = document.getElementById('tabBody');
const tabs = document.getElementById('tabs');
const status = document.getElementById('status');

const canvas = document.getElementById('canvas');
const overlay = document.getElementById('overlay');
const ctx = canvas.getContext('2d');
const octx = overlay.getContext('2d');
const dpr = Math.max(1, window.devicePixelRatio||1);

// ====== レイアウト ======
function resize(){
  const r = document.getElementById('stage').getBoundingClientRect();
  [canvas,overlay].forEach(c=>{
    c.width = Math.floor(r.width * dpr);
    c.height= Math.floor(r.height* dpr);
    c.style.width = r.width+'px';
    c.style.height= r.height+'px';
  });
  ctx.setTransform(dpr,0,0,dpr,0,0);
  octx.setTransform(dpr,0,0,dpr,0,0);
  // 背景を毎回塗っておく（PNG出力に背景を含めるため）
  ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg').trim() || '#0b1220';
  ctx.fillRect(0,0,canvas.width/dpr,canvas.height/dpr);
}
window.addEventListener('resize', resize);
resize();

// ====== ツール切替 & アクティブ強調 ======
function setTool(t){
  state.tool = t;
  sidebar.querySelectorAll('.tool').forEach(b=>b.classList.remove('active'));
  const btn = document.querySelector(`.tool[data-tool="${t}"]`);
  if(btn) btn.classList.add('active');
  // 設定パネルは自動クローズ
  closePanel();
}
document.getElementById('toolPen').onclick   = ()=> setTool('pen');
document.getElementById('toolHL').onclick    = ()=> setTool('hl');
document.getElementById('toolEraser').onclick= ()=> setTool('eraser');

// 折り畳み
btnCollapse.addEventListener('click', ()=>{
  wrap.classList.toggle('collapsed');
  btnCollapse.classList.toggle('active', wrap.classList.contains('collapsed'));
});

// ====== 設定パネル ======
btnSettings.addEventListener('click', ()=>{
  panel.classList.toggle('hidden');
  btnSettings.classList.toggle('active', !panel.classList.contains('hidden'));
  if(!panel.classList.contains('hidden')) buildPanel('pen'); // 初期タブ
});
document.getElementById('btnClosePanel').onclick = ()=> closePanel();
function closePanel(){
  panel.classList.add('hidden');
  btnSettings.classList.toggle('active', false);
}
tabs.addEventListener('click', (e)=>{
  const tab = e.target.closest('.tab'); if(!tab) return;
  tabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');
  buildPanel(tab.dataset.tab);
});
function buildPanel(kind){
  tabBody.innerHTML='';
  if(kind==='pen'){
    tabBody.appendChild(panelPen());
  }else if(kind==='hl'){
    tabBody.appendChild(panelHL());
  }else if(kind==='eraser'){
    tabBody.appendChild(panelEraser());
  }
}
function panelPen(){
  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <div class="row"><label>色</label><input type="color" id="penColor" value="${state.pen.color}"></div>
    <div class="row"><label>太さ</label><input type="range" id="penSize" min="1" max="30" value="${state.pen.size}"><span>${state.pen.size}</span></div>
    <div class="row"><label>不透明度</label><input type="range" id="penAlpha" min="0.05" max="1" step="0.05" value="${state.pen.alpha}"><span>${state.pen.alpha}</span></div>
  `;
  wrap.querySelector('#penColor').oninput = e=> state.pen.color = e.target.value;
  const sz = wrap.querySelector('#penSize'), szv = wrap.querySelector('span');
  sz.oninput = ()=>{ state.pen.size = +sz.value; szv.textContent = sz.value; };
  const al = wrap.querySelector('#penAlpha'), alv = wrap.querySelectorAll('span')[1];
  al.oninput = ()=>{ state.pen.alpha = +al.value; alv.textContent = al.value; };
  return wrap;
}
function panelHL(){
  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <div class="row"><label>色</label><input type="color" id="hlColor" value="${state.hl.color}"></div>
    <div class="row"><label>太さ</label><input type="range" id="hlSize" min="4" max="60" value="${state.hl.size}"><span>${state.hl.size}</span></div>
    <div class="hint">蛍光ペンは不透明度 0.35 固定です</div>
  `;
  wrap.querySelector('#hlColor').oninput = e=> state.hl.color = e.target.value;
  const sz = wrap.querySelector('#hlSize'), sv = wrap.querySelector('span');
  sz.oninput = ()=>{ state.hl.size = +sz.value; sv.textContent = sz.value; };
  return wrap;
}
function panelEraser(){
  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <div class="row"><label>半径</label><input type="range" id="erRadius" min="8" max="48" value="${state.eraser.radius}"><span>${state.eraser.radius}</span></div>
    <div class="row"><button id="btnClearAll" class="btn">全面消去</button></div>
  `;
  const er = wrap.querySelector('#erRadius'), ev = wrap.querySelector('span');
  er.oninput = ()=>{ state.eraser.radius = +er.value; ev.textContent = er.value; };
  wrap.querySelector('#btnClearAll').onclick = ()=>{ ctx.clearRect(0,0,canvas.width/dpr,canvas.height/dpr); resize(); };
  return wrap;
}

// ====== 入力（ペン／蛍光／消しゴム／直線） ======
function pos(e){
  const rect = canvas.getBoundingClientRect();
  return { x:(e.clientX-rect.left), y:(e.clientY-rect.top) };
}

function begin(e){
  state.drawing = true;
  const p = pos(e); state.start = state.prev = p;
  state.shiftLine = e.shiftKey === true;
  if(state.shiftLine){
    octx.clearRect(0,0,overlay.width/dpr,overlay.height/dpr);
    status.textContent = '直線モード（Shift）';
  }else{
    status.textContent = '描画中';
  }
  if(state.tool==='eraser'){
    eraseDot(p.x,p.y);
  }
}
function move(e){
  if(!state.drawing) return;
  const p = pos(e);
  if(state.tool==='eraser'){
    eraseDot(p.x,p.y);
    return;
  }
  if(state.shiftLine){
    // 直線プレビュー（15°スナップ）
    const ang = Math.atan2(p.y-state.start.y, p.x-state.start.x);
    const step = Math.PI/12; // 15度
    const sn = Math.round(ang/step)*step;
    const len = Math.hypot(p.x-state.start.x, p.y-state.start.y);
    const x2 = state.start.x + Math.cos(sn)*len;
    const y2 = state.start.y + Math.sin(sn)*len;
    octx.clearRect(0,0,overlay.width/dpr,overlay.height/dpr);
    octx.save();
    const isHL = state.tool==='hl';
    octx.globalAlpha = isHL? state.hl.alpha : state.pen.alpha;
    octx.strokeStyle = isHL? state.hl.color : state.pen.color;
    octx.lineWidth   = isHL? state.hl.size  : state.pen.size;
    octx.lineCap = octx.lineJoin = 'round';
    octx.beginPath(); octx.moveTo(state.start.x,state.start.y); octx.lineTo(x2,y2); octx.stroke();
    octx.restore();
  }else{
    // 通常フリーハンド
    drawSegment(state.prev, p, state.tool);
    state.prev = p;
  }
}
function end(e){
  if(!state.drawing) return;
  if(state.shiftLine){
    // プレビューを本体へコミット
    const p = pos(e);
    const ang = Math.atan2(p.y-state.start.y, p.x-state.start.x);
    const step = Math.PI/12;
    const sn = Math.round(ang/step)*step;
    const len = Math.hypot(p.x-state.start.x, p.y-state.start.y);
    const x2 = state.start.x + Math.cos(sn)*len;
    const y2 = state.start.y + Math.sin(sn)*len;
    drawSegment(state.start, {x:x2,y:y2}, state.tool);
    octx.clearRect(0,0,overlay.width/dpr,overlay.height/dpr);
  }
  state.drawing=false;
  status.textContent = '準備完了';
}

function drawSegment(a,b,tool){
  ctx.save();
  const isHL = tool==='hl';
  ctx.globalAlpha = isHL? state.hl.alpha : state.pen.alpha;
  ctx.strokeStyle = isHL? state.hl.color : state.pen.color;
  ctx.lineWidth   = isHL? state.hl.size  : state.pen.size;
  ctx.lineCap = ctx.lineJoin = 'round';
  ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
  ctx.restore();
}
function eraseDot(x,y){
  ctx.save();
  ctx.globalCompositeOperation = 'destination-out';
  ctx.beginPath(); ctx.arc(x,y,state.eraser.radius,0,Math.PI*2); ctx.fill();
  ctx.restore();
}

overlay.addEventListener('pointerdown', begin);
overlay.addEventListener('pointermove', move);
overlay.addEventListener('pointerup', end);
overlay.addEventListener('pointercancel', ()=> state.drawing=false);
// キャンバスにも（ドラッグが外れた時のフォールバック）
canvas.addEventListener('pointerdown', begin);
canvas.addEventListener('pointermove', move);
canvas.addEventListener('pointerup', end);
canvas.addEventListener('pointercancel', ()=> state.drawing=false);

// ====== 出力系 ======
document.getElementById('btnPrint').onclick = ()=> window.print();

document.getElementById('btnPng').onclick = async ()=>{
  // そのまま toBlob（背景は既に塗ってある）
  canvas.toBlob(b=>{
    const url = URL.createObjectURL(b);
    const a = document.createElement('a');
    a.href=url; a.download='note-page.png'; a.click();
    URL.revokeObjectURL(url);
  },'image/png',1);
};

document.getElementById('btnShare').onclick = async ()=>{
  canvas.toBlob(async (blob)=>{
    const file = new File([blob], 'note-page.png', {type:'image/png', lastModified: Date.now()});
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
      try{
        await navigator.share({ files:[file], title:'Note Link', text:'ノートを共有' });
      }catch(e){ /* キャンセル等は無視 */ }
      return;
    }
    if(navigator.clipboard && window.ClipboardItem){
      try{
        await navigator.clipboard.write([ new ClipboardItem({'image/png': blob}) ]);
        alert('クリップボードに画像をコピーしました');
        return;
      }catch(e){}
    }
    // 最終手段：ダウンロード
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='note-page.png'; a.click();
    URL.revokeObjectURL(url);
  }, 'image/png', 1);
};

// ====== 版数表示（任意：ローカルにナンバリング保存） ======
try{
  const BASE_VER = 'v0.6.8';
  const key='note_link_build_no';
  const current = Number(localStorage.getItem(key)||'12')||12;
  document.getElementById('verLabel').textContent = `${BASE_VER} / No.${current}`;
}catch(_){}
})();
</script>
</body>
</html>
