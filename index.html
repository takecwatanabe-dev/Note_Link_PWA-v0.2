<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Note Link v0.6.7 / No.11 (single)</title>
<style>
:root{
  --bg:#0b1220;        /* èƒŒæ™¯ */
  --ink:#e5e7eb;       /* ã‚¤ãƒ³ã‚¯è‰²ï¼ˆUIæ–‡å­—ï¼‰*/
  --panel:#111827;     /* ãƒ‘ãƒãƒ« */
  --muted:#3b4452;     /* æ ç·š */
  --accent:#34d399;    /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç·‘ */
  --side-w:56px;       /* ã‚µã‚¤ãƒ‰å¹…ï¼ˆé–‹ï¼‰*/
  --side-w-c:20px;     /* ã‚µã‚¤ãƒ‰å¹…ï¼ˆé–‰ï¼‰*/
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif;overflow:hidden}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
header{height:48px;display:flex;align-items:center;gap:8px;padding:0 12px;background:var(--panel);border-bottom:1px solid var(--muted)}
.brand{font-weight:700}
header .spacer{flex:1}
header button{height:30px;padding:0 10px;border:1px solid var(--muted);border-radius:10px;background:#0b1220;color:var(--ink);cursor:pointer}
header button:hover{border-color:var(--accent)}

/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.app{display:grid;grid-template-columns:var(--side-w) 1fr;grid-template-rows:1fr;height:calc(100% - 48px)}
.sidebar{position:relative;background:var(--panel);border-right:1px solid var(--muted);padding:8px;overflow:hidden}
.sidebar.is-collapsed{width:var(--side-w-c)}
/* ãƒˆã‚°ãƒ«ã¯ãƒ„ãƒ¼ãƒ«ã¨åŒã˜ã‚µã‚¤ã‚ºãƒ»å¸¸ã«æœ€å‰é¢ */
.toggle{
  position:absolute;top:8px;left:8px;width:32px;height:32px;
  display:grid;place-items:center;border-radius:10px;border:1px solid var(--muted);
  background:#0f172a;z-index:3;cursor:pointer;user-select:none
}
.tools{margin-top:48px;display:flex;flex-direction:column;gap:8px}
.tool,.gear{
  width:32px;height:32px;border-radius:10px;border:1px solid var(--muted);
  display:grid;place-items:center;background:#0f172a;cursor:pointer
}
/* ãƒ©ãƒ™ãƒ«ã¯CPUç¯€ç´„ã®ãŸã‚åˆæœŸã¯éè¡¨ç¤ºï¼ˆä»Šã¯ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ï¼‰ */
.label{display:none}
.tool.active,.gear.active{outline:2px solid var(--accent);box-shadow:0 0 10px rgba(52,211,153,.6)}
/* æŠ˜ã‚ŠãŸãŸã¿æ™‚ã¯ä¸­èº«ã‚’éš ã™ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ã«ã‹ã¶ã›ãªã„ï¼‰ */
.sidebar.is-collapsed .tools{display:none}

/* ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ»ã‚­ãƒ£ãƒ³ãƒã‚¹ã¯å¸¸ã«æœ€å‰é¢ã§å…¥åŠ›ã‚’å–ã‚Œã‚‹ */
.stage{position:relative;z-index:0;background:var(--bg)}
#canvas{display:block;width:100%;height:100%;position:relative;z-index:1}

/* è¨­å®šãƒ‘ãƒãƒ«ï¼ˆãƒ„ãƒ¼ãƒ«åˆ¥ï¼‰ */
.panel{
  position:fixed;top:72px;left:72px;max-width:360px;background:rgba(17,24,39,.98);
  border:1px solid var(--muted);border-radius:14px;box-shadow:0 10px 32px rgba(0,0,0,.45);
  padding:12px;z-index:9
}
.panel.hidden{display:none}
.panel h3{margin:0 0 8px;font-size:14px}
.row{display:flex;align-items:center;gap:8px;margin:8px 0}
.row input[type="range"]{width:160px}

/* ã‚¨ãƒ©ãƒ¼ãƒãƒ¼ï¼ˆåŸå› è¦‹ãˆã‚‹åŒ–ï¼‰ */
#errbar{position:fixed;left:0;right:0;top:0;z-index:99999;background:#7f1d1d;color:#fff;
  font:14px/1.4 system-ui;padding:6px 10px;display:none}
</style>

<script>
/* â–¼æ¤œè¨¼æœŸé–“ã®ä¸€æ™‚å¯¾ç­–ï¼šå¤ã„SWã‚’è§£é™¤ã—ã¦å¸¸ã«æœ€æ–°ã‚’è¡¨ç¤º */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations()
    .then(regs => regs.forEach(r => r.unregister()))
    .catch(()=>{});
}
/* ç”»é¢ä¸Šã«æœ€åˆã®ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™ï¼ˆåŸå› ç‰¹å®šç”¨ï¼‰ */
window.addEventListener('error', e=>{
  const b = document.getElementById('errbar') || (()=>{
    const d=document.createElement('div');d.id='errbar';document.body.appendChild(d);return d;
  })();
  b.textContent = 'Error: ' + (e?.error?.message || e.message || 'unknown');
  b.style.display='block';
});
</script>
</head>
<body>
<header>
  <div class="brand">Note Link <small>v0.6.7 / No.11</small></div>
  <div class="spacer"></div>
  <button id="btnPrint">å°åˆ·</button>
  <button id="btnPng">PNG</button>
  <button id="btnShare">å…±æœ‰</button>
</header>

<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="toggle" id="toggle">â–½</div>
    <div class="tools" id="tools">
      <button class="tool active" id="tool-pen" title="ãƒšãƒ³">âœ</button>
      <button class="tool" id="tool-hl"  title="è›å…‰ãƒšãƒ³">ğŸ–</button>
      <button class="tool" id="tool-eraser" title="æ¶ˆã—ã‚´ãƒ ">âŒ«</button>
      <button class="tool" id="tool-pan" title="ç§»å‹•/ã‚ºãƒ¼ãƒ ">ğŸ–</button>
      <button class="tool" id="tool-text" title="ãƒ†ã‚­ã‚¹ãƒˆ">âŒ¨</button>
      <button class="gear" id="tool-gear" title="è¨­å®š">âš™</button>
    </div>
  </aside>

  <main class="stage">
    <canvas id="canvas"></canvas>
  </main>
</div>

<!-- è¨­å®šãƒ‘ãƒãƒ«ï¼ˆãƒ„ãƒ¼ãƒ«åˆ‡æ›¿ã§ä¸­èº«ã‚’å·®ã—æ›¿ãˆã€‚é–‹ã„ã¦ã„ã‚‹æ™‚ã«ãƒ„ãƒ¼ãƒ«å¤‰æ›´â†’è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºï¼‰ -->
<div class="panel hidden" id="panel">
  <h3 id="panelTitle">è¨­å®š</h3>
  <div id="panelBody"></div>
  <div class="row" style="justify-content:flex-end">
    <button id="panelClose">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
function init(){
  // ---------- DOM å–å¾— ----------
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const sidebar = document.getElementById('sidebar');
  const toggle = document.getElementById('toggle');

  const tPen = document.getElementById('tool-pen');
  const tHL  = document.getElementById('tool-hl');
  const tEr  = document.getElementById('tool-eraser');
  const tPan = document.getElementById('tool-pan');
  const tTxt = document.getElementById('tool-text');
  const tGear= document.getElementById('tool-gear');

  const panel = document.getElementById('panel');
  const panelTitle = document.getElementById('panelTitle');
  const panelBody  = document.getElementById('panelBody');
  const panelClose = document.getElementById('panelClose');

  const btnPrint = document.getElementById('btnPrint');
  const btnPng   = document.getElementById('btnPng');
  const btnShare = document.getElementById('btnShare');

  // ---------- çŠ¶æ…‹ ----------
  const state = {
    tool: 'pen',
    view: {scale:1,x:0,y:0},
    drawing: false,
    last: null,
    pen: { color:'#fffae6', size:3, alpha:1 },
    hl : { color:'#ffff66', size:16, alpha:0.35 },
    eraser: { size:24 },
    bgColor: getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()
  };

  // ---------- ã‚µã‚¤ã‚º ----------
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  function resize(){
    const r = canvas.getBoundingClientRect();
    canvas.width  = Math.floor(r.width * dpr);
    canvas.height = Math.floor(r.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    render();
  }
  window.addEventListener('resize', resize);

  // ---------- æç”» ----------
  function render(){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    ctx.save();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.restore();

    // èƒŒæ™¯
    ctx.fillStyle = state.bgColor;
    ctx.fillRect(0,0,w,h);
    // ã“ã“ã§ã¯ãƒ™ã‚¯ã‚¿å±¥æ­´ã‚’æŒãŸãšãƒ©ã‚¹ã‚¿ã«ç›´æ¥æãç°¡æ˜“ç‰ˆï¼ˆå®‰å®šå„ªå…ˆï¼‰
  }

  // ---------- å…¥åŠ› ----------
  function toPoint(e){
    const rect = canvas.getBoundingClientRect();
    return { x:(e.clientX-rect.left), y:(e.clientY-rect.top) };
  }

  function begin(e){
    if (state.tool==='pan') return; // çœç•¥
    state.drawing = true;
    state.last = toPoint(e);
    if (state.tool==='text'){
      // è¶…ç°¡æ˜“ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå°†æ¥æ‹¡å¼µï¼‰
      const p = state.last;
      const s = prompt('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›'); 
      if (s){ ctx.fillStyle = '#fff'; ctx.font='18px "Noto Sans JP",sans-serif'; ctx.fillText(s,p.x,p.y); }
      state.drawing=false;
      closePanel();
    }
  }

  function draw(e){
    if (!state.drawing) return;
    const p = toPoint(e);
    const a = state.last;

    if (state.tool==='pen' || state.tool==='hl'){
      const tool = state.tool==='pen' ? state.pen : state.hl;
      ctx.save();
      ctx.globalAlpha = tool.alpha;
      ctx.lineCap='round'; ctx.lineJoin='round';
      ctx.strokeStyle = tool.color; ctx.lineWidth = tool.size;
      ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(p.x,p.y); ctx.stroke();
      ctx.restore();
    } else if (state.tool==='eraser'){
      ctx.save();
      ctx.globalCompositeOperation='destination-out';
      ctx.beginPath(); ctx.arc(p.x,p.y,state.eraser.size/2,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }
    state.last = p;
  }

  function end(){ state.drawing=false; }

  canvas.addEventListener('pointerdown', e=>{
    // ãƒ‘ãƒ¼ãƒ ãƒªã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ç°¡æ˜“ï¼šã‚¿ãƒƒãƒã‚’ç„¡åŠ¹åŒ–ã€ãƒšãƒ³/ãƒã‚¦ã‚¹ã®ã¿
    if (e.pointerType==='touch') return;
    canvas.setPointerCapture(e.pointerId);
    begin(e);
  });
  canvas.addEventListener('pointermove', draw);
  canvas.addEventListener('pointerup',   end);
  canvas.addEventListener('pointercancel',end);

  // ---------- ãƒ„ãƒ¼ãƒ«åˆ‡æ›¿ ----------
  const allTools=[tPen,tHL,tEr,tPan,tTxt];
  function setTool(name){
    state.tool = name;
    allTools.forEach(b=>b.classList.remove('active'));
    ({pen:tPen,hl:tHL,eraser:tEr,pan:tPan,text:tTxt}[name].classList.add('active'));
    closePanel(); // ãƒ„ãƒ¼ãƒ«å¤‰æ›´æ™‚ã¯è¨­å®šã‚’é–‰ã˜ã‚‹ï¼ˆã”è¦æœ›ï¼‰
  }
  tPen.addEventListener('click', ()=>setTool('pen'));
  tHL .addEventListener('click', ()=>setTool('hl'));
  tEr .addEventListener('click', ()=>setTool('eraser'));
  tPan.addEventListener('click', ()=>setTool('pan'));
  tTxt.addEventListener('click', ()=>setTool('text'));

  // ---------- è¨­å®šï¼ˆ1 å€‹ã®ã‚®ã‚¢ã«çµ±åˆï¼‰ ----------
  function openPanel(){
    panel.classList.remove('hidden');
    tGear.classList.add('active');
    panelBody.innerHTML='';
    if (state.tool==='pen'){
      panelTitle.textContent='ãƒšãƒ³è¨­å®š';
      panelBody.appendChild(makePenUI(state.pen));
    } else if (state.tool==='hl'){
      panelTitle.textContent='è›å…‰ãƒšãƒ³è¨­å®š';
      panelBody.appendChild(makePenUI(state.hl,true));
    } else if (state.tool==='eraser'){
      panelTitle.textContent='æ¶ˆã—ã‚´ãƒ è¨­å®š';
      panelBody.appendChild(makeEraserUI());
    } else {
      panelTitle.textContent='è¨­å®š';
      panelBody.textContent='ã“ã®ãƒ„ãƒ¼ãƒ«ã«è¨­å®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
    }
  }
  function closePanel(){ panel.classList.add('hidden'); tGear.classList.remove('active'); }
  tGear.addEventListener('click', ()=>{
    if (panel.classList.contains('hidden')) openPanel(); else closePanel();
  });
  panelClose.addEventListener('click', closePanel);

  function makePenUI(obj, isHL=false){
    const wrap = document.createElement('div');
    wrap.innerHTML = `
      <div class="row"><label>è‰²</label><input type="color" id="pColor" value="${obj.color}"></div>
      <div class="row"><label>å¤ªã•</label><input type="range" id="pSize" min="1" max="48" value="${obj.size}"><span>${obj.size}</span></div>
      ${isHL?'<div class="row"><small>â€» ä¸é€æ˜åº¦ã¯0.35å›ºå®š</small></div>':
             '<div class="row"><label>ä¸é€æ˜åº¦</label><input type="range" id="pAlpha" min="0.1" max="1" step="0.05" value="'+obj.alpha+'"><span>'+obj.alpha+'</span></div>'}
    `;
    const pColor = wrap.querySelector('#pColor');
    const pSize  = wrap.querySelector('#pSize');  const pSizeV = pSize.nextElementSibling;
    pColor.oninput = ()=> obj.color = pColor.value;
    pSize.oninput  = ()=>{ obj.size = +pSize.value; pSizeV.textContent=obj.size; };
    if (!isHL){
      const pAlpha = wrap.querySelector('#pAlpha'); const pAlphaV = pAlpha.nextElementSibling;
      pAlpha.oninput = ()=>{ obj.alpha = +pAlpha.value; pAlphaV.textContent=obj.alpha; };
    }
    return wrap;
  }
  function makeEraserUI(){
    const wrap = document.createElement('div');
    wrap.innerHTML = `
      <div class="row"><label>æ¶ˆã—ç¯„å›²</label><input type="range" id="eSize" min="8" max="64" value="${state.eraser.size}"><span>${state.eraser.size}</span></div>
      <div class="row"><button id="eClear">å…¨é¢æ¶ˆå»</button></div>
    `;
    const eSize = wrap.querySelector('#eSize'); const eV=eSize.nextElementSibling;
    eSize.oninput = ()=>{ state.eraser.size = +eSize.value; eV.textContent=state.eraser.size; };
    wrap.querySelector('#eClear').onclick = ()=>{ render(); };
    return wrap;
  }

  // ---------- ã‚µã‚¤ãƒ‰ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿ ----------
  function toggleSide(){
    const collapsed = sidebar.classList.toggle('is-collapsed');
    toggle.textContent = collapsed ? 'â–³' : 'â–½';
    resize();
  }
  toggle.addEventListener('click', toggleSide);

  // ---------- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ----------
  btnPrint.addEventListener('click', ()=> window.print());
  btnPng.addEventListener('click', ()=>{
    // èƒŒæ™¯è‰²è¾¼ã¿ã§PNG
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const tmp = document.createElement('canvas'); tmp.width=w; tmp.height=h;
    const tc = tmp.getContext('2d');
    tc.fillStyle = state.bgColor; tc.fillRect(0,0,w,h);
    tc.drawImage(canvas,0,0,w,h);
    const a = document.createElement('a');
    a.href = tmp.toDataURL('image/png'); a.download = 'note.png'; a.click();
  });
  btnShare.addEventListener('click', async ()=>{
    const url = location.href;
    if (navigator.share){
      try{ await navigator.share({title:'Note Link', url}); }catch(_){}
    }else if (navigator.clipboard){
      try{ await navigator.clipboard.writeText(url); alert('URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
      catch{ alert('URLã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    }else{
      prompt('ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', url);
    }
  });

  // åˆæœŸåŒ–
  resize();
  render();
}
if (document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded', init);
}else{
  init();
}
</script>
</body>
</html>
