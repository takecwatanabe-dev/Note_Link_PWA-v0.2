<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Note Link v0.6.5 / No.9</title>
<style>
:root{
  --bg:#0f172a;        /* èƒŒæ™¯ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹å¤–ï¼‰ */
  --panel:#111827;     /* ãƒ‘ãƒãƒ«/ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
  --ink:#e5e7eb;       /* æ–‡å­—è‰² */
  --accent:#50C878;    /* å¼·èª¿ï¼ˆç·‘ï¼‰ */
  --muted:#374151;     /* æ ç·š */
}
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0; color:var(--ink); background:var(--bg);
  font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;
  overflow:hidden;
}

/* â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆä¸Šéƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header{
  height:48px; display:flex; align-items:center; justify-content:space-between;
  padding:0 12px; background:var(--panel); border-bottom:1px solid var(--muted);
}
.brand{ display:flex; align-items:center; gap:8px; font-weight:700; }
.brand .dot{ width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 10px var(--accent); }
.brand .ver{ font-size:12px; padding:2px 8px; border:1px solid var(--muted); border-radius:10px; opacity:.9; }
.actions{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.actions button{
  height:32px; padding:0 10px; border-radius:10px; border:1px solid var(--muted);
  background:#0b1220; color:var(--ink); display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
}
.actions button:hover{ border-color:var(--accent); }

/* ãƒšãƒ¼ã‚¸è¡¨ç¤ºï¼ˆå¿…è¦ãªã‚‰ä½¿ã†ï¼‰ */
.pager{ height:32px; display:inline-flex; align-items:center; gap:6px; border:1px solid var(--muted); border-radius:10px; padding:0 8px; background:#0b1220; }
.pager .count{ min-width:64px; text-align:center; font-variant-numeric:tabular-nums; }

/* â”€â”€ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‹ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.wrap{
  display:grid; grid-template-columns:64px 1fr; height:calc(100% - 48px);
}
.wrap.collapsedX{ grid-template-columns:44px 1fr; }

.sidebar{
  position:relative; z-index:2;
  background:var(--panel); border-right:1px solid var(--muted);
  padding:8px 10px; display:flex; flex-direction:column; gap:10px; overflow:auto;
}
.sidebar.collapsedY{ max-height:44px; overflow:hidden; }

.stage{ position:relative; z-index:1; grid-column:2/-1; background:#0b1220; }
canvas{ display:block; width:100%; height:100%; }

/* â”€â”€ ãƒ„ãƒ¼ãƒ«ç¾¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolGroup{ display:flex; flex-direction:column; align-items:center; gap:4px; }
.tool{
  width:36px; height:36px; margin:0 auto; border-radius:12px;
  display:grid; place-items:center; border:1px solid var(--muted); background:#0b1220; cursor:pointer;
}
.tool-label{ font-size:10px; opacity:.85; text-align:center; }
.tool.active{
  border-color:var(--accent);
  box-shadow:0 0 0 2px var(--accent) inset, 0 0 10px rgba(80,200,120,.35);
}
.gear{ width:24px; height:24px; border-radius:8px; border:1px solid var(--muted); display:none; place-items:center; font-size:12px; opacity:.95; }
.toolGroup.active .gear{ display:grid; border-color:#94f1c2; }

/* æŠ˜ã‚ŠãŸãŸã¿ãƒˆã‚°ãƒ«ï¼šãƒšãƒ³ã®çœŸä¸Šãƒ»åŒã‚µã‚¤ã‚º */
.toggleBar{
  position:absolute; left:50%; transform:translateX(-50%);
  top:8px; width:36px; height:36px; border-radius:12px; display:grid; place-items:center;
  background:#0b1220; border:1px solid var(--muted); cursor:pointer; font-size:16px;
}

/* â”€â”€ è¨­å®šãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå¸¸ã«1ã¤ã ã‘è¡¨ç¤ºï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.flyout{
  position:absolute; top:72px; left:88px; width:360px; max-width:90vw; max-height:70vh; overflow:auto;
  background:rgba(17,24,39,.98); border:1px solid var(--muted); border-radius:14px; padding:10px;
  box-shadow:0 10px 32px rgba(0,0,0,.45); backdrop-filter: blur(6px);
}
.flyout.hidden{ display:none; }
.flyoutHeader{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
.closeX{ width:28px; height:28px; border-radius:8px; display:grid; place-items:center; border:1px solid var(--muted); background:#0b1220; cursor:pointer; }
.tabbar{ display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px; }
.tabbar button{ height:30px; padding:4px 8px; border-radius:8px; border:1px solid var(--muted); background:#0b1220; color:var(--ink); cursor:pointer; }
.tabbar button.active{ background:#10212f; border-color:var(--accent); }
.panel h3{ margin:6px 0 8px; font-size:14px; }
.row{ display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
.row input[type="range"]{ width: 160px; }
.hint{ font-size:12px; opacity:.75; }

/* è‰²ã‚¹ã‚¦ã‚©ãƒƒãƒ */
.swatch{ width:22px; height:22px; border-radius:6px; border:1px solid #64748b; cursor:pointer; }
.swatchRow{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

/* å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ */
.textInput{
  position:absolute; background:#fff; color:#111827; border:1px solid #94a3b8; border-radius:6px; padding:4px 6px; min-width:120px; outline:none;
}
</style>
</head>
<body>
  <header>
    <div class="brand">
      <span class="dot"></span> Note Link <span class="ver">v0.6.5 / No.9</span>
    </div>
    <div class="actions">
      <!-- å¿…è¦ãªã‚‰ Undo/Redo ç­‰ã‚‚ã“ã“ã«è¿½åŠ å¯èƒ½ -->
      <div class="pager">
        <button id="btnPrev" title="å‰ã¸">â—€</button>
        <span id="pageCount" class="count">1 / 1</span>
        <button id="btnNext" title="æ¬¡ã¸">â–¶</button>
        <button id="btnAdd"  title="ãƒšãƒ¼ã‚¸è¿½åŠ ">ï¼‹</button>
        <button id="btnDel"  title="ã“ã®ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤">ï¼</button>
      </div>
      <button id="btnPrint">å°åˆ·</button>
      <button id="btnExportPng">PNG</button>
      <button id="btnSave">ä¿å­˜(JSON)</button>
      <button id="btnLoad">èª­è¾¼(JSON)</button>
      <button id="btnShare">å…±æœ‰</button>
      <button id="btnTeacher">æ•™å¸«ãƒ¢ãƒ¼ãƒ‰</button>
      <input id="fileLoad" type="file" accept="application/json" style="display:none">
    </div>
  </header>

  <div class="wrap" id="wrap">
    <aside class="sidebar" id="sidebar">
      <div class="toggleBar" id="toggleBar" title="ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’ç¸¦ã«æŠ˜ã‚ŠãŸãŸã‚€/æˆ»ã™">â–³</div>

      <div class="toolGroup" id="groupPen">
        <button class="tool active" id="toolPen" title="ãƒšãƒ³">âœ</button>
        <button class="gear" id="gearPen" title="ãƒšãƒ³è¨­å®š">âš™</button>
        <div class="tool-label">ãƒšãƒ³</div>
      </div>

      <div class="toolGroup" id="groupHL">
        <button class="tool" id="toolHL" title="è›å…‰">ğŸ–</button>
        <button class="gear" id="gearHL" title="è›å…‰è¨­å®š">âš™</button>
        <div class="tool-label">è›å…‰</div>
      </div>

      <div class="toolGroup" id="groupEraser">
        <button class="tool" id="toolEraser" title="æ¶ˆã—ã‚´ãƒ ">âŒ«</button>
        <button class="gear" id="gearEraser" title="æ¶ˆã—ã‚´ãƒ è¨­å®š">âš™</button>
        <div class="tool-label">æ¶ˆ</div>
      </div>

      <div class="toolGroup" id="groupPan">
        <button class="tool" id="toolPan" title="ç§»å‹•">ğŸ–</button>
        <button class="gear" id="gearPan" title="ç§»å‹•è¨­å®š">âš™</button>
        <div class="tool-label">ç§»å‹•</div>
      </div>

      <div class="toolGroup" id="groupText">
        <button class="tool" id="toolText" title="ãƒ†ã‚­ã‚¹ãƒˆ">âŒ¨</button>
        <button class="gear" id="gearText" title="ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š">âš™</button>
        <div class="tool-label">ãƒ†ã‚­ã‚¹ãƒˆ</div>
      </div>

      <div class="toolGroup" id="groupBg">
        <button class="tool" id="toolBg" title="èƒŒæ™¯è‰²">ğŸ¨</button>
        <button class="gear" id="gearBg" title="èƒŒæ™¯è‰²è¨­å®š">âš™</button>
        <div class="tool-label">è¨­å®š</div>
      </div>
    </aside>

    <main class="stage" id="stage">
      <canvas id="canvas"></canvas>

      <!-- è¨­å®šãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆ -->
      <div class="flyout hidden" id="flyout">
        <div class="flyoutHeader">
          <div class="title" id="flyoutTitle">è¨­å®š</div>
          <div style="display:flex;gap:6px;align-items:center;">
            <button class="closeX" id="flyoutClose">âœ•</button>
          </div>
        </div>
        <div class="tabbar" id="tabbar"></div>
        <div id="flyoutBody"></div>
      </div>

      <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› -->
      <input class="textInput" id="textInput" style="display:none">
    </main>
  </div>

  <!-- Homeï¼ˆæ¦‚å¿µå°å…¥ã®å…¥å£ã€‚å¿…è¦æ™‚ã« showHomeOnStart=true ã§è¡¨ç¤ºï¼‰ -->
  <div id="homeModal" style="position:fixed;inset:0;display:none;background:rgba(0,0,0,.5);z-index:1000;">
    <div style="width:min(680px,92vw);margin:8vh auto;background:#111827;border:1px solid #374151;border-radius:16px;padding:16px;">
      <h2 style="margin:0 0 8px;">ãƒãƒ¼ãƒˆã‚’é¸ã¶</h2>
      <p style="opacity:.8;margin-top:0;">â‘ æ–°è¦ï¼â‘¡éå»ãƒãƒ¼ãƒˆï¼â‘¢å…ˆç”Ÿã®èª²é¡Œï¼â‘£å•é¡Œé›†ï¼â‘¤ã‚´ãƒŸç®±</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <button id="homeNew">â‘  æ–°è¦ãƒãƒ¼ãƒˆ</button>
        <button id="homeOpen">â‘¡ éå»ãƒãƒ¼ãƒˆ</button>
        <button id="homeAssign">â‘¢ å…ˆç”Ÿã®èª²é¡Œ</button>
        <button id="homeBooks">â‘£ å•é¡Œé›†</button>
        <button id="homeTrash">â‘¤ ã‚´ãƒŸç®±</button>
        <button id="homeClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

<script>
/* =======================
   çŠ¶æ…‹
======================= */
const state = {
  pages: [], pageIndex: 0,
  currentTool: 'pen',
  view: { scale:1, x:0, y:0, min:0.2, max:6 },
  stroke: null, drawing:false, pointerId:null,
  guide:{ type:'none', spacing:28, marginLeft:40, opacity:0.25, includeExport:true, gridEvery:0, engMid:0.5 },
  pen:{ pressureEnable:true, pressureGain:1.2, tiltEnable:false, tiltGain:0.6, palmReject:true, penOnly:false },
  hl:{ color:'#ffff66', size:16 },
  eraser:{ radius:22 },
  text:{ color:'#ffffff', size:18, font:"'Noto Sans JP',sans-serif" },
  bgColor:'#0b1220',
  teacher:false, // true=ç·¨é›†ä¸å¯
  ui:{ flyoutOpen:false, flyoutTab:'' }
};

/* åˆæœŸãƒšãƒ¼ã‚¸ */
function newPage(){ return { strokes:[], texts:[], bg:null, bgBitmap:null, bgSize:{w:0,h:0} }; }
state.pages.push(newPage());

/* =======================
   è¦ç´ å‚ç…§
======================= */
const wrap = document.getElementById('wrap');
const sidebar = document.getElementById('sidebar');
const toggleBar = document.getElementById('toggleBar');

const toolPen = document.getElementById('toolPen');
const toolHL = document.getElementById('toolHL');
const toolEraser = document.getElementById('toolEraser');
const toolPan = document.getElementById('toolPan');
const toolText = document.getElementById('toolText');
const toolBg = document.getElementById('toolBg');

const groupPen = document.getElementById('groupPen');
const groupHL = document.getElementById('groupHL');
const groupEraser = document.getElementById('groupEraser');
const groupPan = document.getElementById('groupPan');
const groupText = document.getElementById('groupText');
const groupBg = document.getElementById('groupBg');

const gearPen = document.getElementById('gearPen');
const gearHL = document.getElementById('gearHL');
const gearEraser = document.getElementById('gearEraser');
const gearPan = document.getElementById('gearPan');
const gearText = document.getElementById('gearText');
const gearBg = document.getElementById('gearBg');

const flyout = document.getElementById('flyout');
const flyoutTitle = document.getElementById('flyoutTitle');
const flyoutBody = document.getElementById('flyoutBody');
const flyoutClose = document.getElementById('flyoutClose');
const tabbar = document.getElementById('tabbar');

const canvas = document.getElementById('canvas');
const stage  = document.getElementById('stage');
const ctx = canvas.getContext('2d');
const dpr = Math.max(1, window.devicePixelRatio || 1);

const textInput = document.getElementById('textInput');

const btnPrev = document.getElementById('btnPrev');
const btnNext = document.getElementById('btnNext');
const btnAdd  = document.getElementById('btnAdd');
const btnDel  = document.getElementById('btnDel');
const pageCount = document.getElementById('pageCount');

const btnPrint = document.getElementById('btnPrint');
const btnExportPng = document.getElementById('btnExportPng');
const btnSave = document.getElementById('btnSave');
const btnLoad = document.getElementById('btnLoad');
const fileLoad = document.getElementById('fileLoad');
const btnShare = document.getElementById('btnShare');
const btnTeacher = document.getElementById('btnTeacher');

/* =======================
   ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼†æç”»
======================= */
function resizeCanvas(){
  const r = stage.getBoundingClientRect();
  canvas.width = Math.floor(r.width * dpr);
  canvas.height= Math.floor(r.height* dpr);
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr, dpr);
  render();
}
window.addEventListener('resize', resizeCanvas);

function updatePageIndicator(){ pageCount.textContent = `${state.pageIndex+1} / ${state.pages.length}`; }

function drawGuide(gctx){
  const g = state.guide; if(g.type==='none') return;
  const r = canvas.getBoundingClientRect();
  const w = Math.floor(r.width), h = Math.floor(r.height);
  gctx.save(); gctx.globalAlpha = g.opacity;

  if(g.type==='ruled' || g.type==='eng'){
    // æ¨ªç½«
    gctx.strokeStyle = '#64748b'; gctx.lineWidth=1;
    for(let y=g.spacing; y<h; y+=g.spacing){
      gctx.beginPath(); gctx.moveTo(0,y+0.5); gctx.lineTo(w,y+0.5); gctx.stroke();
      if(g.type==='eng'){ // ä¸­é–“ç·š
        gctx.save(); gctx.strokeStyle='#7c8ba0'; gctx.globalAlpha=Math.max(0.15,g.opacity*0.7);
        const mid = y - g.spacing*(1 - g.engMid);
        gctx.beginPath(); gctx.moveTo(0,mid+0.5); gctx.lineTo(w,mid+0.5); gctx.stroke();
        gctx.restore();
      }
    }
    if(g.marginLeft>0){
      gctx.strokeStyle='#ef4444';
      gctx.beginPath(); gctx.moveTo(g.marginLeft+0.5,0); gctx.lineTo(g.marginLeft+0.5,h); gctx.stroke();
    }
  }else if(g.type==='grid'){
    const k = Math.max(0, g.gridEvery|0);
    for(let y=g.spacing; y<h; y+=g.spacing){
      gctx.beginPath();
      const thick = (k && (Math.round(y/g.spacing)%k===0));
      gctx.strokeStyle = thick? '#7f8ea3' : '#475569';
      gctx.lineWidth = thick? 1.5 : 1;
      gctx.moveTo(0,y+0.5); gctx.lineTo(w,y+0.5); gctx.stroke();
    }
    for(let x=g.spacing; x<w; x+=g.spacing){
      gctx.beginPath();
      const thick = (k && (Math.round(x/g.spacing)%k===0));
      gctx.strokeStyle = thick? '#7f8ea3' : '#475569';
      gctx.lineWidth = thick? 1.5 : 1;
      gctx.moveTo(x+0.5,0); gctx.lineTo(x+0.5,h); gctx.stroke();
    }
  }else if(g.type==='dot'){
    gctx.fillStyle = '#64748b';
    for(let y=g.spacing; y<h; y+=g.spacing){
      for(let x=g.spacing; x<w; x+=g.spacing){
        gctx.beginPath(); gctx.arc(x,y,1,0,Math.PI*2); gctx.fill();
      }
    }
  }
  gctx.restore();
}

function drawStroke(gctx, s){
  if(!s.points || s.points.length<2) return;
  gctx.save();
  gctx.lineJoin='round'; gctx.lineCap='round';
  gctx.globalAlpha = s.alpha; gctx.strokeStyle = s.color; gctx.lineWidth = s.size;
  gctx.beginPath(); gctx.moveTo(s.points[0].x, s.points[0].y);
  for(let i=1;i<s.points.length;i++){ const p = s.points[i]; gctx.lineTo(p.x, p.y); }
  gctx.stroke(); gctx.restore();
}

function drawTexts(gctx){
  const page = state.pages[state.pageIndex];
  for(const t of page.texts){
    gctx.save();
    gctx.font = `${t.size}px ${t.font}`; gctx.fillStyle = t.color; gctx.textBaseline='top';
    gctx.fillText(t.text, t.x, t.y);
    gctx.restore();
  }
}

function render(){
  const r = canvas.getBoundingClientRect();
  const w = Math.floor(r.width), h = Math.floor(r.height);
  ctx.clearRect(0,0,w,h);
  // èƒŒæ™¯è‰²
  ctx.fillStyle = state.bgColor; ctx.fillRect(0,0,w,h);

  // èƒŒæ™¯ç”»åƒï¼ˆæ‹¡å¼µä½™åœ°ï¼‰
  const page = state.pages[state.pageIndex];
  if(page.bgBitmap){ ctx.drawImage(page.bgBitmap,0,0); }

  // ã‚¬ã‚¤ãƒ‰
  drawGuide(ctx);

  // ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯
  for(const s of page.strokes) drawStroke(ctx, s);
  if(state.stroke) drawStroke(ctx, state.stroke);

  // ãƒ†ã‚­ã‚¹ãƒˆ
  drawTexts(ctx);
}
resizeCanvas(); updatePageIndicator();

/* =======================
   ãƒ„ãƒ¼ãƒ«åˆ‡æ›¿ï¼†ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆ
======================= */
function closeFlyout(){ flyout.classList.add('hidden'); state.ui.flyoutOpen=false; }
function openFlyout(tab){
  state.ui.flyoutOpen=true; state.ui.flyoutTab=tab;
  flyout.classList.remove('hidden');

  const titles = { pen:'ãƒšãƒ³è¨­å®š', hl:'è›å…‰ãƒšãƒ³è¨­å®š', eraser:'æ¶ˆã—ã‚´ãƒ è¨­å®š', pan:'ç§»å‹•/ã‚ºãƒ¼ãƒ ', text:'ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š', bg:'èƒŒæ™¯è‰²' };
  flyoutTitle.textContent = titles[tab] || 'è¨­å®š';

  tabbar.innerHTML='';
  ['pen','hl','eraser','pan','text','bg'].forEach(t=>{
    const b=document.createElement('button');
    b.textContent=titles[t]; if(t===tab) b.classList.add('active');
    b.onclick=()=> openFlyout(t); tabbar.appendChild(b);
  });

  flyoutBody.innerHTML='';
  // ç°¡æ˜“UI
  if(tab==='pen'){
    flyoutBody.innerHTML=`
      <div class="panel"><h3>ãƒšãƒ³è¨­å®š</h3>
        <div class="row"><label>è‰²</label><input type="color" id="penColor" value="${state.penColor||'#fffae6'}"></div>
        <div class="row"><label>åŸºæº–å¤ªã•</label><input type="range" id="penSize" min="1" max="30" value="${state.baseSize||3}"><span id="penSizeVal">${state.baseSize||3}</span></div>
        <div class="row"><label>ä¸é€æ˜åº¦</label><input type="range" id="penAlpha" min="0.05" max="1" step="0.05" value="${state.baseAlpha??1}"><span id="penAlphaVal">${state.baseAlpha??1}</span></div>
        <details><summary>è©³ç´°</summary>
          <div class="row"><label><input type="checkbox" id="pressEn" ${state.pen.pressureEnable?'checked':''}> ç­†åœ§</label>
            <input type="range" id="pressGain" min="0" max="3" step="0.1" value="${state.pen.pressureGain}"><span id="pressGainVal">${state.pen.pressureGain}</span></div>
          <div class="row"><label><input type="checkbox" id="tiltEn" ${state.pen.tiltEnable?'checked':''}> å‚¾ã</label>
            <input type="range" id="tiltGain" min="0" max="2" step="0.1" value="${state.pen.tiltGain}"><span id="tiltGainVal">${state.pen.tiltGain}</span></div>
          <div class="row"><label><input type="checkbox" id="palm" ${state.pen.palmReject?'checked':''}> ãƒ‘ãƒ¼ãƒ ãƒªã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³</label></div>
          <div class="row"><label><input type="checkbox" id="penOnly" ${state.pen.penOnly?'checked':''}> ãƒšãƒ³å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰</label></div>
        </details>
      </div>`;
    const $ = id=>flyoutBody.querySelector(id);
    $('#penColor').oninput = e=> state.penColor = e.target.value;
    $('#penSize').oninput  = e=>{ state.baseSize = +e.target.value; $('#penSizeVal').textContent=e.target.value; };
    $('#penAlpha').oninput = e=>{ state.baseAlpha= +e.target.value; $('#penAlphaVal').textContent=e.target.value; };
    $('#pressEn').onchange = e=> state.pen.pressureEnable = e.target.checked;
    $('#pressGain').oninput= e=>{ state.pen.pressureGain=+e.target.value; $('#pressGainVal').textContent=e.target.value; };
    $('#tiltEn').onchange  = e=> state.pen.tiltEnable = e.target.checked;
    $('#tiltGain').oninput = e=>{ state.pen.tiltGain=+e.target.value; $('#tiltGainVal').textContent=e.target.value; };
    $('#palm').onchange    = e=> state.pen.palmReject = e.target.checked;
    $('#penOnly').onchange = e=> state.pen.penOnly   = e.target.checked;
  }
  if(tab==='hl'){
    flyoutBody.innerHTML=`
      <div class="panel"><h3>è›å…‰ãƒšãƒ³è¨­å®š</h3>
        <div class="row"><label>è‰²</label><input type="color" id="hlColor" value="${state.hl.color}"></div>
        <div class="row"><label>å¤ªã•</label><input type="range" id="hlSize" min="4" max="60" value="${state.hl.size}"><span id="hlSizeVal">${state.hl.size}</span></div>
      </div>`;
    const $=id=>flyoutBody.querySelector(id);
    $('#hlColor').oninput = e=> state.hl.color=e.target.value;
    $('#hlSize').oninput  = e=>{ state.hl.size=+e.target.value; $('#hlSizeVal').textContent=e.target.value; };
  }
  if(tab==='eraser'){
    flyoutBody.innerHTML=`
      <div class="panel"><h3>æ¶ˆã—ã‚´ãƒ è¨­å®š</h3>
        <div class="row"><label>æ¶ˆã—ç¯„å›²</label><input type="range" id="erRad" min="8" max="60" value="${state.eraser.radius}"><span id="erVal">${state.eraser.radius}</span></div>
        <div class="row"><button id="eraseAll">å…¨é¢æ¶ˆå»</button></div>
      </div>`;
    const $=id=>flyoutBody.querySelector(id);
    $('#erRad').oninput = e=>{ state.eraser.radius=+e.target.value; $('#erVal').textContent=e.target.value; };
    $('#eraseAll').onclick = ()=>{ state.pages[state.pageIndex].strokes=[]; render(); };
  }
  if(tab==='text'){
    flyoutBody.innerHTML=`
      <div class="panel"><h3>ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š</h3>
        <div class="row"><label>è‰²</label><input type="color" id="txColor" value="${state.text.color}"></div>
        <div class="row"><label>ã‚µã‚¤ã‚º</label><input type="range" id="txSize" min="10" max="72" value="${state.text.size}"><span id="txVal">${state.text.size}</span></div>
        <div class="row"><label>ãƒ•ã‚©ãƒ³ãƒˆ</label>
          <select id="txFont">
            <option value="'Noto Sans JP',sans-serif">ã‚´ã‚·ãƒƒã‚¯</option>
            <option value="'Hiragino Mincho ProN','Yu Mincho',serif">æ˜æœ</option>
            <option value="'Courier New',monospace">ç­‰å¹…</option>
          </select>
        </div>
      </div>`;
    const $=id=>flyoutBody.querySelector(id);
    $('#txColor').oninput = e=> state.text.color=e.target.value;
    $('#txSize').oninput  = e=>{ state.text.size=+e.target.value; $('#txVal').textContent=e.target.value; };
    $('#txFont').value = state.text.font;
    $('#txFont').onchange= e=> state.text.font=e.target.value;
  }
  if(tab==='bg'){
    flyoutBody.innerHTML=`
      <div class="panel"><h3>èƒŒæ™¯è‰²</h3>
        <div class="row swatchRow">
          <div class="swatch" data-c="#0b1220" style="background:#0b1220" title="é»’"></div>
          <div class="swatch" data-c="#ffffff" style="background:#ffffff" title="ç™½"></div>
          <div class="swatch" data-c="#e0f7ff" style="background:#e0f7ff" title="æ·¡é’"></div>
          <div class="swatch" data-c="#e0ffe7" style="background:#e0ffe7" title="æ·¡ç·‘"></div>
          <div class="swatch" data-c="#fffce0" style="background:#fffce0" title="æ·¡é»„"></div>
          <div class="swatch" data-c="#ffe0ef" style="background:#ffe0ef" title="æ·¡ãƒ”ãƒ³ã‚¯"></div>
        </div>
        <div class="row"><label>ã‚«ã‚¹ã‚¿ãƒ </label><input type="color" id="bgPick" value="${state.bgColor}"></div>
        <div class="row"><label><input type="checkbox" id="gInclude" ${state.guide.includeExport?'checked':''}> PNGã«ã‚¬ã‚¤ãƒ‰ã‚’å«ã‚ã‚‹</label></div>
      </div>`;
    const $=id=>flyoutBody.querySelector(id);
    $('#bgPick').oninput = e=>{ state.bgColor=e.target.value; render(); };
    flyoutBody.querySelectorAll('.swatch').forEach(el=>{
      el.addEventListener('click', ()=>{ const c=el.getAttribute('data-c'); state.bgColor=c; $('#bgPick').value=c; render(); });
    });
    $('#gInclude').onchange = e=> state.guide.includeExport = e.target.checked;
  }
}
flyoutClose.onclick = closeFlyout;

function setTool(t){
  state.currentTool=t;
  [toolPen,toolHL,toolEraser,toolPan,toolText,toolBg].forEach(el=>el.classList.remove('active'));
  ({pen:toolPen,hl:toolHL,eraser:toolEraser,pan:toolPan,text:toolText,bg:toolBg}[t]).classList.add('active');

  [groupPen,groupHL,groupEraser,groupPan,groupText,groupBg].forEach(g=>g.classList.remove('active'));
  ({pen:groupPen,hl:groupHL,eraser:groupEraser,pan:groupPan,text:groupText,bg:groupBg}[t]).classList.add('active');

  if(state.ui.flyoutOpen) closeFlyout(); // â†ãƒ„ãƒ¼ãƒ«å¤‰æ›´æ™‚ã¯è¨­å®šã‚’é–‰ã˜ã‚‹
}
toolPen.onclick = ()=> setTool('pen');
toolHL.onclick  = ()=> setTool('hl');
toolEraser.onclick = ()=> setTool('eraser');
toolPan.onclick = ()=> setTool('pan');
toolText.onclick = ()=> setTool('text');
toolBg.onclick   = ()=> setTool('bg');

gearPen.onclick   = ()=>{ setTool('pen');   openFlyout('pen'); };
gearHL.onclick    = ()=>{ setTool('hl');    openFlyout('hl'); };
gearEraser.onclick= ()=>{ setTool('eraser');openFlyout('eraser'); };
gearPan.onclick   = ()=>{ setTool('pan');   openFlyout('pan'); };
gearText.onclick  = ()=>{ setTool('text');  openFlyout('text'); };
gearBg.onclick    = ()=>{ setTool('bg');    openFlyout('bg'); };

/* æŠ˜ã‚ŠãŸãŸã¿ */
toggleBar.addEventListener('click', ()=>{
  sidebar.classList.toggle('collapsedY');
  wrap.classList.toggle('collapsedX');
  toggleBar.textContent = sidebar.classList.contains('collapsedY') ? 'â–½' : 'â–³';
  resizeCanvas();
});

/* =======================
   å…¥åŠ›ï¼ˆæç”»/æ¶ˆå»/ãƒ†ã‚­ã‚¹ãƒˆï¼‰
======================= */
function toCanvas(x,y){
  const r = canvas.getBoundingClientRect();
  return { x:(x - r.left - state.view.x)/state.view.scale, y:(y - r.top - state.view.y)/state.view.scale };
}
function effectiveSize(base,e){
  let sz = base;
  if(state.currentTool==='pen'){
    if(state.pen.pressureEnable && typeof e.pressure==='number'){
      const gain = Math.max(0,state.pen.pressureGain);
      sz *= (0.4 + e.pressure * gain);
    }
    if(state.pen.tiltEnable && (typeof e.altitudeAngle==='number' || typeof e.tiltX==='number')){
      let factor=1;
      if(typeof e.altitudeAngle==='number'){
        const a = Math.max(0.0001, e.altitudeAngle);
        factor = 1 + (1 - a) * state.pen.tiltGain;
      }else{
        const t = Math.min(90, Math.sqrt((e.tiltX||0)**2 + (e.tiltY||0)**2));
        factor = 1 + (t/90) * state.pen.tiltGain;
      }
      sz *= factor;
    }
  }
  return Math.max(0.5, Math.min(60, sz));
}

/* æ¶ˆã—ã‚´ãƒ ï¼ˆå††ç¯„å›²ã«è§¦ã‚ŒãŸã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã‚’ã¾ã‚‹ã”ã¨å‰Šé™¤ï¼‰ */
function eraseAt(x,y,r){
  const page = state.pages[state.pageIndex];
  page.strokes = page.strokes.filter(st=>{
    for(const p of st.points){
      const dx=p.x-x, dy=p.y-y;
      if(dx*dx+dy*dy <= r*r) return false; // æ¶ˆã™
    }
    return true;
  });
}

canvas.addEventListener('pointerdown', (e)=>{
  if(state.teacher) return; // æ•™å¸«ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ç·¨é›†ä¸å¯
  if(state.pen.palmReject && e.pointerType==='touch') return;
  if(state.pen.penOnly && !(e.pointerType==='pen' || e.pointerType==='mouse')) return;

  canvas.setPointerCapture?.(e.pointerId);
  state.pointerId = e.pointerId;

  const p = toCanvas(e.clientX, e.clientY);

  if(state.currentTool==='pen' || state.currentTool==='hl'){
    const base  = state.currentTool==='pen' ? (state.baseSize||3) : state.hl.size;
    const color = state.currentTool==='pen' ? (state.penColor||'#fffae6') : state.hl.color;
    const alpha = state.currentTool==='pen' ? (state.baseAlpha??1) : 0.35;
    state.stroke = { tool:state.currentTool, color, size:effectiveSize(base,e), alpha, points:[p] };
    state.drawing = true;
  }else if(state.currentTool==='eraser'){
    state.drawing = true; eraseAt(p.x,p.y,state.eraser.radius);
  }else if(state.currentTool==='text'){
    // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›é–‹å§‹
    textInput.style.left = (e.clientX - 6) + 'px';
    textInput.style.top  = (e.clientY - 10)+ 'px';
    textInput.style.display='block';
    textInput.value=''; textInput.focus();
    const page = state.pages[state.pageIndex];
    const base = { x:p.x, y:p.y, color:state.text.color, size:state.text.size, font:state.text.font, text:'' };

    const onConfirm = ()=>{
      const v = textInput.value.trim();
      textInput.style.display='none';
      textInput.onblur = null; textInput.onkeydown = null;
      if(!v) return;
      base.text = v; page.texts.push(base); render();
    };
    textInput.onkeydown = ev=>{
      if(ev.key==='Enter'){ ev.preventDefault(); onConfirm(); }
      if(ev.key==='Escape'){ textInput.style.display='none'; textInput.onblur=null; textInput.onkeydown=null; }
    };
    textInput.onblur = onConfirm;
  }
  render();
});

canvas.addEventListener('pointermove', (e)=>{
  if(!state.drawing || e.pointerId!==state.pointerId) return;
  const p = toCanvas(e.clientX, e.clientY);
  if(state.currentTool==='pen' || state.currentTool==='hl'){
    state.stroke.points.push(p);
  }else if(state.currentTool==='eraser'){
    eraseAt(p.x,p.y,state.eraser.radius);
  }
  render();
});

canvas.addEventListener('pointerup', (e)=>{
  if(e.pointerId!==state.pointerId) return;
  canvas.releasePointerCapture?.(e.pointerId);
  state.drawing=false; state.pointerId=null;

  if(state.stroke && (state.currentTool==='pen' || state.currentTool==='hl')){
    state.pages[state.pageIndex].strokes.push(state.stroke);
    state.stroke=null; render();
  }
});

/* =======================
   ãƒšãƒ¼ã‚¸
======================= */
btnPrev.onclick = ()=>{ if(state.pageIndex>0){ state.pageIndex--; updatePageIndicator(); render(); } };
btnNext.onclick = ()=>{ if(state.pageIndex<state.pages.length-1){ state.pageIndex++; updatePageIndicator(); render(); } };
btnAdd.onclick  = ()=>{ state.pages.splice(state.pageIndex+1,0,newPage()); state.pageIndex++; updatePageIndicator(); render(); };
btnDel.onclick  = ()=>{ if(state.pages.length===1){ alert('ã“ã‚Œä»¥ä¸Šå‰Šé™¤ã§ãã¾ã›ã‚“'); return; }
  state.pages.splice(state.pageIndex,1); state.pageIndex=Math.max(0,state.pageIndex-1); updatePageIndicator(); render(); };

/* =======================
   ä¿å­˜/èª­è¾¼ãƒ»PNG/å°åˆ·ãƒ»å…±æœ‰
======================= */
btnSave.onclick = ()=>{
  const json = JSON.stringify({ bgColor:state.bgColor, guide:state.guide, pages:state.pages.map(p=>({strokes:p.strokes,texts:p.texts})) }, null, 2);
  const blob = new Blob([json], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='note-link.json'; a.click();
  URL.revokeObjectURL(url);
};
btnLoad.onclick = ()=> fileLoad.click();
fileLoad.onchange = async e=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try{
    const data = JSON.parse(txt);
    state.bgColor = data.bgColor || state.bgColor;
    state.guide = Object.assign(state.guide, data.guide||{});
    state.pages = (data.pages||[]).map(p=>({ strokes:p.strokes||[], texts:p.texts||[], bg:null, bgBitmap:null, bgSize:{w:0,h:0} }));
    state.pageIndex = 0; updatePageIndicator(); render();
  }catch(err){ alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
  fileLoad.value='';
};

async function exportPNG(){
  const r = canvas.getBoundingClientRect();
  const w = Math.floor(r.width), h = Math.floor(r.height);
  const off = document.createElement('canvas');
  off.width = Math.round(w * dpr); off.height = Math.round(h * dpr);
  const octx = off.getContext('2d'); octx.scale(dpr, dpr);

  // èƒŒæ™¯è‰²ãƒ»èƒŒæ™¯ç”»åƒ
  octx.fillStyle = state.bgColor; octx.fillRect(0,0,w,h);
  const page = state.pages[state.pageIndex];
  if(page.bgBitmap){ octx.drawImage(page.bgBitmap,0,0); }

  if(state.guide.includeExport) drawGuide(octx);
  for(const s of page.strokes) drawStroke(octx,s);
  drawTexts(octx);

  const url = off.toDataURL('image/png');
  const a = document.createElement('a'); a.href = url; a.download = `note-page-${state.pageIndex+1}.png`; a.click();
}
btnExportPng.onclick = exportPNG;

btnPrint.onclick = ()=> window.print();

btnShare.onclick = async ()=>{
  const shareUrl = location.href;
  if(navigator.share){
    try{ await navigator.share({ title:'Note Link', url:shareUrl }); return; }catch{}
  }
  try{
    await navigator.clipboard.writeText(shareUrl);
    alert('URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
  }catch{
    prompt('å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼š', shareUrl);
  }
};

/* æ•™å¸«ãƒ¢ãƒ¼ãƒ‰ï¼ˆç·¨é›†ä¸å¯ãƒˆã‚°ãƒ«ï¼‰ */
btnTeacher.onclick = ()=>{
  state.teacher = !state.teacher;
  btnTeacher.textContent = state.teacher? 'æ•™å¸«ãƒ¢ãƒ¼ãƒ‰(é–²è¦§å°‚ç”¨)' : 'æ•™å¸«ãƒ¢ãƒ¼ãƒ‰';
};

/* =======================
   Homeï¼ˆå…¥å£ï¼‰
======================= */
let showHomeOnStart = false; // â†å¿…è¦æ™‚ã« true ã¸
const homeModal = document.getElementById('homeModal');
const openHome = ()=> homeModal.style.display='block';
const closeHome= ()=> homeModal.style.display='none';
document.getElementById('homeNew').onclick    = ()=>{ state.pages=[newPage()]; state.pageIndex=0; closeHome(); render(); updatePageIndicator(); };
document.getElementById('homeOpen').onclick   = ()=> alert('éå»ãƒãƒ¼ãƒˆã¯æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã§');
document.getElementById('homeAssign').onclick = ()=> alert('å…ˆç”Ÿã®èª²é¡Œã¯æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã§');
document.getElementById('homeBooks').onclick  = ()=> alert('å•é¡Œé›†ã¯æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã§');
document.getElementById('homeTrash').onclick  = ()=> alert('ã‚´ãƒŸç®±ã¯æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã§');
document.getElementById('homeClose').onclick  = closeHome;
if(showHomeOnStart) openHome();
</script>
</body>
</html>
