<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Note Link mini</title>
  <link rel="stylesheet" href="note-link-ui.css?v=0.6.9-fix8">
</head>
<body>
  <header class="topbar">
    <div class="brand">Note Link <span id="ver">v0.6.9-fix8 / No.13</span></div>
    <div class="actions">
      <button id="btnPrint" class="btn">印刷</button>
      <button id="btnPng" class="btn">PNG</button>
      <button id="btnShare" class="btn">共有</button>
    </div>
  </header>

  <div id="wrap">
    <!-- 左ツールバー -->
    <aside id="sidebar" data-collapsed="0" aria-label="ツールバー">
      <!-- 上に畳む：中抜き△（SVG） -->
      <button class="tool-btn ghost fold" id="btnCollapseUp" title="ツールバーを折りたたむ（上）" aria-expanded="true" aria-controls="sidebar">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <!-- 中抜き三角形 -->
          <polygon points="12,5 21,19 3,19" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </svg>
      </button>

      <button class="tool-btn" data-tool="pen" id="tool-pen" title="ペン">
        <svg viewBox="0 0 24 24"><path d="M4 20l5-1 10-10-4-4L5 15 4 20zM14 6l4 4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <button class="tool-btn" data-tool="marker" id="tool-marker" title="蛍光ペン">
        <svg viewBox="0 0 24 24"><path d="M3 17l4 4 4-4 7-7-4-4-7 7-4 4zM7 21l2-2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <button class="tool-btn" data-tool="eraser" id="tool-eraser" title="消しゴム">
        <svg viewBox="0 0 24 24"><path d="M3 16l6 5h5l7-7-8-8-10 10zM9 21h5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <button class="tool-btn" data-tool="hand" id="tool-hand" title="移動（ドラッグ）">
        <svg viewBox="0 0 24 24"><path d="M6 11v2a6 6 0 0012 0v-4M6 11V7a2 2 0 014 0v4M10 7a2 2 0 114 0v4M14 7a2 2 0 114 0v4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <button class="tool-btn" data-tool="text" id="tool-text" title="テキスト">
        <svg viewBox="0 0 24 24"><path d="M4 6h16M8 6v12M16 6v12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>

      <div class="fill"></div>

      <button class="tool-btn gear" id="btnSettings" title="選択ツールの設定（S キーでも開閉）" aria-controls="settingsPanel">
        <svg viewBox="0 0 24 24"><path d="M12 8a4 4 0 100 8 4 4 0 000-8zm8 4l2-1-2-4-2 1a7.7 7.7 0 00-2-1l-1-2H9l-1 2a7.7 7.7 0 00-2 1L4 7 2 11l2 1a7.7 7.7 0 000 2l-2 1 2 4 2-1a7.7 7.7 0 002 1l1 2h6l1-2a7.7 7.7 0 002-1l2 1 2-4-2-1a7.7 7.7 0 000-2z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
      </button>
    </aside>

    <main id="stage" tabindex="-1">
      <!-- 畳み時だけ出る“▽” -->
      <button id="btnExpandDown" class="collapse-fab" title="ツールバーを開く（下）" hidden>▽</button>

      <canvas id="canvas"></canvas>

      <!-- 設定パネル -->
      <div id="settingsPanel" hidden>
        <div class="panel-head">
          <div id="panelTitle">設定</div>
          <button id="panelClose" class="btn small">閉じる</button>
        </div>
        <div id="panelBody">
          <div class="pane" data-for="pen" hidden>
            <label>色 <input type="color" id="penColor" value="#66ffcc"></label>
            <label>太さ <input type="range" id="penSize" min="1" max="24" value="3"></label>
            <label>不透明度 <input type="range" id="penAlpha" min="0" max="1" step="0.05" value="1"></label>
            <p class="hint">Shiftで直線（15°刻み）</p>
          </div>

          <div class="pane" data-for="marker" hidden>
            <label>色 <input type="color" id="mkColor" value="#00ff88"></label>
            <label>太さ <input type="range" id="mkSize" min="6" max="48" value="16"></label>
            <label>不透明度 <input type="range" id="mkAlpha" min="0" max="1" step="0.05" value="0.35"></label>
            <p class="hint">Shiftで直線（15°刻み）</p>
          </div>

          <div class="pane" data-for="eraser" hidden>
            <label>消し範囲 <input type="range" id="erSize" min="8" max="60" value="28"></label>
            <button id="btnClearAll" class="btn danger">全面消去</button>
          </div>

          <div class="pane" data-for="text" hidden>
            <label>文字サイズ <input type="range" id="txSize" min="12" max="96" value="28"></label>
            <button id="btnAddText" class="btn">テキストを追加</button>
          </div>

          <div class="pane" data-for="hand" hidden>
            <p class="hint">ドラッグで画面移動、ダブルクリックで原点へ。</p>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
const appVersion = 'v0.6.9-fix8';
document.getElementById('ver').textContent = appVersion + ' / No.13';

const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

/* ===== 折りたたみ（上へ） ===== */
const sidebar = $('#sidebar');
const btnUp   = $('#btnCollapseUp');   // △（中抜き）
const btnDown = $('#btnExpandDown');   // ▽
function applySidebar(collapsed){
  sidebar.setAttribute('data-collapsed', collapsed ? '1':'0');
  document.documentElement.style.setProperty('--sbw', collapsed ? '0px':'56px');
  btnUp.setAttribute('aria-expanded', (!collapsed).toString());
  btnDown.hidden = !collapsed;
}
btnUp.addEventListener('click', ()=>applySidebar(true));
btnDown.addEventListener('click', ()=>applySidebar(false));
applySidebar(false);

/* ===== Canvas ===== */
const canvas = $('#canvas');
const ctx = canvas.getContext('2d');
const BG = '#0b1020';
function fitCanvas(){
  const r = window.devicePixelRatio || 1;
  canvas.width  = Math.floor(canvas.clientWidth  * r);
  canvas.height = Math.floor(canvas.clientHeight * r);
  ctx.setTransform(r,0,0,r,0,0);
  ctx.fillStyle = BG; ctx.fillRect(0,0,canvas.width,canvas.height);
}
new ResizeObserver(fitCanvas).observe(canvas);
setTimeout(fitCanvas,0);

/* ===== ツール & 設定パネル ===== */
let tool = 'pen';
const toolBtns = $$('#sidebar .tool-btn[data-tool]');
const settingsBtn   = $('#btnSettings');
const settingsPanel = $('#settingsPanel');
const panelClose    = $('#panelClose');

function showPanelFor(which, {forceOpen=false} = {}){
  $('#panelTitle').textContent =
    {pen:'ペン設定', marker:'蛍光ペン設定', eraser:'消しゴム設定', text:'テキスト設定', hand:'移動'}[which] || '設定';
  $$('#panelBody .pane').forEach(p=>p.hidden = (p.dataset.for !== which));
  if (settingsPanel.hidden || forceOpen){
    settingsPanel.hidden = false;
    settingsBtn.classList.add('settings-on');
  }
}
function hidePanel(){
  settingsPanel.hidden = true;
  settingsBtn.classList.remove('settings-on');
}
function setTool(t){
  tool = t;
  toolBtns.forEach(b=>{
    const on = b.dataset.tool === t;
    b.classList.toggle('active', on);
    b.setAttribute('aria-pressed', on ? 'true':'false');
  });
  // ★ ツール切替ごとに必ず設定を開く
  showPanelFor(t, {forceOpen:true});
}

toolBtns.forEach(b=>b.addEventListener('click', ()=>setTool(b.dataset.tool)));
settingsBtn.addEventListener('click', ()=>{
  if (settingsPanel.hidden){ showPanelFor(tool, {forceOpen:true}); }
  else { hidePanel(); }
});
panelClose.addEventListener('click', hidePanel);
/* Sキー開閉 */
window.addEventListener('keydown', (e)=>{
  if (e.key.toLowerCase()==='s'){ e.preventDefault(); settingsBtn.click(); }
});

setTool('pen'); // 初期化

/* ===== パラメータ ===== */
const state = {
  pen:    { color:'#66ffcc', size:3,  alpha:1 },
  marker: { color:'#00ff88', size:16, alpha:0.35 },
  eraser: { size:28 },
  text:   { size:28 },
};
$('#penColor').addEventListener('input', e=>state.pen.color=e.target.value);
$('#penSize').addEventListener('input', e=>state.pen.size=+e.target.value);
$('#penAlpha').addEventListener('input', e=>state.pen.alpha=+e.target.value);
$('#mkColor').addEventListener('input', e=>state.marker.color=e.target.value);
$('#mkSize').addEventListener('input', e=>state.marker.size=+e.target.value);
$('#mkAlpha').addEventListener('input', e=>state.marker.alpha=+e.target.value);
$('#erSize').addEventListener('input', e=>state.eraser.size=+e.target.value);

/* ===== 描画 ===== */
let drawing=false, last=null;
function snap(dx,dy){ const a=Math.atan2(dy,dx), step=Math.PI/12, A=Math.round(a/step)*step, L=Math.hypot(dx,dy); return {dx:Math.cos(A)*L, dy:Math.sin(A)*L}; }
canvas.addEventListener('pointerdown', e=>{ canvas.setPointerCapture(e.pointerId); drawing=true; last={x:e.offsetX,y:e.offsetY}; });
canvas.addEventListener('pointermove', e=>{
  if (!drawing) return;
  let x=e.offsetX, y=e.offsetY, dx=x-last.x, dy=y-last.y;
  ctx.save();
  if (e.shiftKey){ const s=snap(dx,dy); dx=s.dx; dy=s.dy; }
  if (tool==='pen' || tool==='marker'){
    const st = state[tool];
    ctx.globalAlpha = st.alpha;
    ctx.strokeStyle = st.color;
    ctx.lineWidth   = st.size;
    ctx.lineCap='round'; ctx.lineJoin='round';
    ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(last.x+dx,last.y+dy); ctx.stroke();
    ctx.globalAlpha = 1;
  }else if(tool==='eraser'){
    ctx.globalCompositeOperation='destination-out';
    ctx.beginPath(); ctx.arc(x,y,state.eraser.size/2,0,Math.PI*2); ctx.fill();
    ctx.globalCompositeOperation='source-over';
  }
  ctx.restore();
  last={x:last.x+dx, y:last.y+dy};
});
canvas.addEventListener('pointerup', ()=>{ drawing=false; });

/* ===== 便利系 ===== */
$('#btnClearAll').addEventListener('click', ()=>{
  ctx.save(); ctx.setTransform(1,0,0,1,0,0);
  ctx.fillStyle = BG; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.restore();
});
$('#txSize').addEventListener('input', e=>state.text.size=+e.target.value);
$('#btnAddText').addEventListener('click', ()=>{
  const s = prompt('テキストを入力'); if (!s) return;
  ctx.save(); ctx.fillStyle='#dfe7ef';
  ctx.font = `${state.text.size}px system-ui, -apple-system, Segoe UI, Roboto, Meiryo, sans-serif`;
  ctx.fillText(s, 80, 120); ctx.restore();
});
/* 上部ボタン */
$('#btnPrint').addEventListener('click', ()=>window.print());
$('#btnPng').addEventListener('click', ()=>{
  const out=document.createElement('canvas'); out.width=canvas.width; out.height=canvas.height;
  const o=out.getContext('2d'); o.fillStyle=BG; o.fillRect(0,0,out.width,out.height); o.drawImage(canvas,0,0);
  const a=document.createElement('a'); a.href=out.toDataURL('image/png'); a.download=`note-${Date.now()}.png`; a.click();
});
$('#btnShare').addEventListener('click', async ()=>{
  const url = location.origin + location.pathname + '?v=' + encodeURIComponent(appVersion) + '&cb=' + Date.now();
  try{
    if (navigator.share) await navigator.share({title:'Note Link', text:'Note Link を共有', url});
    else if (navigator.clipboard){ await navigator.clipboard.writeText(url); alert('URLをコピーしました'); }
    else { prompt('このURLをコピーしてください', url); }
  }catch(e){}
});
</script>
</body>
</html>
