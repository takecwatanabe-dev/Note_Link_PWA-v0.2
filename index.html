<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Note Link v0.6.5 (No.7)</title>
<style>
  :root{
    --bg:#0b1220; --panel:#111827; --ink:#e5e7eb; --muted:#334155; --accent:#4ade80;
    --btn:#0f172a; --btn2:#0b1220;
    --h:44px;           /* 上部バー高さ */
    --tbw:56px;         /* ツールボタン辺 */
    --gap:8px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;
    overflow:hidden;
  }

  /* 上部メインバー：縦位置がズレないようにflex中央揃え */
  header{
    height:var(--h); display:flex; align-items:center; gap:10px;
    padding:0 10px; background:var(--panel); border-bottom:1px solid var(--muted);
    user-select:none;
  }
  .brand{display:flex; align-items:center; gap:8px; font-weight:700}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent)}
  .ver{font-size:12px;padding:2px 8px;border:1px solid var(--muted);border-radius:999px;opacity:.85}

  .actions{display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-left:auto}
  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    height:32px; min-width:32px; padding:0 10px; border-radius:10px;
    background:var(--btn2); color:var(--ink); border:1px solid var(--muted);
    cursor:pointer; line-height:1; white-space:nowrap;
  }
  .btn:hover{border-color:var(--accent)}
  .btn.icon{width:32px; padding:0}

  /* レイアウト */
  .wrap{height:calc(100% - var(--h)); display:grid; grid-template-columns: 64px 1fr}
  .sidebar{
    position:relative; background:var(--panel); border-right:1px solid var(--muted);
    padding:6px 8px; overflow:auto;
  }
  /* △▽ボタン：ツールと同サイズで、ペンの“上”に固定 */
  .foldToggle{
    position:sticky; top:6px; left:0;
    width:var(--tbw); height:var(--tbw); display:grid; place-items:center;
    border:1px solid var(--muted); border-radius:12px; background:var(--btn);
    margin-bottom:var(--gap); cursor:pointer; user-select:none;
    z-index:2;
  }
  .sidebar.folded .tools{max-height:0; overflow:hidden}
  .tools{display:flex; flex-direction:column; gap:var(--gap)}

  .tool{
    width:var(--tbw); height:var(--tbw); display:grid; place-items:center;
    border:1px solid var(--muted); border-radius:12px; background:var(--btn);
    cursor:pointer; position:relative; user-select:none;
  }
  .tool.active{outline:2px solid var(--accent)}
  .label{position:absolute; left:calc(100% + 6px); top:50%; transform:translateY(-50%);
    font-size:11px; opacity:.85}

  .stage{position:relative; background:var(--bg)}
  canvas{
    display:block; width:100%; height:100%;
    background:transparent;
    /* ★ 指で連続描画できるように：スクロール禁止 */
    touch-action:none;
  }

  /* 設定パネル（各ツールの設定） */
  .panel{
    position:absolute; top:90px; left:90px; width:360px; max-width:90vw;
    background:#121a2a; border:1px solid var(--muted); border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.45); padding:12px;
  }
  .panel h3{margin:4px 0 10px; font-size:16px}
  .row{display:flex; align-items:center; gap:8px; margin:10px 0; flex-wrap:wrap}
  .row input[type=range]{width:160px}
  .panel .close{margin-left:auto}

  /* ホーム画面（ノートの入口） */
  .home{
    position:absolute; inset:0; background:rgba(11,18,32,.96);
    display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .homeCard{
    width:min(980px,96vw); background:#0f1626; border:1px solid var(--muted); border-radius:16px; padding:16px;
  }
  .homeTitle{font-size:20px; font-weight:700; margin-bottom:12px}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px}
  .homeBtn{padding:14px 12px; border-radius:12px; border:1px solid var(--muted); background:#0b1220; cursor:pointer}
  .homeBtn:hover{border-color:var(--accent)}

  /* 共有メニューの簡易モーダル */
  .shareModal{position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45)}
  .shareBox{background:#0f1626; border:1px solid var(--muted); border-radius:12px; padding:12px; width:min(420px,92vw)}

  /* 細かなチューニング */
  .hint{font-size:12px; opacity:.75}
</style>
</head>
<body>

<header>
  <div class="brand">
    <span class="dot"></span> Note Link <span class="ver" id="verLabel">v0.6.5 / No.7</span>
  </div>
  <div class="actions">
    <button class="btn icon" id="btnUndo" title="元に戻す">↶</button>
    <button class="btn icon" id="btnRedo" title="やり直す">↷</button>
    <button class="btn" id="btnPrint" title="印刷（ブラウザの印刷）">印刷</button>
    <button class="btn" id="btnExportPng" title="PNG書き出し">PNG</button>
    <button class="btn" id="btnSave" title="保存（JSON）">保存(JSON)</button>
    <button class="btn" id="btnLoad" title="読込（JSON）">読込(JSON)</button>
    <button class="btn" id="btnShare" title="共有リンク">共有</button>
    <button class="btn" id="btnTeacher" title="編集禁止切替">教師モード</button>
  </div>
</header>

<div class="wrap">
  <aside class="sidebar" id="sidebar">
    <!-- △▽：ペンの“上”に設置、サイズはツールと同じ -->
    <div class="foldToggle" id="foldToggle" title="ツールバーの開閉">▽</div>

    <div class="tools" id="tools">
      <div class="tool active" id="tool-pen" title="ペン">✎<span class="label">ペン</span></div>
      <div class="tool" id="tool-hl"  title="蛍光ペン">🖍<span class="label">蛍光</span></div>
      <div class="tool" id="tool-eraser" title="消しゴム">⌫<span class="label">消</span></div>
      <div class="tool" id="tool-move" title="移動/ズーム">🖐<span class="label">移動</span></div>
      <div class="tool" id="tool-text" title="テキスト">⌨<span class="label">テキスト</span></div>
      <div class="tool" id="tool-settings" title="設定">⚙<span class="label">設定</span></div>
    </div>
  </aside>

  <main class="stage" id="stage">
    <canvas id="canvas"></canvas>

    <!-- 設定パネル（ツール切替時は自動で閉じる） -->
    <div class="panel" id="panel" style="display:none">
      <div class="row"><h3 id="panelTitle">設定</h3><button class="btn close" id="panelClose">閉じる</button></div>
      <div id="panelBody"></div>
      <div class="hint" id="panelHint"></div>
    </div>

    <!-- ホーム（ノート入口） -->
    <div class="home" id="home" style="display:none">
      <div class="homeCard">
        <div class="homeTitle">ノートを選択</div>
        <div class="grid">
          <button class="homeBtn" id="homeNew">① 新しいノートを作成</button>
          <button class="homeBtn" id="homeOpen">② 過去のノートを開く</button>
          <button class="homeBtn" id="homeAssign">③ 先生の課題を読み込む（PDF/画像）</button>
          <button class="homeBtn" id="homeBook">④ 問題集を読み込む（PDF/画像）</button>
          <button class="homeBtn" id="homeTrash">⑤ ゴミ箱</button>
        </div>
        <div class="hint" style="margin-top:8px">※ ノートは端末内に保存（localStorage）。将来はクラウド同期に対応予定。</div>
      </div>
    </div>

    <!-- 共有モーダル -->
    <div class="shareModal" id="shareModal">
      <div class="shareBox">
        <div class="row"><strong>共有</strong><button class="btn close" id="shareClose">閉じる</button></div>
        <div class="row">
          <input id="shareUrl" class="btn" style="flex:1; text-align:left" readonly>
          <button class="btn" id="shareCopy">コピー</button>
          <button class="btn" id="shareNative">シェア</button>
        </div>
        <div class="hint">※ PWAは端末内保存のため、ノート本体を共有したい時は「保存(JSON)」で書き出し→相手は「読込(JSON)」で取り込みます。</div>
      </div>
    </div>

    <input type="file" id="fileJson" accept="application/json" hidden>
    <input type="file" id="filePdf" accept="application/pdf,image/*" hidden>
  </main>
</div>

<script>
/* =============================
   バージョン/ナンバリング（自動繰り上げの土台）
   ============================= */
const VERSION_BASE = 'v0.6.5';
const RUN_KEY = 'note-link-run-no';
const prev = parseInt(localStorage.getItem(RUN_KEY)||'6',10); // 前回No.6想定
const RUN_NO = prev + 1; // 自動で No.+1
localStorage.setItem(RUN_KEY, String(RUN_NO));
document.getElementById('verLabel').textContent = `${VERSION_BASE} / No.${RUN_NO}`;

/* =============================
   状態
   ============================= */
const state = {
  mode:'draw', // draw|hl|eraser|move|text|settings
  teacher:false,
  pen:{color:'#fffae6', size:3, alpha:1, fingerOK:true}, // fingerOK: 指入力可
  hl:{color:'#ffff66', size:16, alpha:0.35},
  eraser:{radius:22, mode:'partial'}, // partial|pageClear|allClear
  view:{scale:1, x:0, y:0, min:0.5, max:6},
  pages:[{strokes:[], texts:[]}],
  pageIndex:0,
  stroke:null,
  autosaveTimer:null,
  currentNoteId:null
};
const STORAGE_KEY = 'note-link-v065-autosave';
const NOTE_INDEX_KEY = 'note-link-notes-index'; // 複数ノート管理

/* =============================
   要素参照
   ============================= */
const canvas = document.getElementById('canvas');
const stage  = document.getElementById('stage');
const ctx = canvas.getContext('2d');
const dpr = Math.max(1, window.devicePixelRatio||1);

function resizeCanvas(){
  const r = stage.getBoundingClientRect();
  canvas.width = Math.floor(r.width * dpr);
  canvas.height= Math.floor((r.height) * dpr);
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr,dpr);
  render();
}
addEventListener('resize', resizeCanvas);

/* =============================
   ツールバー開閉（△▽）
   ============================= */
const sidebar = document.getElementById('sidebar');
const foldToggle = document.getElementById('foldToggle');
foldToggle.addEventListener('click', ()=>{
  sidebar.classList.toggle('folded');
  foldToggle.textContent = sidebar.classList.contains('folded') ? '△' : '▽';
});

/* =============================
   ツール切替（切替時に設定パネルは閉じる）
   ============================= */
const panel = document.getElementById('panel');
const panelTitle = document.getElementById('panelTitle');
const panelBody = document.getElementById('panelBody');
const panelHint = document.getElementById('panelHint');
document.getElementById('panelClose').onclick = ()=> panel.style.display='none';

function setMode(m){
  state.mode=m;
  // ボタン見た目
  document.querySelectorAll('.tool').forEach(t=>t.classList.remove('active'));
  document.getElementById('tool-'+(m==='draw'?'pen':m)).classList.add('active');
  // 設定パネルは一度閉じる
  panel.style.display='none';
}

document.getElementById('tool-pen').onclick = ()=> setMode('draw');
document.getElementById('tool-hl').onclick  = ()=> setMode('hl');
document.getElementById('tool-eraser').onclick = ()=> setMode('eraser');
document.getElementById('tool-move').onclick = ()=> setMode('move');
document.getElementById('tool-text').onclick = ()=> setMode('text');
document.getElementById('tool-settings').onclick = ()=> { setMode('settings'); openSettings(); };

/* =============================
   設定パネル
   ============================= */
function openSettings(){
  panelTitle.textContent = '設定';
  panelBody.innerHTML = '';
  const sec = document.createElement('div');

  // ペン
  sec.innerHTML += `<h4>ペン</h4>
  <div class="row"><label>色</label><input type="color" id="penColor" value="${state.pen.color}"></div>
  <div class="row"><label>太さ</label><input type="range" id="penSize" min="1" max="36" value="${state.pen.size}"><span>${state.pen.size}</span></div>
  <div class="row"><label>不透明度</label><input type="range" id="penAlpha" min="0.1" step="0.05" max="1" value="${state.pen.alpha}"><span>${state.pen.alpha}</span></div>
  <div class="row"><label><input type="checkbox" id="penFinger" ${state.pen.fingerOK?'checked':''}> 指入力も許可</label></div>`;

  // 蛍光
  sec.innerHTML += `<h4>蛍光</h4>
  <div class="row"><label>色</label><input type="color" id="hlColor" value="${state.hl.color}"></div>
  <div class="row"><label>太さ</label><input type="range" id="hlSize" min="4" max="80" value="${state.hl.size}"><span>${state.hl.size}</span></div>`;

  // 消しゴム（拡張：全面/ページ）
  sec.innerHTML += `<h4>消しゴム</h4>
  <div class="row"><label>消し範囲</label><input type="range" id="eraserR" min="8" max="60" value="${state.eraser.radius}"><span>${state.eraser.radius}</span></div>
  <div class="row"><label>モード</label>
    <select id="eraserMode">
      <option value="partial" ${state.eraser.mode==='partial'?'selected':''}>部分消し</option>
      <option value="pageClear" ${state.eraser.mode==='pageClear'?'selected':''}>このページを全消去</option>
      <option value="allClear" ${state.eraser.mode==='allClear'?'selected':''}>全ページを全消去</option>
    </select>
    <button class="btn" id="execClear">実行</button>
  </div>`;

  panelBody.appendChild(sec);
  panel.style.display='block';

  // バインド
  const penColor = sec.querySelector('#penColor');
  const penSize  = sec.querySelector('#penSize'); const penSizeV = penSize.nextElementSibling;
  const penAlpha = sec.querySelector('#penAlpha'); const penAlphaV = penAlpha.nextElementSibling;
  const penFinger= sec.querySelector('#penFinger');

  penColor.oninput = ()=>{ state.pen.color = penColor.value; render(); requestAutosave(); };
  penSize.oninput  = ()=>{ state.pen.size = +penSize.value; penSizeV.textContent=penSize.value; render(); requestAutosave(); };
  penAlpha.oninput = ()=>{ state.pen.alpha = +penAlpha.value; penAlphaV.textContent=penAlpha.value; render(); requestAutosave(); };
  penFinger.onchange=()=>{ state.pen.fingerOK = penFinger.checked; };

  const hlColor = sec.querySelector('#hlColor');
  const hlSize  = sec.querySelector('#hlSize'); const hlSizeV = hlSize.nextElementSibling;
  hlColor.oninput= ()=>{ state.hl.color = hlColor.value; render(); requestAutosave(); };
  hlSize.oninput = ()=>{ state.hl.size  = +hlSize.value; hlSizeV.textContent=hlSize.value; render(); requestAutosave(); };

  const erR = sec.querySelector('#eraserR'); const erRV = erR.nextElementSibling;
  const erM = sec.querySelector('#eraserMode');
  const exec= sec.querySelector('#execClear');
  erR.oninput = ()=>{ state.eraser.radius = +erR.value; erRV.textContent = erR.value; };
  erM.onchange= ()=>{ state.eraser.mode = erM.value; };
  exec.onclick  = ()=>{
    if(state.eraser.mode==='pageClear'){
      state.pages[state.pageIndex] = {strokes:[], texts:[]};
    }else if(state.eraser.mode==='allClear'){
      state.pages = [{strokes:[], texts:[]}]; state.pageIndex=0;
    }
    render(); requestAutosave();
    alert('消去しました');
  };

  panelHint.textContent = 'ツールを切り替えると、このパネルは自動的に閉じます。';
}

/* =============================
   描画
   ============================= */
function render(){
  const r = canvas.getBoundingClientRect();
  ctx.clearRect(0,0,r.width,r.height);
  ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg');
  ctx.fillRect(0,0,r.width,r.height);

  ctx.save();
  ctx.translate(state.view.x, state.view.y);
  ctx.scale(state.view.scale, state.view.scale);

  const page = state.pages[state.pageIndex];
  // strokes
  ctx.lineCap='round'; ctx.lineJoin='round';
  for(const s of page.strokes){ drawStroke(s); }
  if(state.stroke) drawStroke(state.stroke);

  // texts（簡易）
  ctx.fillStyle = '#fff';
  for(const t of page.texts){ ctx.font = `${t.size||18}px ${t.font||"sans-serif"}`; ctx.fillText(t.text, t.x, t.y); }

  ctx.restore();
}
function drawStroke(s){
  ctx.globalAlpha = s.alpha;
  ctx.strokeStyle = s.color; ctx.lineWidth = s.size;
  ctx.beginPath();
  const pts = s.points;
  ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=1;i<pts.length;i++){ ctx.lineTo(pts[i].x, pts[i].y); }
  ctx.stroke();
  ctx.globalAlpha = 1;
}

/* =============================
   入力（★ 指で線が引けるように Pointer Events を統一）
   ============================= */
let isDown=false, pointerId=null;

function toCanvasXY(e){
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left - state.view.x) / state.view.scale;
  const y = (e.clientY - rect.top  - state.view.y) / state.view.scale;
  return {x,y};
}

canvas.addEventListener('pointerdown', (e)=>{
  // 教師モードは編集不可
  if(state.teacher) return;
  // 指の入力：許可フラグがfalseなら無視
  if(e.pointerType==='touch' && state.mode!=='move' && !state.pen.fingerOK) return;

  // move以外ではスクロール抑止
  if(state.mode!=='move') e.preventDefault();

  isDown=true; pointerId=e.pointerId; canvas.setPointerCapture(pointerId);

  if(state.mode==='draw' || state.mode==='hl'){
    const p = toCanvasXY(e);
    const base = (state.mode==='draw')? state.pen : state.hl;
    state.stroke = { tool:state.mode, color:base.color, size:base.size, alpha:(state.mode==='draw'?state.pen.alpha:state.hl.alpha), points:[p] };
    render();
  }else if(state.mode==='eraser'){
    // 部分消しは move 中に処理
  }else if(state.mode==='text'){
    const p = toCanvasXY(e);
    const text = prompt('テキストを入力');
    if(text && text.length){
      state.pages[state.pageIndex].texts.push({text, x:p.x, y:p.y, size:18, font:"'Noto Sans JP',sans-serif"});
      render(); requestAutosave();
    }
  }
}, {passive:false});

canvas.addEventListener('pointermove', (e)=>{
  if(!isDown || e.pointerId!==pointerId) return;

  if(state.mode==='draw' || state.mode==='hl'){
    const p = toCanvasXY(e);
    state.stroke.points.push(p);
    render();
  }else if(state.mode==='eraser'){
    const p = toCanvasXY(e);
    const r = state.eraser.radius;
    const page = state.pages[state.pageIndex];
    // ストロークの“近接”で消去（簡易：点との距離）
    page.strokes = page.strokes.filter(s=>{
      return !s.points.some(pt => ((pt.x-p.x)**2 + (pt.y-p.y)**2) <= r*r);
    });
    render();
  }else if(state.mode==='move'){
    // 2本指やペンでもドラッグで平行移動（簡易）
    state.view.x += e.movementX;
    state.view.y += e.movementY;
    render();
  }
}, {passive:false});

canvas.addEventListener('pointerup', (e)=>{
  if(e.pointerId!==pointerId) return;
  isDown=false; canvas.releasePointerCapture(pointerId);
  if(state.stroke){
    state.pages[state.pageIndex].strokes.push(state.stroke);
    state.stroke=null; requestAutosave();
  }
});
canvas.addEventListener('pointercancel', ()=>{ isDown=false; state.stroke=null; });

/* =============================
   保存・読込（端末自動保存 + JSON手動）
   ============================= */
function requestAutosave(){
  clearTimeout(state.autosaveTimer);
  state.autosaveTimer = setTimeout(saveToStorage, 500);
}
function saveToStorage(){
  try{
    const snap = {
      pages: state.pages,
      pageIndex: state.pageIndex,
      view: state.view,
      pen: state.pen, hl: state.hl, eraser: state.eraser
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(snap));
  }catch(e){ console.warn('autosave failed', e); }
}
function loadFromStorage(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return false;
    const snap = JSON.parse(raw);
    state.pages = snap.pages||state.pages;
    state.pageIndex = snap.pageIndex||0;
    state.view = snap.view||state.view;
    state.pen = snap.pen||state.pen;
    state.hl = snap.hl||state.hl;
    state.eraser = snap.eraser||state.eraser;
    return true;
  }catch(e){ return false; }
}
window.addEventListener('beforeunload', saveToStorage);

document.getElementById('btnSave').onclick = ()=>{
  const blob = new Blob([JSON.stringify({pages:state.pages},null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'note-link.json';
  a.click();
};
const fileJson = document.getElementById('fileJson');
document.getElementById('btnLoad').onclick = ()=> fileJson.click();
fileJson.onchange = async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  const data = JSON.parse(txt);
  state.pages = data.pages||[{strokes:[],texts:[]}];
  state.pageIndex = 0;
  render(); requestAutosave();
  fileJson.value='';
};

/* =============================
   PNG & 印刷 & 共有
   ============================= */
document.getElementById('btnExportPng').onclick = ()=>{
  // 背景も含めて出力
  const r = canvas.getBoundingClientRect();
  const out = document.createElement('canvas');
  out.width = r.width; out.height = r.height;
  const oc = out.getContext('2d');
  oc.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg');
  oc.fillRect(0,0,r.width,r.height);
  oc.drawImage(canvas,0,0,r.width,r.height);
  const a = document.createElement('a');
  a.href = out.toDataURL('image/png');
  a.download = 'note-page.png';
  a.click();
};
document.getElementById('btnPrint').onclick = ()=> window.print();

const shareModal = document.getElementById('shareModal');
const shareUrl   = document.getElementById('shareUrl');
document.getElementById('btnShare').onclick = ()=>{
  shareUrl.value = location.href.split('#')[0];
  shareModal.style.display='flex';
};
document.getElementById('shareClose').onclick = ()=> shareModal.style.display='none';
document.getElementById('shareCopy').onclick  = async ()=>{
  try{ await navigator.clipboard.writeText(shareUrl.value); alert('URLをコピーしました'); }catch{}
};
document.getElementById('shareNative').onclick = async ()=>{
  if(navigator.share){
    try{ await navigator.share({title:'Note Link', url:shareUrl.value}); }catch{}
  }else{
    alert('この端末はネイティブ共有に未対応です。コピーをご利用ください。');
  }
};

/* =============================
   教師モード
   ============================= */
const btnTeacher = document.getElementById('btnTeacher');
btnTeacher.onclick = ()=>{
  state.teacher = !state.teacher;
  btnTeacher.textContent = state.teacher? '教師モード（閲覧専用）':'教師モード';
};

/* =============================
   ノート“ホーム” ①〜⑤（最小実装）
   ============================= */
const home = document.getElementById('home');
function showHome(flag){
  home.style.display = flag? 'flex':'none';
}
const notesIndex = JSON.parse(localStorage.getItem(NOTE_INDEX_KEY)||'[]'); // [{id,title,ts}]
function saveNoteToIndex(id,title){
  const now = Date.now();
  const i = notesIndex.findIndex(n=>n.id===id);
  if(i>=0){ notesIndex[i].title=title; notesIndex[i].ts=now; }
  else{ notesIndex.push({id,title,ts:now}); }
  localStorage.setItem(NOTE_INDEX_KEY, JSON.stringify(notesIndex));
}

document.getElementById('homeNew').onclick = ()=>{
  const title = prompt('ノート名'); if(!title) return;
  const id = 'note_'+Date.now();
  state.currentNoteId = id;
  state.pages=[{strokes:[],texts:[]}]; state.pageIndex=0;
  saveNoteToIndex(id,title);
  showHome(false); render(); requestAutosave();
};
document.getElementById('homeOpen').onclick = ()=>{
  if(notesIndex.length===0){ alert('保存済みノートがありません'); return; }
  const list = notesIndex
    .sort((a,b)=>b.ts-a.ts)
    .map((n,i)=>`${i+1}. ${n.title} (${new Date(n.ts).toLocaleString()})`).join('\n');
  const sel = prompt('開く番号を入力：\n'+list);
  const idx = (parseInt(sel||'0',10)-1)|0;
  const n = notesIndex[idx]; if(!n) return;
  state.currentNoteId = n.id;
  // ノート本体は autosave キーにまとめて保存している簡易版
  const ok = loadFromStorage();
  showHome(false); render();
};
document.getElementById('homeAssign').onclick = ()=>{
  document.getElementById('filePdf').click(); // PDF/画像→背景として取り込み想定
};
document.getElementById('homeBook').onclick = ()=>{
  document.getElementById('filePdf').click();
};
document.getElementById('homeTrash').onclick = ()=>{
  alert('ゴミ箱は今は一覧のみ（将来は復元/完全削除に対応）');
};

const filePdf = document.getElementById('filePdf');
filePdf.onchange = async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  if(f.type==='application/pdf'){
    // シンプル：PDFは画像化せず、いったん「読み込みメモ」を追加（将来：pdf.js）
    alert('PDF受信：将来バージョンで各ページを背景化します（v0.7系予定）');
  }else{
    const url = URL.createObjectURL(f);
    const img = new Image();
    img.onload = ()=>{
      const cnv = document.createElement('canvas');
      cnv.width = img.width; cnv.height = img.height;
      cnv.getContext('2d').drawImage(img,0,0);
      const page = state.pages[state.pageIndex];
      // 背景の代わりに一旦画像を1枚貼る：簡易実装
      page.strokes.push({tool:'draw', color:'#ffffff', size:0.0001, alpha:1, points:[{x:0,y:0}]}); // no-op保持
      render(); requestAutosave();
    };
    img.src = url;
  }
  e.target.value='';
};

/* =============================
   初期化
   ============================= */
function init(){
  resizeCanvas();
  // 初回はホーム（ノート選択）を表示、既存データがあれば復元してホーム非表示
  const has = loadFromStorage();
  showHome(!has);
  render();
}
init();
</script>
</body>
</html>
