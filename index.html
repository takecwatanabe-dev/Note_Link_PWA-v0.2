<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Note Link mini</title>
<link rel="stylesheet" href="note-link-ui.css?v=1015">
</head>
<body>
<header class="topbar">
  <div class="brand">Note Link <span id="ver">v0.6.8-fix3 / No.12</span></div>
  <div class="actions">
    <button id="btnPrint" title="印刷">印刷</button>
    <button id="btnPng" title="PNG出力（背景込み）">PNG</button>
    <button id="btnShare" title="共有">共有</button>
  </div>
</header>

<div class="wrap">
  <aside id="sidebar" class="sidebar" data-collapsed="0">
    <button id="btnCollapse" class="caret" aria-label="ツールを折りたたむ">▾</button>

    <button class="tool" data-tool="pen" aria-label="ペン">
      <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
    </button>

    <button class="tool" data-tool="marker" aria-label="蛍光ペン">
      <svg viewBox="0 0 24 24"><path d="M3 16l5-5 5 5-5 5H3v-5zm9.5-7.5l2-2L21 13l-2 2-6.5-6.5z"/></svg>
    </button>

    <button class="tool" data-tool="eraser" aria-label="消しゴム">
      <svg viewBox="0 0 24 24"><path d="M16.24 3.56a2 2 0 0 1 2.83 0l1.37 1.37a2 2 0 0 1 0 2.83L12.4 15.8a2 2 0 0 1-1.41.59H7.05a2 2 0 0 1-1.41-.59l-1.37-1.37a2 2 0 0 1 0-2.83L16.24 3.56zM7 18h10v2H7z"/></svg>
    </button>

    <button class="tool" data-tool="hand" aria-label="移動">
      <svg viewBox="0 0 24 24"><path d="M12 2a2 2 0 0 1 2 2v6h1V3a2 2 0 1 1 4 0v8h1V6a2 2 0 1 1 4 0v9a5 5 0 0 1-5 5h-3l-3 3-3-3H8a6 6 0 0 1-6-6V9a2 2 0 1 1 4 0v5h1V4a2 2 0 1 1 4 0v6h1V4a2 2 0 0 1 2-2z"/></svg>
    </button>

    <button class="tool" data-tool="text" aria-label="テキスト">
      <svg viewBox="0 0 24 24"><path d="M5 4h14v3h-5v13h-4V7H5z"/></svg>
    </button>

    <button id="btnSettings" class="tool plain" aria-label="設定">⚙</button>
  </aside>

  <main class="stage">
    <canvas id="board"></canvas>

    <!-- ツール別設定パネル（選んだツールだけが出る） -->
    <div id="panel-pen" class="panel">
      <div class="panel-title">ペン設定</div>
      <label>色 <input id="penColor" type="color" value="#fffbe6"></label>
      <label>太さ <input id="penSize" type="range" min="1" max="24" value="3"></label>
      <label>不透明度 <input id="penAlpha" type="range" min="0.1" max="1" step="0.05" value="1"></label>
      <div class="hint">Shiftで直線（15°刻み）</div>
      <button class="close">閉じる</button>
    </div>

    <div id="panel-marker" class="panel">
      <div class="panel-title">蛍光ペン設定</div>
      <label>色 <input id="mkColor" type="color" value="#ffe36b"></label>
      <label>太さ <input id="mkSize" type="range" min="8" max="48" value="24"></label>
      <div class="subhint">描画時は自動で不透明度0.35固定</div>
      <div class="hint">Shiftで直線（15°刻み）</div>
      <button class="close">閉じる</button>
    </div>

    <div id="panel-eraser" class="panel">
      <div class="panel-title">消しゴム設定</div>
      <label>消し範囲 <input id="erSize" type="range" min="8" max="48" value="28"></label>
      <div class="row">
        <button id="btnClearAll" class="danger">全面消去</button>
      </div>
      <button class="close">閉じる</button>
    </div>
  </main>
</div>

<script>
const APP_VER = 'v0.6.8-fix3 / No.12';
document.getElementById('ver').textContent = APP_VER;

// ====== Canvas 基本 ======
const canvas = document.getElementById('board');
const ctx = canvas.getContext('2d');
const DPR = Math.max(1, window.devicePixelRatio || 1);
function fitCanvas(){
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.floor(rect.width * DPR);
  canvas.height = Math.floor(rect.height * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
  drawBackground();
}
function drawBackground(){
  ctx.save();
  ctx.fillStyle = '#0b1022';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.restore();
}
window.addEventListener('resize', fitCanvas);
fitCanvas();

// ====== 状態管理 ======
let tool = 'pen';
let drawing = false;
let points = [];
let anchor = null;
const state = {
  pen:   { color:'#fffbe6', size:3, alpha:1 },
  marker:{ color:'#ffe36b', size:24, alpha:0.35 },
  eraser:{ size:28 }
};

// ====== ツールUI ======
const sidebar = document.getElementById('sidebar');
const caretBtn = document.getElementById('btnCollapse');
caretBtn.onclick = () => {
  const c = sidebar.getAttribute('data-collapsed') === '1' ? '0' : '1';
  sidebar.setAttribute('data-collapsed', c);
};
for (const b of document.querySelectorAll('.tool[data-tool]')){
  b.addEventListener('click', () => activateTool(b.dataset.tool));
}
function activateTool(name){
  tool = name;
  document.querySelectorAll('.tool').forEach(el => el.classList.toggle('active', el.dataset.tool===name));
  // 設定パネル切替
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('show'));
  const panel = document.getElementById(`panel-${name}`);
  if(panel) panel.classList.add('show');
}
document.querySelectorAll('.panel .close').forEach(btn=>{
  btn.addEventListener('click', e => e.currentTarget.closest('.panel').classList.remove('show'));
});
activateTool('pen');

// ====== 設定反映 ======
const penColor = document.getElementById('penColor');
const penSize  = document.getElementById('penSize');
const penAlpha = document.getElementById('penAlpha');
[penColor,penSize,penAlpha].forEach(el=> el.addEventListener('input', ()=>{
  state.pen.color = penColor.value;
  state.pen.size  = +penSize.value;
  state.pen.alpha = +penAlpha.value;
}));
const mkColor = document.getElementById('mkColor');
const mkSize  = document.getElementById('mkSize');
[mkColor,mkSize].forEach(el=> el.addEventListener('input', ()=>{
  state.marker.color = mkColor.value;
  state.marker.size  = +mkSize.value;
}));
const erSize = document.getElementById('erSize');
erSize.addEventListener('input', ()=> state.eraser.size = +erSize.value);

document.getElementById('btnClearAll').onclick = ()=>{
  if(confirm('全面消去しますか？')) { fitCanvas(); }
};

// ====== 描画処理 ======
function strokeStyleFor(toolName){
  if(toolName==='pen'){
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = hexWithAlpha(state.pen.color, state.pen.alpha);
    ctx.lineWidth = state.pen.size;
    ctx.lineCap = ctx.lineJoin = 'round';
  } else if(toolName==='marker'){
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = hexWithAlpha(state.marker.color, state.marker.alpha);
    ctx.lineWidth = state.marker.size;
    ctx.lineCap = ctx.lineJoin = 'round';
  } else if(toolName==='eraser'){
    ctx.globalCompositeOperation = 'destination-out';
    ctx.strokeStyle = 'rgba(0,0,0,1)';
    ctx.lineWidth = state.eraser.size;
    ctx.lineCap = ctx.lineJoin = 'round';
  }
}
function hexWithAlpha(hex, a){
  const c = hex.replace('#','');
  const r = parseInt(c.substring(0,2),16);
  const g = parseInt(c.substring(2,4),16);
  const b = parseInt(c.substring(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}

// 角度スナップ（15度）
const STEP = Math.PI/12; // 15°
function snapPoint(ax, ay, x, y){
  const dx = x-ax, dy = y-ay;
  const len = Math.hypot(dx,dy);
  if(len===0) return {x, y};
  let ang = Math.atan2(dy,dx);
  ang = Math.round(ang/STEP)*STEP;
  return { x: ax + Math.cos(ang)*len, y: ay + Math.sin(ang)*len };
}

function pos(e){
  const r = canvas.getBoundingClientRect();
  const x = (e.touches? e.touches[0].clientX : e.clientX) - r.left;
  const y = (e.touches? e.touches[0].clientY : e.clientY) - r.top;
  return {x,y};
}

function pointerDown(e){
  if(tool==='hand'){ return; }
  drawing = true;
  const p = pos(e);
  points = [p];
  anchor = p;
  strokeStyleFor(tool);
  ctx.beginPath();
  ctx.moveTo(p.x,p.y);
  e.preventDefault();
}
function pointerMove(e){
  if(!drawing) return;
  let p = pos(e);
  if(e.shiftKey && (tool==='pen' || tool==='marker')){
    p = snapPoint(anchor.x, anchor.y, p.x, p.y);
  }
  points.push(p);
  ctx.lineTo(p.x,p.y);
  ctx.stroke();
  e.preventDefault();
}
function pointerUp(e){
  if(!drawing) return;
  drawing = false;
  e.preventDefault();
}
['mousedown','touchstart'].forEach(t=>canvas.addEventListener(t,pointerDown,{passive:false}));
['mousemove','touchmove'].forEach(t=>canvas.addEventListener(t,pointerMove,{passive:false}));
['mouseup','mouseleave','touchend','touchcancel'].forEach(t=>canvas.addEventListener(t,pointerUp,{passive:false}));

// ====== 上部メニュー ======
document.getElementById('btnPrint').onclick = ()=> window.print();

document.getElementById('btnPng').onclick = ()=>{
  // 背景込みPNG
  const out = document.createElement('canvas');
  out.width = canvas.width; out.height = canvas.height;
  const octx = out.getContext('2d');
  octx.fillStyle = '#0b1022';
  octx.fillRect(0,0,out.width,out.height);
  octx.drawImage(canvas,0,0);
  const url = out.toDataURL('image/png');
  const a = document.createElement('a');
  a.href = url; a.download = 'note-page.png';
  a.click();
};

document.getElementById('btnShare').onclick = async ()=>{
  try{
    const blob = await new Promise(res=> outCanvasBlob(res));
    if(navigator.canShare && navigator.canShare({files:[new File([blob],'note.png',{type:'image/png'})]})){
      await navigator.share({ files:[new File([blob],'note.png',{type:'image/png'})], title:'Note Link', text:APP_VER });
    }else{
      const url = URL.createObjectURL(blob);
      await navigator.clipboard.writeText(url);
      alert('共有に未対応のため、一時URLをクリップボードにコピーしました。');
    }
  }catch(err){
    alert('共有に失敗しました');
  }
};
function outCanvasBlob(cb){
  const out = document.createElement('canvas');
  out.width = canvas.width; out.height = canvas.height;
  const octx = out.getContext('2d');
  octx.fillStyle = '#0b1022';
  octx.fillRect(0,0,out.width,out.height);
  octx.drawImage(canvas,0,0);
  out.toBlob(cb,'image/png',1);
}

// PWA（SW）なしで動作させる：何も登録しない
</script>
</body>
</html>
