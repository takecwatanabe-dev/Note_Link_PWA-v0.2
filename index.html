<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <!-- 強めのキャッシュ無効化（毎回リロードで拾いやすく） -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Note Link mini</title>
  <!-- CSS 1枚：キャッシュバスターは ?cb=任意の数字 でOK -->
  <link rel="stylesheet" href="note-link-ui.css?cb=20250920" />
</head>
<body>
  <!-- 上部メインバー -->
  <header class="topbar">
    <div class="title">Note Link v0.6.9-fix10 / No.13</div>
    <div class="spacer"></div>
    <button id="btn-print" class="btn">印刷</button>
    <button id="btn-png"   class="btn">PNG</button>
    <button id="btn-share" class="btn">共有</button>
  </header>

  <!-- キャンバス＆UI -->
  <div id="wrap">
    <div id="stage">
      <!-- 既存のキャンバスが別JSにある場合はそのままでOK。最低限のキャンバスも入れておく -->
      <canvas id="board"></canvas>
    </div>

    <!-- 左ツールバー（オーバーレイ） -->
    <div id="sidebar">
      <button id="toggle" aria-label="ツールバーを折り畳む" data-dir="up">
        <!-- JSで△/▽を入れます（中抜き三角） -->
      </button>

      <button id="tool-pen"    class="tool active" data-tip="ペン"><svg viewBox="0 0 24 24"><path d="M3 21l3-1 11-11-2-2L4 18l-1 3zM14 6l2 2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>
      <button id="tool-marker" class="tool" data-tip="蛍光ペン"><svg viewBox="0 0 24 24"><path d="M3 16l5 5 10-10-5-5L3 16zm5 5l3-3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>
      <button id="tool-eraser" class="tool" data-tip="消しゴム"><svg viewBox="0 0 24 24"><path d="M3 14l6 6h5l7-7-8-8-10 9zm4 6h8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>
      <button id="tool-text"   class="tool" data-tip="テキスト"><svg viewBox="0 0 24 24"><path d="M4 6h16M12 6v12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>

      <div id="gear-wrap">
        <button id="tool-gear" class="tool" data-tip="設定"><svg viewBox="0 0 24 24"><path d="M12 8a4 4 0 100 8 4 4 0 000-8zm8 4l2-1-2-3-2 1a7 7 0 00-1-1l1-2-3-2-1 2a7 7 0 00-2 0l-1-2-3 2 1 2a7 7 0 00-1 1l-2-1-2 3 2 1a7 7 0 000 2l-2 1 2 3 2-1a7 7 0 001 1l-1 2 3 2 1-2a7 7 0 002 0l1 2 3-2-1-2a7 7 0 001-1l2 1 2-3-2-1a7 7 0 000-2z" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
      </div>
    </div>

    <!-- 共通の設定パネル（中身を切替） -->
    <div id="panel" class="panel">
      <button class="close">閉じる</button>

      <div id="panel-pen">
        <h4>ペン設定</h4>
        <div class="row"><label>色</label><input id="pen-color" type="color" value="#ffffff"></div>
        <div class="row"><label>太さ</label><input id="pen-size" type="range" min="1" max="32" value="3"></div>
        <div class="row"><label>不透明度</label><input id="pen-alpha" type="range" min="0" max="100" value="100"></div>
        <div class="row"><label>直線補助</label><span>Shiftで直線（15°刻み）</span></div>
      </div>

      <div id="panel-marker" style="display:none">
        <h4>蛍光ペン設定</h4>
        <div class="row"><label>色</label><input id="mark-color" type="color" value="#66ffcc"></div>
        <div class="row"><label>太さ</label><input id="mark-size" type="range" min="4" max="48" value="16"></div>
        <div class="row"><label>不透明度</label><input id="mark-alpha" type="range" min="10" max="100" value="35"></div>
      </div>

      <div id="panel-eraser" style="display:none">
        <h4>消しゴム設定</h4>
        <div class="row"><label>消し範囲</label><input id="eraser-size" type="range" min="8" max="64" value="24"></div>
        <div class="row"><button id="erase-all" class="close" style="right:auto">全面消去</button></div>
      </div>

      <div id="panel-text" style="display:none">
        <h4>テキスト設定</h4>
        <div class="row"><label>文字サイズ</label><input id="text-size" type="range" min="10" max="72" value="20"></div>
        <div class="row"><button id="add-text" class="close" style="right:auto">テキストを追加</button></div>
      </div>
    </div>
  </div>

  <!-- JS（末尾に1本） -->
  <script>
  (() => {
    const $  = (s,r=document)=>r.querySelector(s);
    const sidebar = $('#sidebar');
    const toggle  = $('#toggle');
    const panel   = $('#panel');
    const panelClose = $('#panel .close');

    const tools = {
      pen:    $('#tool-pen'),
      marker: $('#tool-marker'),
      eraser: $('#tool-eraser'),
      text:   $('#tool-text'),
      gear:   $('#tool-gear'),
    };
    const tabs = {
      pen:    $('#panel-pen'),
      marker: $('#panel-marker'),
      eraser: $('#panel-eraser'),
      text:   $('#panel-text'),
    };

    function arrowSVG(dir){
      const d = dir==='up' ? 'M3 12 L11 4 L19 12' : 'M3 8 L11 16 L19 8';
      return `<svg viewBox="0 0 22 22"><path d="${d}" stroke="currentColor" stroke-width="2.6" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    }
    function setCollapsed(b){
      if(b){
        sidebar.setAttribute('data-collapsed','1'); // 上へ隠す
        toggle.dataset.dir='down';
        toggle.innerHTML = arrowSVG('down');        // ▽（中抜き）
      }else{
        sidebar.removeAttribute('data-collapsed');
        toggle.dataset.dir='up';
        toggle.innerHTML = arrowSVG('up');          // △（中抜き）
      }
    }
    toggle.addEventListener('click', ()=> {
      setCollapsed(sidebar.getAttribute('data-collapsed')!=='1');
    });
    setCollapsed(false);

    let active='pen';
    function setActive(name){
      Object.entries(tools).forEach(([k,el])=>{
        if(!el) return;
        el.classList.toggle('active', k===name);
      });
      active=name;

      if(name==='gear'){
        panel.classList.toggle('show');
      }else{
        panel.classList.add('show');
        Object.entries(tabs).forEach(([k,el])=>{
          if(!el) return;
          el.style.display = (k===name)?'block':'none';
        });
      }
    }
    Object.entries(tools).forEach(([k,el])=> el?.addEventListener('click',()=>setActive(k)));
    panelClose?.addEventListener('click', ()=> panel.classList.remove('show'));
    setActive('pen');

    // 上部メインバー
    $('#btn-print')?.addEventListener('click', ()=> window.print());
    $('#btn-png')?.addEventListener('click', ()=>{
      if(typeof window.exportPNG === 'function') window.exportPNG();
      else alert('PNG出力の関数(exportPNG)が未定義です。');
    });
    $('#btn-share')?.addEventListener('click', async ()=>{
      try{
        if(navigator.share) await navigator.share({title:'Note Link', url:location.href});
        else { await navigator.clipboard.writeText(location.href); alert('URLをコピーしました'); }
      }catch(e){}
    });

    // キャンバスは既存コードがある前提。なければ最低限でリサイズだけ。
    const cvs = $('#board'), ctx = cvs?.getContext?.('2d');
    function fit(){
      if(!cvs) return;
      const r = window.devicePixelRatio||1;
      const w = document.documentElement.clientWidth;
      const h = document.documentElement.clientHeight-44; // ヘッダー分
      cvs.style.width = w+'px';
      cvs.style.height = h+'px';
      cvs.width = Math.round(w*r);
      cvs.height= Math.round(h*r);
      ctx?.scale(r,r);
    }
    window.addEventListener('resize',fit,{passive:true});
    fit();
  })();
  </script>
</body>
</html>
