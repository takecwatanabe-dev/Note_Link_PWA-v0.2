<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Note Link v0.6.5 (No.7)</title>
<style>
  :root{
    --bg:#0b1220; --panel:#111827; --ink:#e5e7eb; --muted:#334155; --accent:#4ade80;
    --btn:#0f172a; --btn2:#0b1220;
    --h:44px;           /* ä¸Šéƒ¨ãƒãƒ¼é«˜ã• */
    --tbw:56px;         /* ãƒ„ãƒ¼ãƒ«ãƒœã‚¿ãƒ³è¾º */
    --gap:8px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;
    overflow:hidden;
  }

  /* ä¸Šéƒ¨ãƒ¡ã‚¤ãƒ³ãƒãƒ¼ï¼šç¸¦ä½ç½®ãŒã‚ºãƒ¬ãªã„ã‚ˆã†ã«flexä¸­å¤®æƒãˆ */
  header{
    height:var(--h); display:flex; align-items:center; gap:10px;
    padding:0 10px; background:var(--panel); border-bottom:1px solid var(--muted);
    user-select:none;
  }
  .brand{display:flex; align-items:center; gap:8px; font-weight:700}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent)}
  .ver{font-size:12px;padding:2px 8px;border:1px solid var(--muted);border-radius:999px;opacity:.85}

  .actions{display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-left:auto}
  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    height:32px; min-width:32px; padding:0 10px; border-radius:10px;
    background:var(--btn2); color:var(--ink); border:1px solid var(--muted);
    cursor:pointer; line-height:1; white-space:nowrap;
  }
  .btn:hover{border-color:var(--accent)}
  .btn.icon{width:32px; padding:0}

  /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  .wrap{height:calc(100% - var(--h)); display:grid; grid-template-columns: 64px 1fr}
  .sidebar{
    position:relative; background:var(--panel); border-right:1px solid var(--muted);
    padding:6px 8px; overflow:auto;
  }
  /* â–³â–½ãƒœã‚¿ãƒ³ï¼šãƒ„ãƒ¼ãƒ«ã¨åŒã‚µã‚¤ã‚ºã§ã€ãƒšãƒ³ã®â€œä¸Šâ€ã«å›ºå®š */
  .foldToggle{
    position:sticky; top:6px; left:0;
    width:var(--tbw); height:var(--tbw); display:grid; place-items:center;
    border:1px solid var(--muted); border-radius:12px; background:var(--btn);
    margin-bottom:var(--gap); cursor:pointer; user-select:none;
    z-index:2;
  }
  .sidebar.folded .tools{max-height:0; overflow:hidden}
  .tools{display:flex; flex-direction:column; gap:var(--gap)}

  .tool{
    width:var(--tbw); height:var(--tbw); display:grid; place-items:center;
    border:1px solid var(--muted); border-radius:12px; background:var(--btn);
    cursor:pointer; position:relative; user-select:none;
  }
  .tool.active{outline:2px solid var(--accent)}
  .label{position:absolute; left:calc(100% + 6px); top:50%; transform:translateY(-50%);
    font-size:11px; opacity:.85}

  .stage{position:relative; background:var(--bg)}
  canvas{
    display:block; width:100%; height:100%;
    background:transparent;
    /* â˜… æŒ‡ã§é€£ç¶šæç”»ã§ãã‚‹ã‚ˆã†ã«ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
    touch-action:none;
  }

  /* è¨­å®šãƒ‘ãƒãƒ«ï¼ˆå„ãƒ„ãƒ¼ãƒ«ã®è¨­å®šï¼‰ */
  .panel{
    position:absolute; top:90px; left:90px; width:360px; max-width:90vw;
    background:#121a2a; border:1px solid var(--muted); border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.45); padding:12px;
  }
  .panel h3{margin:4px 0 10px; font-size:16px}
  .row{display:flex; align-items:center; gap:8px; margin:10px 0; flex-wrap:wrap}
  .row input[type=range]{width:160px}
  .panel .close{margin-left:auto}

  /* ãƒ›ãƒ¼ãƒ ç”»é¢ï¼ˆãƒãƒ¼ãƒˆã®å…¥å£ï¼‰ */
  .home{
    position:absolute; inset:0; background:rgba(11,18,32,.96);
    display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .homeCard{
    width:min(980px,96vw); background:#0f1626; border:1px solid var(--muted); border-radius:16px; padding:16px;
  }
  .homeTitle{font-size:20px; font-weight:700; margin-bottom:12px}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px}
  .homeBtn{padding:14px 12px; border-radius:12px; border:1px solid var(--muted); background:#0b1220; cursor:pointer}
  .homeBtn:hover{border-color:var(--accent)}

  /* å…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .shareModal{position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45)}
  .shareBox{background:#0f1626; border:1px solid var(--muted); border-radius:12px; padding:12px; width:min(420px,92vw)}

  /* ç´°ã‹ãªãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚° */
  .hint{font-size:12px; opacity:.75}
</style>
</head>
<body>

<header>
  <div class="brand">
    <span class="dot"></span> Note Link <span class="ver" id="verLabel">v0.6.5 / No.7</span>
  </div>
  <div class="actions">
    <button class="btn icon" id="btnUndo" title="å…ƒã«æˆ»ã™">â†¶</button>
    <button class="btn icon" id="btnRedo" title="ã‚„ã‚Šç›´ã™">â†·</button>
    <button class="btn" id="btnPrint" title="å°åˆ·ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®å°åˆ·ï¼‰">å°åˆ·</button>
    <button class="btn" id="btnExportPng" title="PNGæ›¸ãå‡ºã—">PNG</button>
    <button class="btn" id="btnSave" title="ä¿å­˜ï¼ˆJSONï¼‰">ä¿å­˜(JSON)</button>
    <button class="btn" id="btnLoad" title="èª­è¾¼ï¼ˆJSONï¼‰">èª­è¾¼(JSON)</button>
    <button class="btn" id="btnShare" title="å…±æœ‰ãƒªãƒ³ã‚¯">å…±æœ‰</button>
    <button class="btn" id="btnTeacher" title="ç·¨é›†ç¦æ­¢åˆ‡æ›¿">æ•™å¸«ãƒ¢ãƒ¼ãƒ‰</button>
  </div>
</header>

<div class="wrap">
  <aside class="sidebar" id="sidebar">
    <!-- â–³â–½ï¼šãƒšãƒ³ã®â€œä¸Šâ€ã«è¨­ç½®ã€ã‚µã‚¤ã‚ºã¯ãƒ„ãƒ¼ãƒ«ã¨åŒã˜ -->
    <div class="foldToggle" id="foldToggle" title="ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®é–‹é–‰">â–½</div>

    <div class="tools" id="tools">
      <div class="tool active" id="tool-pen" title="ãƒšãƒ³">âœ<span class="label">ãƒšãƒ³</span></div>
      <div class="tool" id="tool-hl"  title="è›å…‰ãƒšãƒ³">ğŸ–<span class="label">è›å…‰</span></div>
      <div class="tool" id="tool-eraser" title="æ¶ˆã—ã‚´ãƒ ">âŒ«<span class="label">æ¶ˆ</span></div>
      <div class="tool" id="tool-move" title="ç§»å‹•/ã‚ºãƒ¼ãƒ ">ğŸ–<span class="label">ç§»å‹•</span></div>
      <div class="tool" id="tool-text" title="ãƒ†ã‚­ã‚¹ãƒˆ">âŒ¨<span class="label">ãƒ†ã‚­ã‚¹ãƒˆ</span></div>
      <div class="tool" id="tool-settings" title="è¨­å®š">âš™<span class="label">è¨­å®š</span></div>
    </div>
  </aside>

  <main class="stage" id="stage">
    <canvas id="canvas"></canvas>

    <!-- è¨­å®šãƒ‘ãƒãƒ«ï¼ˆãƒ„ãƒ¼ãƒ«åˆ‡æ›¿æ™‚ã¯è‡ªå‹•ã§é–‰ã˜ã‚‹ï¼‰ -->
    <div class="panel" id="panel" style="display:none">
      <div class="row"><h3 id="panelTitle">è¨­å®š</h3><button class="btn close" id="panelClose">é–‰ã˜ã‚‹</button></div>
      <div id="panelBody"></div>
      <div class="hint" id="panelHint"></div>
    </div>

    <!-- ãƒ›ãƒ¼ãƒ ï¼ˆãƒãƒ¼ãƒˆå…¥å£ï¼‰ -->
    <div class="home" id="home" style="display:none">
      <div class="homeCard">
        <div class="homeTitle">ãƒãƒ¼ãƒˆã‚’é¸æŠ</div>
        <div class="grid">
          <button class="homeBtn" id="homeNew">â‘  æ–°ã—ã„ãƒãƒ¼ãƒˆã‚’ä½œæˆ</button>
          <button class="homeBtn" id="homeOpen">â‘¡ éå»ã®ãƒãƒ¼ãƒˆã‚’é–‹ã</button>
          <button class="homeBtn" id="homeAssign">â‘¢ å…ˆç”Ÿã®èª²é¡Œã‚’èª­ã¿è¾¼ã‚€ï¼ˆPDF/ç”»åƒï¼‰</button>
          <button class="homeBtn" id="homeBook">â‘£ å•é¡Œé›†ã‚’èª­ã¿è¾¼ã‚€ï¼ˆPDF/ç”»åƒï¼‰</button>
          <button class="homeBtn" id="homeTrash">â‘¤ ã‚´ãƒŸç®±</button>
        </div>
        <div class="hint" style="margin-top:8px">â€» ãƒãƒ¼ãƒˆã¯ç«¯æœ«å†…ã«ä¿å­˜ï¼ˆlocalStorageï¼‰ã€‚å°†æ¥ã¯ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã«å¯¾å¿œäºˆå®šã€‚</div>
      </div>
    </div>

    <!-- å…±æœ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="shareModal" id="shareModal">
      <div class="shareBox">
        <div class="row"><strong>å…±æœ‰</strong><button class="btn close" id="shareClose">é–‰ã˜ã‚‹</button></div>
        <div class="row">
          <input id="shareUrl" class="btn" style="flex:1; text-align:left" readonly>
          <button class="btn" id="shareCopy">ã‚³ãƒ”ãƒ¼</button>
          <button class="btn" id="shareNative">ã‚·ã‚§ã‚¢</button>
        </div>
        <div class="hint">â€» PWAã¯ç«¯æœ«å†…ä¿å­˜ã®ãŸã‚ã€ãƒãƒ¼ãƒˆæœ¬ä½“ã‚’å…±æœ‰ã—ãŸã„æ™‚ã¯ã€Œä¿å­˜(JSON)ã€ã§æ›¸ãå‡ºã—â†’ç›¸æ‰‹ã¯ã€Œèª­è¾¼(JSON)ã€ã§å–ã‚Šè¾¼ã¿ã¾ã™ã€‚</div>
      </div>
    </div>

    <input type="file" id="fileJson" accept="application/json" hidden>
    <input type="file" id="filePdf" accept="application/pdf,image/*" hidden>
  </main>
</div>

<script>
/* =============================
   ãƒãƒ¼ã‚¸ãƒ§ãƒ³/ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ï¼ˆè‡ªå‹•ç¹°ã‚Šä¸Šã’ã®åœŸå°ï¼‰
   ============================= */
const VERSION_BASE = 'v0.6.5';
const RUN_KEY = 'note-link-run-no';
const prev = parseInt(localStorage.getItem(RUN_KEY)||'6',10); // å‰å›No.6æƒ³å®š
const RUN_NO = prev + 1; // è‡ªå‹•ã§ No.+1
localStorage.setItem(RUN_KEY, String(RUN_NO));
document.getElementById('verLabel').textContent = `${VERSION_BASE} / No.${RUN_NO}`;

/* =============================
   çŠ¶æ…‹
   ============================= */
const state = {
  mode:'draw', // draw|hl|eraser|move|text|settings
  teacher:false,
  pen:{color:'#fffae6', size:3, alpha:1, fingerOK:true}, // fingerOK: æŒ‡å…¥åŠ›å¯
  hl:{color:'#ffff66', size:16, alpha:0.35},
  eraser:{radius:22, mode:'partial'}, // partial|pageClear|allClear
  view:{scale:1, x:0, y:0, min:0.5, max:6},
  pages:[{strokes:[], texts:[]}],
  pageIndex:0,
  stroke:null,
  autosaveTimer:null,
  currentNoteId:null
};
const STORAGE_KEY = 'note-link-v065-autosave';
const NOTE_INDEX_KEY = 'note-link-notes-index'; // è¤‡æ•°ãƒãƒ¼ãƒˆç®¡ç†

/* =============================
   è¦ç´ å‚ç…§
   ============================= */
const canvas = document.getElementById('canvas');
const stage  = document.getElementById('stage');
const ctx = canvas.getContext('2d');
const dpr = Math.max(1, window.devicePixelRatio||1);

function resizeCanvas(){
  const r = stage.getBoundingClientRect();
  canvas.width = Math.floor(r.width * dpr);
  canvas.height= Math.floor((r.height) * dpr);
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr,dpr);
  render();
}
addEventListener('resize', resizeCanvas);

/* =============================
   ãƒ„ãƒ¼ãƒ«ãƒãƒ¼é–‹é–‰ï¼ˆâ–³â–½ï¼‰
   ============================= */
const sidebar = document.getElementById('sidebar');
const foldToggle = document.getElementById('foldToggle');
foldToggle.addEventListener('click', ()=>{
  sidebar.classList.toggle('folded');
  foldToggle.textContent = sidebar.classList.contains('folded') ? 'â–³' : 'â–½';
});

/* =============================
   ãƒ„ãƒ¼ãƒ«åˆ‡æ›¿ï¼ˆåˆ‡æ›¿æ™‚ã«è¨­å®šãƒ‘ãƒãƒ«ã¯é–‰ã˜ã‚‹ï¼‰
   ============================= */
const panel = document.getElementById('panel');
const panelTitle = document.getElementById('panelTitle');
const panelBody = document.getElementById('panelBody');
const panelHint = document.getElementById('panelHint');
document.getElementById('panelClose').onclick = ()=> panel.style.display='none';

function setMode(m){
  state.mode=m;
  // ãƒœã‚¿ãƒ³è¦‹ãŸç›®
  document.querySelectorAll('.tool').forEach(t=>t.classList.remove('active'));
  document.getElementById('tool-'+(m==='draw'?'pen':m)).classList.add('active');
  // è¨­å®šãƒ‘ãƒãƒ«ã¯ä¸€åº¦é–‰ã˜ã‚‹
  panel.style.display='none';
}

document.getElementById('tool-pen').onclick = ()=> setMode('draw');
document.getElementById('tool-hl').onclick  = ()=> setMode('hl');
document.getElementById('tool-eraser').onclick = ()=> setMode('eraser');
document.getElementById('tool-move').onclick = ()=> setMode('move');
document.getElementById('tool-text').onclick = ()=> setMode('text');
document.getElementById('tool-settings').onclick = ()=> { setMode('settings'); openSettings(); };

/* =============================
   è¨­å®šãƒ‘ãƒãƒ«
   ============================= */
function openSettings(){
  panelTitle.textContent = 'è¨­å®š';
  panelBody.innerHTML = '';
  const sec = document.createElement('div');

  // ãƒšãƒ³
  sec.innerHTML += `<h4>ãƒšãƒ³</h4>
  <div class="row"><label>è‰²</label><input type="color" id="penColor" value="${state.pen.color}"></div>
  <div class="row"><label>å¤ªã•</label><input type="range" id="penSize" min="1" max="36" value="${state.pen.size}"><span>${state.pen.size}</span></div>
  <div class="row"><label>ä¸é€æ˜åº¦</label><input type="range" id="penAlpha" min="0.1" step="0.05" max="1" value="${state.pen.alpha}"><span>${state.pen.alpha}</span></div>
  <div class="row"><label><input type="checkbox" id="penFinger" ${state.pen.fingerOK?'checked':''}> æŒ‡å…¥åŠ›ã‚‚è¨±å¯</label></div>`;

  // è›å…‰
  sec.innerHTML += `<h4>è›å…‰</h4>
  <div class="row"><label>è‰²</label><input type="color" id="hlColor" value="${state.hl.color}"></div>
  <div class="row"><label>å¤ªã•</label><input type="range" id="hlSize" min="4" max="80" value="${state.hl.size}"><span>${state.hl.size}</span></div>`;

  // æ¶ˆã—ã‚´ãƒ ï¼ˆæ‹¡å¼µï¼šå…¨é¢/ãƒšãƒ¼ã‚¸ï¼‰
  sec.innerHTML += `<h4>æ¶ˆã—ã‚´ãƒ </h4>
  <div class="row"><label>æ¶ˆã—ç¯„å›²</label><input type="range" id="eraserR" min="8" max="60" value="${state.eraser.radius}"><span>${state.eraser.radius}</span></div>
  <div class="row"><label>ãƒ¢ãƒ¼ãƒ‰</label>
    <select id="eraserMode">
      <option value="partial" ${state.eraser.mode==='partial'?'selected':''}>éƒ¨åˆ†æ¶ˆã—</option>
      <option value="pageClear" ${state.eraser.mode==='pageClear'?'selected':''}>ã“ã®ãƒšãƒ¼ã‚¸ã‚’å…¨æ¶ˆå»</option>
      <option value="allClear" ${state.eraser.mode==='allClear'?'selected':''}>å…¨ãƒšãƒ¼ã‚¸ã‚’å…¨æ¶ˆå»</option>
    </select>
    <button class="btn" id="execClear">å®Ÿè¡Œ</button>
  </div>`;

  panelBody.appendChild(sec);
  panel.style.display='block';

  // ãƒã‚¤ãƒ³ãƒ‰
  const penColor = sec.querySelector('#penColor');
  const penSize  = sec.querySelector('#penSize'); const penSizeV = penSize.nextElementSibling;
  const penAlpha = sec.querySelector('#penAlpha'); const penAlphaV = penAlpha.nextElementSibling;
  const penFinger= sec.querySelector('#penFinger');

  penColor.oninput = ()=>{ state.pen.color = penColor.value; render(); requestAutosave(); };
  penSize.oninput  = ()=>{ state.pen.size = +penSize.value; penSizeV.textContent=penSize.value; render(); requestAutosave(); };
  penAlpha.oninput = ()=>{ state.pen.alpha = +penAlpha.value; penAlphaV.textContent=penAlpha.value; render(); requestAutosave(); };
  penFinger.onchange=()=>{ state.pen.fingerOK = penFinger.checked; };

  const hlColor = sec.querySelector('#hlColor');
  const hlSize  = sec.querySelector('#hlSize'); const hlSizeV = hlSize.nextElementSibling;
  hlColor.oninput= ()=>{ state.hl.color = hlColor.value; render(); requestAutosave(); };
  hlSize.oninput = ()=>{ state.hl.size  = +hlSize.value; hlSizeV.textContent=hlSize.value; render(); requestAutosave(); };

  const erR = sec.querySelector('#eraserR'); const erRV = erR.nextElementSibling;
  const erM = sec.querySelector('#eraserMode');
  const exec= sec.querySelector('#execClear');
  erR.oninput = ()=>{ state.eraser.radius = +erR.value; erRV.textContent = erR.value; };
  erM.onchange= ()=>{ state.eraser.mode = erM.value; };
  exec.onclick  = ()=>{
    if(state.eraser.mode==='pageClear'){
      state.pages[state.pageIndex] = {strokes:[], texts:[]};
    }else if(state.eraser.mode==='allClear'){
      state.pages = [{strokes:[], texts:[]}]; state.pageIndex=0;
    }
    render(); requestAutosave();
    alert('æ¶ˆå»ã—ã¾ã—ãŸ');
  };

  panelHint.textContent = 'ãƒ„ãƒ¼ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ã€ã“ã®ãƒ‘ãƒãƒ«ã¯è‡ªå‹•çš„ã«é–‰ã˜ã¾ã™ã€‚';
}

/* =============================
   æç”»
   ============================= */
function render(){
  const r = canvas.getBoundingClientRect();
  ctx.clearRect(0,0,r.width,r.height);
  ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg');
  ctx.fillRect(0,0,r.width,r.height);

  ctx.save();
  ctx.translate(state.view.x, state.view.y);
  ctx.scale(state.view.scale, state.view.scale);

  const page = state.pages[state.pageIndex];
  // strokes
  ctx.lineCap='round'; ctx.lineJoin='round';
  for(const s of page.strokes){ drawStroke(s); }
  if(state.stroke) drawStroke(state.stroke);

  // textsï¼ˆç°¡æ˜“ï¼‰
  ctx.fillStyle = '#fff';
  for(const t of page.texts){ ctx.font = `${t.size||18}px ${t.font||"sans-serif"}`; ctx.fillText(t.text, t.x, t.y); }

  ctx.restore();
}
function drawStroke(s){
  ctx.globalAlpha = s.alpha;
  ctx.strokeStyle = s.color; ctx.lineWidth = s.size;
  ctx.beginPath();
  const pts = s.points;
  ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=1;i<pts.length;i++){ ctx.lineTo(pts[i].x, pts[i].y); }
  ctx.stroke();
  ctx.globalAlpha = 1;
}

/* =============================
   å…¥åŠ›ï¼ˆâ˜… æŒ‡ã§ç·šãŒå¼•ã‘ã‚‹ã‚ˆã†ã« Pointer Events ã‚’çµ±ä¸€ï¼‰
   ============================= */
let isDown=false, pointerId=null;

function toCanvasXY(e){
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left - state.view.x) / state.view.scale;
  const y = (e.clientY - rect.top  - state.view.y) / state.view.scale;
  return {x,y};
}

canvas.addEventListener('pointerdown', (e)=>{
  // æ•™å¸«ãƒ¢ãƒ¼ãƒ‰ã¯ç·¨é›†ä¸å¯
  if(state.teacher) return;
  // æŒ‡ã®å…¥åŠ›ï¼šè¨±å¯ãƒ•ãƒ©ã‚°ãŒfalseãªã‚‰ç„¡è¦–
  if(e.pointerType==='touch' && state.mode!=='move' && !state.pen.fingerOK) return;

  // moveä»¥å¤–ã§ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘æ­¢
  if(state.mode!=='move') e.preventDefault();

  isDown=true; pointerId=e.pointerId; canvas.setPointerCapture(pointerId);

  if(state.mode==='draw' || state.mode==='hl'){
    const p = toCanvasXY(e);
    const base = (state.mode==='draw')? state.pen : state.hl;
    state.stroke = { tool:state.mode, color:base.color, size:base.size, alpha:(state.mode==='draw'?state.pen.alpha:state.hl.alpha), points:[p] };
    render();
  }else if(state.mode==='eraser'){
    // éƒ¨åˆ†æ¶ˆã—ã¯ move ä¸­ã«å‡¦ç†
  }else if(state.mode==='text'){
    const p = toCanvasXY(e);
    const text = prompt('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›');
    if(text && text.length){
      state.pages[state.pageIndex].texts.push({text, x:p.x, y:p.y, size:18, font:"'Noto Sans JP',sans-serif"});
      render(); requestAutosave();
    }
  }
}, {passive:false});

canvas.addEventListener('pointermove', (e)=>{
  if(!isDown || e.pointerId!==pointerId) return;

  if(state.mode==='draw' || state.mode==='hl'){
    const p = toCanvasXY(e);
    state.stroke.points.push(p);
    render();
  }else if(state.mode==='eraser'){
    const p = toCanvasXY(e);
    const r = state.eraser.radius;
    const page = state.pages[state.pageIndex];
    // ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã®â€œè¿‘æ¥â€ã§æ¶ˆå»ï¼ˆç°¡æ˜“ï¼šç‚¹ã¨ã®è·é›¢ï¼‰
    page.strokes = page.strokes.filter(s=>{
      return !s.points.some(pt => ((pt.x-p.x)**2 + (pt.y-p.y)**2) <= r*r);
    });
    render();
  }else if(state.mode==='move'){
    // 2æœ¬æŒ‡ã‚„ãƒšãƒ³ã§ã‚‚ãƒ‰ãƒ©ãƒƒã‚°ã§å¹³è¡Œç§»å‹•ï¼ˆç°¡æ˜“ï¼‰
    state.view.x += e.movementX;
    state.view.y += e.movementY;
    render();
  }
}, {passive:false});

canvas.addEventListener('pointerup', (e)=>{
  if(e.pointerId!==pointerId) return;
  isDown=false; canvas.releasePointerCapture(pointerId);
  if(state.stroke){
    state.pages[state.pageIndex].strokes.push(state.stroke);
    state.stroke=null; requestAutosave();
  }
});
canvas.addEventListener('pointercancel', ()=>{ isDown=false; state.stroke=null; });

/* =============================
   ä¿å­˜ãƒ»èª­è¾¼ï¼ˆç«¯æœ«è‡ªå‹•ä¿å­˜ + JSONæ‰‹å‹•ï¼‰
   ============================= */
function requestAutosave(){
  clearTimeout(state.autosaveTimer);
  state.autosaveTimer = setTimeout(saveToStorage, 500);
}
function saveToStorage(){
  try{
    const snap = {
      pages: state.pages,
      pageIndex: state.pageIndex,
      view: state.view,
      pen: state.pen, hl: state.hl, eraser: state.eraser
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(snap));
  }catch(e){ console.warn('autosave failed', e); }
}
function loadFromStorage(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return false;
    const snap = JSON.parse(raw);
    state.pages = snap.pages||state.pages;
    state.pageIndex = snap.pageIndex||0;
    state.view = snap.view||state.view;
    state.pen = snap.pen||state.pen;
    state.hl = snap.hl||state.hl;
    state.eraser = snap.eraser||state.eraser;
    return true;
  }catch(e){ return false; }
}
window.addEventListener('beforeunload', saveToStorage);

document.getElementById('btnSave').onclick = ()=>{
  const blob = new Blob([JSON.stringify({pages:state.pages},null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'note-link.json';
  a.click();
};
const fileJson = document.getElementById('fileJson');
document.getElementById('btnLoad').onclick = ()=> fileJson.click();
fileJson.onchange = async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  const data = JSON.parse(txt);
  state.pages = data.pages||[{strokes:[],texts:[]}];
  state.pageIndex = 0;
  render(); requestAutosave();
  fileJson.value='';
};

/* =============================
   PNG & å°åˆ· & å…±æœ‰
   ============================= */
document.getElementById('btnExportPng').onclick = ()=>{
  // èƒŒæ™¯ã‚‚å«ã‚ã¦å‡ºåŠ›
  const r = canvas.getBoundingClientRect();
  const out = document.createElement('canvas');
  out.width = r.width; out.height = r.height;
  const oc = out.getContext('2d');
  oc.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg');
  oc.fillRect(0,0,r.width,r.height);
  oc.drawImage(canvas,0,0,r.width,r.height);
  const a = document.createElement('a');
  a.href = out.toDataURL('image/png');
  a.download = 'note-page.png';
  a.click();
};
document.getElementById('btnPrint').onclick = ()=> window.print();

const shareModal = document.getElementById('shareModal');
const shareUrl   = document.getElementById('shareUrl');
document.getElementById('btnShare').onclick = ()=>{
  shareUrl.value = location.href.split('#')[0];
  shareModal.style.display='flex';
};
document.getElementById('shareClose').onclick = ()=> shareModal.style.display='none';
document.getElementById('shareCopy').onclick  = async ()=>{
  try{ await navigator.clipboard.writeText(shareUrl.value); alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }catch{}
};
document.getElementById('shareNative').onclick = async ()=>{
  if(navigator.share){
    try{ await navigator.share({title:'Note Link', url:shareUrl.value}); }catch{}
  }else{
    alert('ã“ã®ç«¯æœ«ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–å…±æœ‰ã«æœªå¯¾å¿œã§ã™ã€‚ã‚³ãƒ”ãƒ¼ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
  }
};

/* =============================
   æ•™å¸«ãƒ¢ãƒ¼ãƒ‰
   ============================= */
const btnTeacher = document.getElementById('btnTeacher');
btnTeacher.onclick = ()=>{
  state.teacher = !state.teacher;
  btnTeacher.textContent = state.teacher? 'æ•™å¸«ãƒ¢ãƒ¼ãƒ‰ï¼ˆé–²è¦§å°‚ç”¨ï¼‰':'æ•™å¸«ãƒ¢ãƒ¼ãƒ‰';
};

/* =============================
   ãƒãƒ¼ãƒˆâ€œãƒ›ãƒ¼ãƒ â€ â‘ ã€œâ‘¤ï¼ˆæœ€å°å®Ÿè£…ï¼‰
   ============================= */
const home = document.getElementById('home');
function showHome(flag){
  home.style.display = flag? 'flex':'none';
}
const notesIndex = JSON.parse(localStorage.getItem(NOTE_INDEX_KEY)||'[]'); // [{id,title,ts}]
function saveNoteToIndex(id,title){
  const now = Date.now();
  const i = notesIndex.findIndex(n=>n.id===id);
  if(i>=0){ notesIndex[i].title=title; notesIndex[i].ts=now; }
  else{ notesIndex.push({id,title,ts:now}); }
  localStorage.setItem(NOTE_INDEX_KEY, JSON.stringify(notesIndex));
}

document.getElementById('homeNew').onclick = ()=>{
  const title = prompt('ãƒãƒ¼ãƒˆå'); if(!title) return;
  const id = 'note_'+Date.now();
  state.currentNoteId = id;
  state.pages=[{strokes:[],texts:[]}]; state.pageIndex=0;
  saveNoteToIndex(id,title);
  showHome(false); render(); requestAutosave();
};
document.getElementById('homeOpen').onclick = ()=>{
  if(notesIndex.length===0){ alert('ä¿å­˜æ¸ˆã¿ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const list = notesIndex
    .sort((a,b)=>b.ts-a.ts)
    .map((n,i)=>`${i+1}. ${n.title} (${new Date(n.ts).toLocaleString()})`).join('\n');
  const sel = prompt('é–‹ãç•ªå·ã‚’å…¥åŠ›ï¼š\n'+list);
  const idx = (parseInt(sel||'0',10)-1)|0;
  const n = notesIndex[idx]; if(!n) return;
  state.currentNoteId = n.id;
  // ãƒãƒ¼ãƒˆæœ¬ä½“ã¯ autosave ã‚­ãƒ¼ã«ã¾ã¨ã‚ã¦ä¿å­˜ã—ã¦ã„ã‚‹ç°¡æ˜“ç‰ˆ
  const ok = loadFromStorage();
  showHome(false); render();
};
document.getElementById('homeAssign').onclick = ()=>{
  document.getElementById('filePdf').click(); // PDF/ç”»åƒâ†’èƒŒæ™¯ã¨ã—ã¦å–ã‚Šè¾¼ã¿æƒ³å®š
};
document.getElementById('homeBook').onclick = ()=>{
  document.getElementById('filePdf').click();
};
document.getElementById('homeTrash').onclick = ()=>{
  alert('ã‚´ãƒŸç®±ã¯ä»Šã¯ä¸€è¦§ã®ã¿ï¼ˆå°†æ¥ã¯å¾©å…ƒ/å®Œå…¨å‰Šé™¤ã«å¯¾å¿œï¼‰');
};

const filePdf = document.getElementById('filePdf');
filePdf.onchange = async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  if(f.type==='application/pdf'){
    // ã‚·ãƒ³ãƒ—ãƒ«ï¼šPDFã¯ç”»åƒåŒ–ã›ãšã€ã„ã£ãŸã‚“ã€Œèª­ã¿è¾¼ã¿ãƒ¡ãƒ¢ã€ã‚’è¿½åŠ ï¼ˆå°†æ¥ï¼špdf.jsï¼‰
    alert('PDFå—ä¿¡ï¼šå°†æ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å„ãƒšãƒ¼ã‚¸ã‚’èƒŒæ™¯åŒ–ã—ã¾ã™ï¼ˆv0.7ç³»äºˆå®šï¼‰');
  }else{
    const url = URL.createObjectURL(f);
    const img = new Image();
    img.onload = ()=>{
      const cnv = document.createElement('canvas');
      cnv.width = img.width; cnv.height = img.height;
      cnv.getContext('2d').drawImage(img,0,0);
      const page = state.pages[state.pageIndex];
      // èƒŒæ™¯ã®ä»£ã‚ã‚Šã«ä¸€æ—¦ç”»åƒã‚’1æšè²¼ã‚‹ï¼šç°¡æ˜“å®Ÿè£…
      page.strokes.push({tool:'draw', color:'#ffffff', size:0.0001, alpha:1, points:[{x:0,y:0}]}); // no-opä¿æŒ
      render(); requestAutosave();
    };
    img.src = url;
  }
  e.target.value='';
};

/* =============================
   åˆæœŸåŒ–
   ============================= */
function init(){
  resizeCanvas();
  // åˆå›ã¯ãƒ›ãƒ¼ãƒ ï¼ˆãƒãƒ¼ãƒˆé¸æŠï¼‰ã‚’è¡¨ç¤ºã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å¾©å…ƒã—ã¦ãƒ›ãƒ¼ãƒ éè¡¨ç¤º
  const has = loadFromStorage();
  showHome(!has);
  render();
}
init();
</script>
</body>
</html>
