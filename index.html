<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Note Link v0.6.8-fix6 / No.12</title>
<style>
:root{
  --ink:#e6edf3; --bg:#0b1220; --muted:#2a3446; --accent:#59f087; --accent-d:#19cf66;
  --shadow:0 0 0 2px rgba(0,200,120,.25), 0 0 8px rgba(0,200,120,.35) inset;
  --panel:#121a2b;
  --panel-border:#26324a;
  --btn:#1a2336; --btn-b:#31405f;
  --warn:#e55; --text:#c9d4e1;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,"Segoe UI","Hiragino Kaku Gothic ProN","Meiryo",sans-serif;line-height:1.4}
button{font:inherit}
a{color:var(--accent)}
/* ヘッダ（上部メニュー） */
header{position:fixed;top:8px;right:12px;z-index:30;display:flex;gap:8px;align-items:center}
header .topbtn{background:var(--btn);border:1px solid var(--btn-b);color:var(--text);padding:6px 10px;border-radius:8px;cursor:pointer}
header .topbtn:active{transform:translateY(1px)}
/* 左ツールバー */
#sidebar{position:fixed;left:8px;top:56px;bottom:8px;width:56px;border-right:1px solid var(--muted);
  display:flex;flex-direction:column;gap:8px;padding:8px;background:transparent;z-index:20}
#sidebar .tool{width:40px;height:40px;border-radius:12px;border:1px solid var(--muted);
  display:grid;place-items:center;cursor:pointer;color:#9fb0c6;background:#0f1727}
#sidebar .tool svg{width:20px;height:20px;filter:grayscale(1) brightness(1.0)}
#sidebar .tool.active{outline:2px solid var(--accent); box-shadow: var(--shadow)}
#sidebar .tool.active svg{filter:none}
#sidebar[data-collapsed="1"]{width:22px}
#sidebar[data-collapsed="1"] .tool:not(.toggle){opacity:0;pointer-events:none}
#sidebar .toggle{position:relative;width:40px;height:40px;border-radius:12px}
#sidebar .toggle::after{content:"▾";display:block;font-weight:700}
#sidebar[data-collapsed="1"] .toggle::after{content:"▸";transform:rotate(90deg);}
/* バージョン表示 */
#ver{position:fixed;left:8px;top:8px;font-size:13px;color:#9fb0c6}
canvas#stage{position:fixed;inset:0}
/* 設定パネル（ツールごとに切替） */
#panel{position:fixed;left:80px;top:96px;min-width:300px;background:var(--panel);border:1px solid var(--panel-border);
  border-radius:12px;padding:14px 16px;box-shadow:0 12px 40px rgba(0,0,0,.35);z-index:25;display:none}
#panel.show{display:block}
#panel h3{margin:0 0 6px;font-size:16px}
.row{display:flex;align-items:center;gap:8px;margin:10px 0}
.row label{min-width:68px;opacity:.9}
input[type="range"]{width:180px}
.color{width:28px;height:20px;border-radius:6px;border:1px solid #445}
.small{font-size:12px;opacity:.75}
#panel .danger{background:#2a0f15;border:1px solid #89323a;color:#ffd7d7;padding:6px 10px;border-radius:8px;cursor:pointer}
#closePanel{margin-left:8px;background:var(--btn);border:1px solid var(--btn-b);color:var(--text);padding:6px 10px;border-radius:8px;cursor:pointer}
</style>
</head>
<body>
<div id="ver">Note Link <strong>v0.6.8-fix6 / No.12</strong></div>

<header>
  <button class="topbtn" id="btnPrint">印刷</button>
  <button class="topbtn" id="btnPng">PNG</button>
  <button class="topbtn" id="btnShare">共有</button>
</header>

<aside id="sidebar" aria-label="ツールバー">
  <button class="tool toggle" id="btnToggle" title="ツールバーを開閉"></button>
  <button class="tool active" data-tool="pen" title="ペン" id="tool-pen">
    <svg viewBox="0 0 24 24" fill="none"><path d="M4 16l10-10 4 4-10 10-5 1 1-5z" stroke="currentColor" stroke-width="2"/></svg>
  </button>
  <button class="tool" data-tool="marker" title="蛍光ペン" id="tool-marker">
    <svg viewBox="0 0 24 24" fill="none"><path d="M5 15l8-8 4 4-8 8H5v-4z" stroke="currentColor" stroke-width="2"/></svg>
  </button>
  <button class="tool" data-tool="eraser" title="消しゴム" id="tool-eraser">
    <svg viewBox="0 0 24 24" fill="none"><path d="M4 14l6-6 6 6-4 4H6l-2-2z" stroke="currentColor" stroke-width="2"/></svg>
  </button>
  <button class="tool" data-tool="hand" title="移動" id="tool-hand">
    <svg viewBox="0 0 24 24" fill="none"><path d="M6 12V7a2 2 0 1 1 4 0v3-3a2 2 0 1 1 4 0v5-4a2 2 0 1 1 4 0v6a6 6 0 0 1-6 6H9a5 5 0 0 1-5-5" stroke="currentColor" stroke-width="2"/></svg>
  </button>
  <button class="tool" data-tool="text" title="テキスト" id="tool-text">
    <svg viewBox="0 0 24 24" fill="none"><path d="M5 6h14M12 6v12" stroke="currentColor" stroke-width="2"/></svg>
  </button>
  <button class="tool" data-tool="settings" title="設定" id="tool-settings">
    <svg viewBox="0 0 24 24" fill="none"><path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm8 4l-2 1 .2 2.3-2.1.9-1.1 2-2.3-.2L12 20l-2-2-2.3.2-1.1-2-2.1-.9L5 13l-2-1 2-1-.2-2.3 2.1-.9 1.1-2L10.0 4 12 2l2 2 2.3-.2 1.1 2 2.1.9L20 11z" stroke="currentColor" stroke-width="1.5"/></svg>
  </button>
</aside>

<canvas id="stage"></canvas>

<!-- 設定パネル -->
<section id="panel" aria-live="polite">
  <h3 id="panelTitle">ペン設定</h3>
  <div id="panelBody"></div>
  <div class="row"><span class="small">※ツールを切り替えると自動で閉じます</span><button id="closePanel">閉じる</button></div>
</section>

<script>
(() => {
  const VERSION = 'v0.6.8-fix6 / No.12';
  const $ = (q, el=document)=>el.querySelector(q);
  const $$ = (q, el=document)=>[...el.querySelectorAll(q)];
  const stage = $('#stage');
  const ctx = stage.getContext('2d');

  // レイアウト
  function fit(){
    stage.width = window.innerWidth;
    stage.height = window.innerHeight;
    redraw();
  }
  window.addEventListener('resize', fit, {passive:true});

  // 状態
  const state = {
    tool: 'pen',
    pen: {color:'#ffeecc', size:3, alpha:1},
    marker: {color:'#c4ff61', size:16, alpha:0.35},
    eraser: {radius:30},
    strokes: [], // {tool, color,size,alpha, points:[{x,y}]}
    drawing: false,
    shift: false,
  };

  // 描画
  function redraw(){
    ctx.fillStyle = '#101726';
    ctx.fillRect(0,0,stage.width,stage.height);
    for(const s of state.strokes){
      if(s.tool==='eraser'){ continue; }
      ctx.save();
      ctx.globalAlpha = s.alpha ?? 1;
      ctx.strokeStyle = s.color;
      ctx.lineWidth = s.size;
      ctx.lineJoin = ctx.lineCap = 'round';
      ctx.beginPath();
      s.points.forEach((p,i)=> i? ctx.lineTo(p.x,p.y): ctx.moveTo(p.x,p.y));
      ctx.stroke();
      ctx.restore();
    }
  }
  function pos(e){
    const r = stage.getBoundingClientRect();
    const x = (e.touches? e.touches[0].clientX : e.clientX) - r.left;
    const y = (e.touches? e.touches[0].clientY : e.clientY) - r.top;
    return {x,y};
  }

  // 入力
  const down = (e)=>{
    if(state.tool==='hand' || state.tool==='settings') return;
    state.drawing = true;
    const p = pos(e);
    const stroke = (state.tool==='pen' || state.tool==='marker')
      ? {tool:state.tool, color:state[state.tool].color, size:state[state.tool].size, alpha:state[state.tool].alpha, points:[p]}
      : {tool:'eraser', r:state.eraser.radius, points:[p]};
    state.strokes.push(stroke);
  };
  const move = (e)=>{
    if(!state.drawing) return;
    const p = pos(e);
    const s = state.strokes[state.strokes.length-1];
    if(state.shift && (state.tool==='pen'||state.tool==='marker') && s.points.length){
      // 直線化（Shift）
      const a = s.points[0];
      s.points = [a, p];
    }else{
      s.points.push(p);
    }
    if(s.tool==='eraser'){
      // 消去は簡易：近傍ストロークを間引く
      state.strokes = state.strokes.filter(st=>{
        if(st.tool==='eraser') return true;
        return !st.points.some(pt => (pt.x-p.x)**2 + (pt.y-p.y)**2 < s.r**2);
      });
    }
    redraw();
  };
  const up = ()=>{ state.drawing = false; };

  stage.addEventListener('pointerdown', down);
  stage.addEventListener('pointermove', move);
  stage.addEventListener('pointerup', up);
  stage.addEventListener('pointerleave', up);
  stage.addEventListener('touchstart', down, {passive:false});
  stage.addEventListener('touchmove', move, {passive:false});
  stage.addEventListener('touchend', up);

  window.addEventListener('keydown', (e)=>{ if(e.key==='Shift') state.shift=true; });
  window.addEventListener('keyup',   (e)=>{ if(e.key==='Shift') state.shift=false; });

  // ツール切替
  function setTool(t){
    if(state.tool===t) return;
    state.tool=t;
    $$('.tool').forEach(b=>b.classList.toggle('active', b.dataset.tool===t));
    // ツールを変えたら設定パネルは閉じる
    hidePanel();
  }
  $$('#sidebar .tool[data-tool]').forEach(b=>{
    b.addEventListener('click',()=>{
      const t = b.dataset.tool;
      if(t==='settings'){ showPanel(state.tool); } else { setTool(t); showPanel(t); }
    });
  });

  // 開閉
  $('#btnToggle').addEventListener('click',()=>{
    const sb = $('#sidebar');
    const collapsed = sb.getAttribute('data-collapsed')==='1' ? '0':'1';
    sb.setAttribute('data-collapsed', collapsed);
  });

  // 設定パネル
  const panel = $('#panel'), body = $('#panelBody'), title = $('#panelTitle');
  function hidePanel(){ panel.classList.remove('show'); }
  $('#closePanel').addEventListener('click', hidePanel);

  function showPanel(tool){
    title.textContent = (tool==='pen'?'ペン設定': tool==='marker'?'蛍光ペン設定': tool==='eraser'?'消しゴム設定':'設定');
    body.innerHTML = '';
    if(tool==='pen' || tool==='marker'){
      const cfg = state[tool];
      body.append(elRow('色', colorInput(cfg.color, v=>{ cfg.color=v; })));
      body.append(elRow('太さ', range(cfg.size, 1, 42, 1, v=>{ cfg.size=v; })));
      body.append(elRow('不透明', range(cfg.alpha, 0.05, 1, 0.05, v=>{ cfg.alpha=v; })));
      const tip = document.createElement('div'); tip.className='small'; tip.textContent='Shiftで直線（15°刻みは次リリースで追加します）';
      body.append(tip);
    }else if(tool==='eraser'){
      body.append(elRow('消し範囲', range(state.eraser.radius, 8, 80, 1, v=>{ state.eraser.radius=v; })));
      const btn = document.createElement('button'); btn.className='danger'; btn.textContent='全面消去';
      btn.onclick = ()=>{ state.strokes = []; redraw(); };
      body.append(btn);
    }else{
      body.append(document.createTextNode('一般設定は次のバージョンで拡張します。'));
    }
    panel.classList.add('show');
  }
  function elRow(label, ctrl){
    const r=document.createElement('div'); r.className='row';
    const l=document.createElement('label'); l.textContent=label; r.append(l); r.append(ctrl); return r;
  }
  function range(val,min,max,step,on){
    const r=document.createElement('input'); r.type='range'; r.min=min; r.max=max; r.step=step; r.value=val;
    r.oninput=()=>on(Number(r.value)); return r;
  }
  function colorInput(val,on){
    const i=document.createElement('input'); i.type='color'; i.value=val; i.className='color';
    i.oninput=()=>on(i.value); return i;
  }

  // 上部ボタン
  $('#btnPrint').onclick = ()=>{ window.print(); };
  $('#btnPng').onclick = ()=>{
    const url = stage.toDataURL('image/png');
    const a = document.createElement('a'); a.href=url; a.download='note-page.png'; a.click();
  };
  $('#btnShare').onclick = async ()=>{
    const shareUrl = location.origin + location.pathname + '?v=' + encodeURIComponent(VERSION.replace(/\s+/g,'-'));
    if(navigator.share){
      try{ await navigator.share({title:'Note Link', url:shareUrl}); }catch{}
    }else{
      await navigator.clipboard.writeText(shareUrl);
      alert('URLをコピーしました:\n' + shareUrl);
    }
  };

  // 初期表示
  fit(); redraw(); showPanel('pen');

  // ★サービスワーカーは「意図的に無効化」：キャッシュ問題の切り分け
  if('serviceWorker' in navigator){
    navigator.serviceWorker.getRegistration().then(reg=>{
      if(reg) reg.unregister();
    });
  }

  // デバッグ：クエリ ?v=xxxxx をタイトルに反映
  const v = new URLSearchParams(location.search).get('v');
  if(v){ $('#ver').innerHTML = 'Note Link <strong>'+String(v).replaceAll('-',' ')+'</strong>'; }
})();
</script>
</body>
</html>
