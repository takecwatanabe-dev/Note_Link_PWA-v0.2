<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Note Link v0.6.8 / No.12</title>
<style>
:root{
  --bg:#0f172a;        /* 背景 */
  --panel:#111827;     /* パネル */
  --ink:#e5e7eb;       /* 文字色 */
  --muted:#334155;     /* 境界線 */
  --accent:#4ade80;    /* アクティブ（緑） */
}
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0; color:var(--ink); background:var(--bg);
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic UI", "Meiryo", sans-serif;
  overflow:hidden;
}

/* ヘッダー（縦ズレ防止：行高&中央揃え） */
header{
  height:46px; display:flex; align-items:center; gap:8px;
  padding:0 10px; background:var(--panel); border-bottom:1px solid var(--muted);
}
.brand{ display:flex; align-items:center; gap:8px; font-weight:700; }
.vchip{ font-size:12px; padding:2px 8px; border:1px solid var(--muted); border-radius:999px; opacity:.9; }
.h-actions{ margin-left:auto; display:flex; align-items:center; gap:6px; }
.h-actions .btn{
  display:inline-flex; align-items:center; justify-content:center;
  height:28px; padding:0 10px; border:1px solid var(--muted); border-radius:10px;
  background:#0b1220; color:var(--ink); line-height:1;
}
.h-actions .btn:active{ transform:translateY(1px); }
.h-actions .btn:focus{ outline:2px solid var(--accent); outline-offset:1px; }

/* 2カラムレイアウト（折りたたみ時もキャンバス領域を侵食しない） */
.main{
  height:calc(100% - 46px);
  display:grid; grid-template-columns: var(--sbw,64px) 1fr;
}

/* サイドバー */
.sidebar{
  position:relative; background:#0b1220; border-right:1px solid var(--muted);
  padding:8px 6px; display:flex; flex-direction:column; gap:8px;
}
.sb-toggle{
  position:absolute; left:6px; top:6px; width:36px; height:36px;
  display:grid; place-items:center; border-radius:12px;
  border:1px solid var(--muted); background:#0b1220; cursor:pointer;
}
.sb-toggle svg{ width:18px; height:18px; }
.tools{ margin-top:52px; display:flex; flex-direction:column; gap:8px; }
.tool{
  width:44px; height:44px; display:grid; place-items:center;
  border:1px solid var(--muted); border-radius:12px; background:#0b1220; cursor:pointer;
}
.tool svg{ width:22px; height:22px; }
.tool.active{
  border-color:var(--accent);
  box-shadow:0 0 0 2px rgba(74,222,128,.9), 0 0 12px rgba(74,222,128,.65) inset;
}
.tool.settings.active{ /* 設定は細線アクティブ */
  box-shadow:0 0 0 1px rgba(74,222,128,.9), 0 0 8px rgba(74,222,128,.45) inset;
}

/* 折りたたみ（幅を狭く・アイコンは残す） */
body.sb-collapsed{ --sbw: 20px; }
body.sb-collapsed .sb-toggle{ left:2px; }
body.sb-collapsed .tools{ margin-left:-56px; } /* 画面端に揃えて見失わない */
body.sb-collapsed .tool{ width:44px; }         /* キャンバス側に被らない */

/* ステージ */
.stage{ position:relative; background:#0b1220; }
canvas{ display:block; width:100%; height:100%; }

/* 設定フローティング */
.panel{
  position:absolute; top:76px; left:76px; min-width:300px;
  background:rgba(17,24,39,.98); border:1px solid var(--muted);
  border-radius:14px; padding:10px; box-shadow:0 10px 28px rgba(0,0,0,.4);
}
.panel.hidden{ display:none; }
.panel .ph{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
.tabs{ display:flex; gap:6px; margin-bottom:8px; flex-wrap:wrap; }
.tabs button{
  height:28px; padding:0 10px; border-radius:8px; border:1px solid var(--muted); background:#0b1220; color:var(--ink);
}
.tabs button.active{ border-color:var(--accent); background:#0e1b2a; }
.row{ display:flex; align-items:center; gap:8px; margin:8px 0; }
.row input[type="range"]{ width:170px; }
.row input[type="color"]{ width:36px; height:24px; padding:0; border:1px solid var(--muted); border-radius:6px; background:#fff; }
.small{ font-size:12px; opacity:.8; }

/* 上部ページャは必要最小 */
.pager{ display:inline-flex; align-items:center; gap:4px; margin-left:8px; }
.pager .btn{ height:28px; padding:0 8px; }
.counter{ min-width:38px; text-align:center; font-variant-numeric:tabular-nums; }
</style>
<link rel="stylesheet" href="note-link-ui.css?v=1011">
</head>
<body>
  <header>
    <div class="brand">Note Link <span class="vchip">v0.6.8 / No.12</span></div>
    <div class="pager">
      <button class="btn" id="prevPg">◀</button>
      <span class="counter" id="pgCounter">1/1</span>
      <button class="btn" id="nextPg">▶</button>
      <button class="btn" id="zoomIn">＋</button>
      <button class="btn" id="zoomOut">－</button>
    </div>
    <div class="h-actions">
      <button class="btn" id="btnPrint">印刷</button>
      <button class="btn" id="btnPng">PNG</button>
      <button class="btn" id="btnShare">共有</button>
    </div>
  </header>

  <div class="main">
    <aside class="sidebar">
      <button class="sb-toggle" id="sbToggle" title="ツールバーを畳む/戻す">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
      </button>
      <div class="tools" id="tools">
        <button class="tool active" data-tool="pen" title="ペン">
          <!-- pen -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l-7 2 2-7L16 5a2.8 2.8 0 114 4L11 18z"/><path d="M16 5l3 3"/></svg>
        </button>
        <button class="tool" data-tool="hl" title="蛍光ペン">
          <!-- highlighter -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20h8"/><path d="M3 17l9-9 4 4-9 9H3z"/></svg>
        </button>
        <button class="tool" data-tool="eraser" title="消しゴム">
          <!-- eraser -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 16l7-7 8 8-3 3H8z"/><path d="M14 6l4 4"/></svg>
        </button>
        <button class="tool" data-tool="pan" title="移動">
          <!-- hand -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 11V6a2 2 0 114 0v5"/><path d="M12 11V5a2 2 0 114 0v6"/><path d="M4 12v1a7 7 0 007 7h1a7 7 0 007-7v-2"/></svg>
        </button>
        <button class="tool" data-tool="text" title="テキスト">
          <!-- T -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M10 6v12m4-12v12"/></svg>
        </button>
        <button class="tool settings" data-tool="settings" title="設定">
          <!-- gear -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1 1.65 1.65 0 00-.33-1.82l-.06-.06A2 2 0 015.04 3.3l.06.06a1.65 1.65 0 001.82.33H7a1.65 1.65 0 001-1.51V2a2 2 0 014 0v.09c0 .67.39 1.27 1 1.51.58.24 1.24.12 1.68-.33l.06-.06a2 2 0 012.83 2.83l-.06.06c-.45.44-.57 1.1-.33 1.68.24.61.84 1 1.51 1H21a2 2 0 010 4h-.09c-.67 0-1.27.39-1.51 1z"/></svg>
        </button>
      </div>
    </aside>

    <main class="stage">
      <canvas id="cv"></canvas>

      <!-- 設定パネル（タブ式）。ツール切替で自動クローズ -->
      <div class="panel hidden" id="panel">
        <div class="ph">
          <strong>設定</strong>
          <button class="btn" id="closePanel">×</button>
        </div>
        <div class="tabs">
          <button class="tab active" data-tab="pen">ペン</button>
          <button class="tab" data-tab="hl">蛍光ペン</button>
          <button class="tab" data-tab="eraser">消しゴム</button>
        </div>
        <div id="tabBody">
          <!-- ペン -->
          <div data-pane="pen">
            <div class="row"><span>色</span><input type="color" id="penColor" value="#fffae6"></div>
            <div class="row"><span>太さ</span><input type="range" id="penSize" min="1" max="30" value="3"><span id="penSizeV">3</span></div>
            <div class="row"><span>不透明度</span><input type="range" id="penAlpha" min="0.1" max="1" step="0.05" value="1"><span id="penAlphaV">1</span></div>
            <div class="small">Shift を押しながら描くと直線（角度スナップは次版）。</div>
          </div>
          <!-- 蛍光ペン -->
          <div data-pane="hl" style="display:none">
            <div class="row"><span>色</span><input type="color" id="hlColor" value="#ffff66"></div>
            <div class="row"><span>太さ</span><input type="range" id="hlSize" min="6" max="60" value="18"><span id="hlSizeV">18</span></div>
            <div class="small">不透明度は自動で約0.35に固定します。</div>
          </div>
          <!-- 消しゴム -->
          <div data-pane="eraser" style="display:none">
            <div class="row"><span>半径</span><input type="range" id="erRadius" min="8" max="64" value="24"><span id="erRadiusV">24</span></div>
            <div class="row"><button class="btn" id="btnClearAll">全消去</button><span class="small">（ページ全体を消します）</span></div>
            <div class="small">ドラッグで「部分消去」（円）です。</div>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
/* ===== 基本要素 ===== */
const body = document.body;
const canvas = document.getElementById('cv');
const ctx = canvas.getContext('2d', { alpha:true });
let dpr = Math.max(1, window.devicePixelRatio || 1);

function resize(){
  const r = canvas.getBoundingClientRect();
  canvas.width  = Math.floor(r.width * dpr);
  canvas.height = Math.floor(r.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  redraw();
}
window.addEventListener('resize', resize);

/* ===== 状態 ===== */
const state = {
  tool:'pen',
  stroke:null,
  zoom:1,
  pen:{ color:'#fffae6', size:3, alpha:1 },
  hl:{ color:'#ffff66', size:18, alpha:0.35 },
  eraser:{ r:24 },
  bg:'#0b1220',
  drawing:false,
  last:{x:0,y:0},
  shift:false
};

function setTool(t){
  state.tool = t;
  document.querySelectorAll('.tool').forEach(b=>b.classList.toggle('active', b.dataset.tool===t));
  // 設定パネルはツール切替で自動クローズ（要望）
  hidePanel();
}
document.querySelectorAll('.tool').forEach(b=>{
  b.addEventListener('click', ()=>{
    const t = b.dataset.tool;
    if(t==='settings'){ togglePanel(); return; }
    setTool(t);
  });
});

/* 折りたたみ */
document.getElementById('sbToggle').addEventListener('click', ()=>{
  body.classList.toggle('sb-collapsed');
});

/* 設定パネル（タブ） */
const panel = document.getElementById('panel');
function showPanel(tab='pen'){
  panel.classList.remove('hidden');
  switchTab(tab);
}
function hidePanel(){ panel.classList.add('hidden'); }
function togglePanel(){ panel.classList.toggle('hidden'); if(!panel.classList.contains('hidden')) switchTab('pen'); }
document.getElementById('closePanel').onclick = hidePanel;

document.querySelectorAll('.tabs .tab').forEach(t=>{
  t.addEventListener('click', ()=> switchTab(t.dataset.tab));
});
function switchTab(id){
  document.querySelectorAll('.tabs .tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
  document.querySelectorAll('#tabBody > div').forEach(p=>p.style.display = (p.dataset.pane===id)?'block':'none');
}

/* 設定 → 値バインド */
const $ = s=>document.querySelector(s);
$('#penColor').oninput = e=> state.pen.color = e.target.value;
$('#penSize').oninput  = e=>{ state.pen.size = +e.target.value; $('#penSizeV').textContent=e.target.value; };
$('#penAlpha').oninput = e=>{ state.pen.alpha= +e.target.value; $('#penAlphaV').textContent=e.target.value; };

$('#hlColor').oninput = e=> state.hl.color = e.target.value;
$('#hlSize').oninput  = e=>{ state.hl.size = +e.target.value; $('#hlSizeV').textContent=e.target.value; };

$('#erRadius').oninput = e=>{ state.eraser.r = +e.target.value; $('#erRadiusV').textContent=e.target.value; };
$('#btnClearAll').onclick = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); redraw(); };

/* ===== 描画系 ===== */
function redraw(){
  // 背景（PNG出力でも背景込みになるよう常に塗る）
  const r = canvas.getBoundingClientRect();
  ctx.save();
  ctx.globalCompositeOperation='source-over';
  ctx.fillStyle = state.bg;
  ctx.fillRect(0,0,r.width,r.height);
  ctx.restore();
  // ここに将来：ガイドや背景画像の描画を入れる
}

resize();

/* 直線スナップ（次版詳細）。今回は Shift で完全水平/垂直だけ */
window.addEventListener('keydown', e=>{ if(e.key==='Shift') state.shift=true; });
window.addEventListener('keyup',   e=>{ if(e.key==='Shift') state.shift=false; });

function toCanvas(e){
  const rect = canvas.getBoundingClientRect();
  return { x:(e.clientX - rect.left), y:(e.clientY - rect.top) };
}

canvas.addEventListener('pointerdown', (e)=>{
  // タブレット：setPointerCapture しないと「点だけ」になる機種がある
  canvas.setPointerCapture(e.pointerId);
  const p = toCanvas(e);
  state.drawing = true;
  state.last = p;

  if(state.tool==='pen' || state.tool==='hl'){
    ctx.save();
    ctx.globalCompositeOperation='source-over';
    ctx.lineCap='round'; ctx.lineJoin='round';
    const S = (state.tool==='pen')? state.pen.size : state.hl.size;
    const A = (state.tool==='pen')? state.pen.alpha: state.hl.alpha;
    ctx.lineWidth = S;
    ctx.globalAlpha= A;
    ctx.strokeStyle = (state.tool==='pen')? state.pen.color : state.hl.color;
    ctx.beginPath(); ctx.moveTo(p.x, p.y);
  }else if(state.tool==='eraser'){
    ctx.save();
    ctx.globalCompositeOperation='destination-out';
    ctx.lineCap='round'; ctx.lineJoin='round';
    ctx.lineWidth = state.eraser.r*2;
    ctx.beginPath(); ctx.moveTo(p.x, p.y);
  }else if(state.tool==='pan'){
    // いまは未実装（次版）。誤作動防止で描かない
  }
});

canvas.addEventListener('pointermove', (e)=>{
  if(!state.drawing) return;
  const p = toCanvas(e);
  let x = p.x, y = p.y;
  if(state.shift){
    // 水平/垂直スナップ（簡易）
    const dx = Math.abs(p.x - state.last.x), dy = Math.abs(p.y - state.last.y);
    if(dx > dy){ y = state.last.y; } else { x = state.last.x; }
  }
  ctx.lineTo(x,y);
  ctx.stroke();
  state.last = {x,y};
});

function endStroke(){
  if(!state.drawing) return;
  state.drawing = false;
  ctx.closePath();
  ctx.restore();
}
canvas.addEventListener('pointerup', endStroke);
canvas.addEventListener('pointercancel', endStroke);
canvas.addEventListener('pointerleave', endStroke);

/* ===== 共有系 ===== */
document.getElementById('btnPrint').onclick = ()=> window.print();

document.getElementById('btnPng').onclick = async ()=>{
  // 背景込み → すでに redraw が塗っているので toDataURL でOK
  // 高解像度で欲しいときは将来scale出力を用意
  const url = canvas.toDataURL('image/png');
  const a = document.createElement('a');
  a.href = url; a.download = 'note-page.png'; a.click();
};

document.getElementById('btnShare').onclick = async ()=>{
  try{
    const blob = await new Promise(res=> canvas.toBlob(res, 'image/png'));
    if(navigator.canShare && navigator.canShare({ files:[new File([blob],'note.png',{type:'image/png'})] })){
      await navigator.share({ files:[new File([blob],'note.png',{type:'image/png'})], title:'Note Link', text:'共有します' });
    }else if(navigator.clipboard && 'write' in navigator.clipboard){
      await navigator.clipboard.write([ new ClipboardItem({ 'image/png': blob }) ]);
      alert('画像をクリップボードにコピーしました');
    }else{
      const url = URL.createObjectURL(blob);
      alert('このURLを共有してください\n' + url);
    }
  }catch(err){
    console.error(err);
    alert('共有に失敗しました');
  }
};

/* ツールバーの「設定」ボタンは押すたびトグル。別ツール選択時は自動クローズ（上で実装） */
</script>
  <script>
(function(){
  const wrap = document.getElementById('wrap');
  const sidebar = document.getElementById('sidebar');

  // 折畳みボタンが無ければ作る
  let btnCollapse = document.getElementById('btnCollapse');
  if(!btnCollapse && sidebar){
    btnCollapse = document.createElement('button');
    btnCollapse.id = 'btnCollapse'; btnCollapse.className = 'tool'; btnCollapse.title = '開閉';
    btnCollapse.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>';
    sidebar.insertBefore(btnCollapse, sidebar.firstChild);
  }
  btnCollapse?.addEventListener('click', ()=> wrap?.classList.toggle('collapsed'));

  // ツールのアクティブ強調 & 設定パネル自動クローズ
  const ids = ['toolPen','toolHighlighter','toolEraser','toolPan','toolGuide','toolText','toolBg'];
  const buttons = ids.map(id => document.getElementById(id)).filter(Boolean);
  const btnSettings = document.getElementById('toolSettings');

  function setActiveById(id){
    buttons.concat(btnSettings||[]).forEach(b=> b && b.classList.remove('active'));
    const el = document.getElementById(id);
    if(el) el.classList.add('active');
  }

  const origSetTool = (typeof window.setTool === 'function') ? window.setTool : null;
  window.setTool = function(tool){
    if(origSetTool) origSetTool(tool);
    const id = 'tool' + tool.charAt(0).toUpperCase() + tool.slice(1);
    setActiveById(id);
    const panel = document.getElementById('flyout') || document.getElementById('settingsPanel');
    if(panel) panel.classList.add('hidden'); // ツール切替時は閉じる
  };

  buttons.forEach(btn=>{
    const t = btn.id.replace(/^tool/,'').toLowerCase();
    btn.addEventListener('click', ()=> window.setTool(t));
  });

  // 初期アクティブはペン
  setActiveById('toolPen');
})();
</script>
</body>
</html>

